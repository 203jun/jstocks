{% extends 'stocks/base.html' %}

{% block title %}설정 - JStocks{% endblock %}

{% block content %}
<h4 class="mb-3">설정</h4>

<!-- 탭 네비게이션 -->
<ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="theme-tab" data-bs-toggle="tab" data-bs-target="#theme-panel" type="button" role="tab">업종</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="sector-tab" data-bs-toggle="tab" data-bs-target="#sector-panel" type="button" role="tab">섹터</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="youtube-tab" data-bs-toggle="tab" data-bs-target="#youtube-panel" type="button" role="tab">유튜브</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="prompt-tab" data-bs-toggle="tab" data-bs-target="#prompt-panel" type="button" role="tab">프롬프트</button>
    </li>
</ul>

<!-- 탭 콘텐츠 -->
<div class="tab-content">
    <!-- 업종 탭 -->
    <div class="tab-pane fade show active" id="theme-panel" role="tabpanel">
        <!-- 업종 관리 (2단계) -->
        <div class="card">
    <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <strong>업종 관리</strong>
        <div>
            <button type="button" class="btn btn-sm btn-outline-primary" id="btnAddCategory">대분류 추가</button>
            <button type="button" class="btn btn-sm btn-primary" id="btnAddTheme">소분류 추가</button>
        </div>
    </div>
    <div class="card-body p-0">
        <!-- 대분류 추가 폼 -->
        <div id="categoryAddForm" class="border-bottom p-3 d-none bg-light">
            <div class="row g-2 align-items-end">
                <div class="col-md-8">
                    <label class="form-label small fw-bold">대분류 추가 (최대 20자)</label>
                    <input type="text" class="form-control form-control-sm" id="categoryAddName" placeholder="건설/플랜트, 바이오/제약 등" maxlength="20">
                </div>
                <div class="col-md-4">
                    <button type="button" id="btnSaveCategory" class="btn btn-sm btn-outline-primary w-100">저장</button>
                </div>
            </div>
        </div>

        <!-- 소분류 추가 폼 -->
        <div id="themeAddForm" class="border-bottom p-3 d-none bg-light">
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label class="form-label small fw-bold">대분류 선택</label>
                    <select class="form-select form-select-sm" id="themeAddCategory">
                        <option value="">대분류 선택</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-5">
                    <label class="form-label small fw-bold">소분류명 (최대 20자)</label>
                    <input type="text" class="form-control form-control-sm" id="themeAddName" placeholder="도시정비/원전/SMR 등" maxlength="20">
                </div>
                <div class="col-md-3">
                    <button type="button" id="btnSaveTheme" class="btn btn-sm btn-primary w-100">저장</button>
                </div>
            </div>
        </div>

        <!-- 업종 목록 (아코디언) -->
        <div class="accordion accordion-flush" id="themeAccordion">
            {% for category in categories %}
            <div class="accordion-item" data-category-id="{{ category.id }}">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ category.id }}">
                        <strong>{{ category.name }}</strong>
                        <span class="badge bg-secondary ms-2">{{ category.themes.count }}</span>
                    </button>
                </h2>
                <div id="collapse{{ category.id }}" class="accordion-collapse collapse" data-bs-parent="#themeAccordion">
                    <div class="accordion-body py-2 px-3">
                        <div class="d-flex flex-wrap gap-2 mb-2 theme-list" data-category-id="{{ category.id }}">
                            {% for theme in category.themes.all %}
                            <span class="badge bg-light text-dark border d-flex align-items-center" data-theme-id="{{ theme.id }}">
                                {{ theme.name }}
                                <button type="button" class="btn-close btn-close-sm ms-1 btn-delete-theme" data-id="{{ theme.id }}" data-name="{{ theme.name }}" style="font-size: 0.6rem;"></button>
                            </span>
                            {% empty %}
                            <span class="text-muted small theme-empty">소분류가 없습니다.</span>
                            {% endfor %}
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-sm btn-outline-danger btn-delete-category" data-id="{{ category.id }}" data-name="{{ category.name }}">대분류 삭제</button>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center text-muted py-4" id="emptyMessage">
                등록된 업종이 없습니다. 대분류를 먼저 추가하세요.
            </div>
            {% endfor %}
        </div>
    </div>
</div>

        <div class="mt-3 small text-muted">
            <strong>사용법:</strong> 대분류(건설/플랜트, 바이오/제약 등)를 먼저 추가한 후, 소분류(도시정비/원전, P-CAB/GLP-1 등)를 추가하세요.
        </div>
    </div>

    <!-- 섹터 탭 -->
    <div class="tab-pane fade" id="sector-panel" role="tabpanel">
        <div class="card">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <strong>섹터 관리</strong>
                <span class="badge bg-secondary">{{ custom_sectors|length }}개</span>
            </div>
            <div class="card-body">
                <!-- 섹터 추가 폼 -->
                <div class="row g-2 mb-3">
                    <div class="col">
                        <input type="text" class="form-control form-control-sm" id="customSectorName" placeholder="섹터명 입력 (예: 화장품, 2차전지)" maxlength="50">
                    </div>
                    <div class="col-auto">
                        <button type="button" class="btn btn-sm btn-primary" id="btnAddCustomSector">추가</button>
                    </div>
                </div>

                <!-- 섹터 목록 -->
                <div id="customSectorList" class="d-flex flex-wrap gap-2">
                    {% for sector in custom_sectors %}
                    <span class="badge bg-light text-dark border d-flex align-items-center" data-id="{{ sector.id }}">
                        {{ sector.name }}
                        <button type="button" class="btn-close btn-close-sm ms-1 btn-delete-custom-sector" data-id="{{ sector.id }}" data-name="{{ sector.name }}" style="font-size: 0.6rem;"></button>
                    </span>
                    {% empty %}
                    <span class="text-muted small" id="noSectorMsg">등록된 섹터가 없습니다.</span>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="mt-3 small text-muted">
            <strong>사용법:</strong> 섹터를 추가하면 '섹터' 페이지 하단에 표시됩니다.
        </div>
    </div>

    <!-- 유튜브 탭 -->
    <div class="tab-pane fade" id="youtube-panel" role="tabpanel">
        <!-- 제외 채널 -->
        <div class="card mb-3">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <strong>제외 채널 목록</strong>
                <span class="badge bg-secondary">{{ excluded_channels|length }}개</span>
            </div>
            <div class="card-body">
                <!-- 채널 추가 폼 -->
                <div class="row g-2 mb-3">
                    <div class="col">
                        <input type="text" class="form-control form-control-sm" id="excludeChannelName" placeholder="제외할 채널명 입력">
                    </div>
                    <div class="col-auto">
                        <button type="button" class="btn btn-sm btn-danger" id="btnAddExcludeChannel">추가</button>
                    </div>
                </div>

                <!-- 채널 목록 -->
                <div id="excludeChannelList" class="d-flex flex-wrap gap-2">
                    {% for channel in excluded_channels %}
                    <span class="badge bg-light text-dark border d-flex align-items-center" data-id="{{ channel.id }}">
                        {{ channel.name }}
                        <button type="button" class="btn-close btn-close-sm ms-1 btn-delete-channel" data-id="{{ channel.id }}" style="font-size: 0.6rem;"></button>
                    </span>
                    {% empty %}
                    <span class="text-muted small" id="noChannelMsg">등록된 제외 채널이 없습니다.</span>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- 선호 채널 -->
        <div class="card">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <strong>선호 채널 목록</strong>
                <span class="badge bg-primary">{{ preferred_channels|length }}개</span>
            </div>
            <div class="card-body">
                <!-- 채널 추가 폼 -->
                <div class="row g-2 mb-3">
                    <div class="col">
                        <input type="text" class="form-control form-control-sm" id="preferredChannelName" placeholder="선호할 채널명 입력">
                    </div>
                    <div class="col-auto">
                        <button type="button" class="btn btn-sm btn-primary" id="btnAddPreferredChannel">추가</button>
                    </div>
                </div>

                <!-- 채널 목록 -->
                <div id="preferredChannelList" class="d-flex flex-wrap gap-2">
                    {% for channel in preferred_channels %}
                    <span class="badge bg-primary-subtle text-dark border d-flex align-items-center" data-id="{{ channel.id }}">
                        {{ channel.name }}
                        <button type="button" class="btn-close btn-close-sm ms-1 btn-delete-preferred" data-id="{{ channel.id }}" style="font-size: 0.6rem;"></button>
                    </span>
                    {% empty %}
                    <span class="text-muted small" id="noPreferredMsg">등록된 선호 채널이 없습니다.</span>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="mt-3 small text-muted">
            <strong>사용법:</strong><br>
            - <strong>제외 채널:</strong> 일반 검색에서 제외할 채널명을 등록하세요.<br>
            - <strong>선호 채널:</strong> 선호 모드로 검색 시, 등록된 채널에서만 검색합니다. 채널명은 정확히 일치해야 합니다.
        </div>
    </div>

    <!-- 프롬프트 탭 -->
    <div class="tab-pane fade" id="prompt-panel" role="tabpanel">
        <!-- 프롬프트 하위 탭 -->
        <ul class="nav nav-pills mb-3" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="stock-classify-tab" data-bs-toggle="pill" data-bs-target="#stock-classify-panel" type="button" role="tab">종목분류</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="stock-analysis-tab" data-bs-toggle="pill" data-bs-target="#stock-analysis-panel" type="button" role="tab">기업분석</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="stock-summary-tab" data-bs-toggle="pill" data-bs-target="#stock-summary-panel" type="button" role="tab">투자포인트</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="nodaji-tab" data-bs-toggle="pill" data-bs-target="#nodaji-panel" type="button" role="tab">노다지</button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- 종목분류 탭 -->
            <div class="tab-pane fade show active" id="stock-classify-panel" role="tabpanel">
                <!-- 프롬프트 영역 -->
                <div class="card mb-3">
                    <div class="card-header py-2 d-flex justify-content-between align-items-center">
                        <strong>프롬프트</strong>
                        <button type="button" class="btn btn-sm btn-primary" id="btnSaveClassifyPrompt">저장</button>
                    </div>
                    <div class="card-body py-2">
                        <textarea class="form-control" id="stockClassifyPrompt" rows="6" placeholder="종목분류 시 사용할 프롬프트를 입력하세요...">{{ saved_prompts.prompt_classify }}</textarea>
                        <small class="text-muted">AI에게 전달할 기본 프롬프트입니다. 수정 후 저장하세요.</small>
                    </div>
                </div>

                <!-- 종목 분류 현황 -->
                <div class="card mb-3">
                    <div class="card-header py-2 d-flex justify-content-between align-items-center">
                        <strong>종목 분류 현황</strong>
                        <span class="badge bg-secondary">{{ stock_classify_lines_count }}개</span>
                    </div>
                    <div class="card-body py-2">
                        <textarea class="form-control bg-light" id="stockClassifyList" rows="8" readonly>{{ stock_classify_text }}</textarea>
                        <small class="text-muted">DB에서 자동 생성됩니다. (종목명 | 대분류 | 소분류)</small>
                    </div>
                </div>

                <!-- 전체 복사 버튼 -->
                <div class="d-grid">
                    <button type="button" class="btn btn-outline-primary" id="btnCopyAll">
                        전체 복사 (종목 리스트 + 프롬프트)
                    </button>
                </div>
            </div>

            <!-- 기업분석 탭 -->
            <div class="tab-pane fade" id="stock-analysis-panel" role="tabpanel">
                <!-- 주의사항 -->
                <div class="alert alert-warning py-2 mb-3">
                    <strong>⚠️ 주의:</strong> STEP 2에서 웹페이지를 만들면 STEP 1 리포트 원본이 사라집니다. 반드시 STEP 1(HTML 저장)을 먼저 완료하세요!
                </div>

                <!-- STEP 1: 리포트 만들기 -->
                <div class="card mb-3">
                    <div class="card-header py-2">
                        <span class="badge bg-primary me-2">STEP 1</span>
                        <strong>리포트 만들기</strong>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-secondary py-2 mb-3">
                            <small>
                                <strong>도구:</strong> Gemini Deep Research + 사고모드<br>
                                <strong>소요:</strong> 10~30분<br>
                                <strong>저장:</strong> 종목 편집 → 기업분석 → <code>리포트</code> 탭
                            </small>
                        </div>

                        <!-- 프롬프트 1: 리포트 생성 -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="form-label fw-bold small mb-0">1-1. 리포트 생성 프롬프트</label>
                                <button type="button" class="btn btn-sm btn-primary" id="btnSaveAnalysisPrompt">저장</button>
                            </div>
                            <textarea class="form-control" id="promptAnalysis" rows="8" placeholder="Deep Research용 프롬프트...">{{ saved_prompts.prompt_analysis }}</textarea>
                            <small class="text-muted">Deep Research에 입력할 프롬프트</small>
                        </div>

                        <!-- 프롬프트 2: HTML 파일 만들기 -->
                        <div>
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="form-label fw-bold small mb-0">1-2. HTML 변환 프롬프트</label>
                                <button type="button" class="btn btn-sm btn-primary" id="btnSaveAnalysisHtmlPrompt">저장</button>
                            </div>
                            <textarea class="form-control" id="promptAnalysisHtml" rows="8" placeholder="HTML 변환용 프롬프트...">{{ saved_prompts.prompt_analysis_html }}</textarea>
                            <small class="text-muted">리포트 결과를 HTML 파일로 변환하는 프롬프트</small>
                            <div class="alert alert-warning py-2 mt-2 mb-0">
                                <small>
                                    <strong>⚠️ 생성 실패 시:</strong> 가끔 HTML을 만들지 못하는 경우가 있습니다.<br>
                                    → 일반 프롬프트로 이동 후 아래 프롬프트 실행:<br>
                                    <code class="d-block mt-1 p-2 bg-light">{deep research가 뽑아준 결과 복사(컨텐츠 복사가 아니라 마우스 드래그로 복사)}<br>---<br>html 형태로 정리해줘.</code>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STEP 2: 요약 만들기 -->
                <div class="card">
                    <div class="card-header py-2">
                        <span class="badge bg-success me-2">STEP 2</span>
                        <strong>요약 만들기</strong>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info py-2 mb-0">
                            <small>
                                <strong>방법:</strong> Gemini 리포트 결과에서 <code>웹페이지 만들기</code> 클릭<br>
                                <strong>저장:</strong> 생성된 HTML → 종목 편집 → 기업분석 → <code>요약</code> 탭
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 투자포인트 탭 -->
            <div class="tab-pane fade" id="stock-summary-panel" role="tabpanel">
                <!-- 주의사항 -->
                <div class="alert alert-warning py-2 mb-3">
                    <strong>⚠️ 주의:</strong> STEP 2에서 웹페이지를 만들면 STEP 1 리포트 원본이 사라집니다. 반드시 STEP 1(HTML 저장)을 먼저 완료하세요!
                </div>

                <!-- STEP 1: 리포트 만들기 -->
                <div class="card mb-3">
                    <div class="card-header py-2">
                        <span class="badge bg-primary me-2">STEP 1</span>
                        <strong>리포트 만들기</strong>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-secondary py-2 mb-3">
                            <small>
                                <strong>도구:</strong> Gemini Deep Research + 사고모드<br>
                                <strong>소요:</strong> 10~30분<br>
                                <strong>저장:</strong> 종목 편집 → 인사이트 → <code>리포트</code> 탭
                            </small>
                        </div>

                        <!-- 종목 데이터 조회 버튼 -->
                        <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#stockDataModal">
                                종목 데이터 조회
                            </button>
                            <small class="text-muted ms-2">프롬프트에 종목 데이터를 함께 사용하세요.</small>
                        </div>

                        <!-- 프롬프트 1: 리포트 생성 -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="form-label fw-bold small mb-0">1-1. 리포트 생성 프롬프트</label>
                                <button type="button" class="btn btn-sm btn-primary" id="btnSaveSummaryPrompt">저장</button>
                            </div>
                            <textarea class="form-control" id="promptSummary" rows="8" placeholder="Deep Research용 프롬프트...">{{ saved_prompts.prompt_summary }}</textarea>
                            <small class="text-muted">Deep Research에 입력할 프롬프트</small>
                        </div>

                        <!-- 프롬프트 2: HTML 파일 만들기 -->
                        <div>
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="form-label fw-bold small mb-0">1-2. HTML 변환 프롬프트</label>
                                <button type="button" class="btn btn-sm btn-primary" id="btnSaveSummaryHtmlPrompt">저장</button>
                            </div>
                            <textarea class="form-control" id="promptSummaryHtml" rows="8" placeholder="HTML 변환용 프롬프트...">{{ saved_prompts.prompt_summary_html }}</textarea>
                            <small class="text-muted">리포트 결과를 HTML 파일로 변환하는 프롬프트</small>
                            <div class="alert alert-warning py-2 mt-2 mb-0">
                                <small>
                                    <strong>⚠️ 생성 실패 시:</strong> 가끔 HTML을 만들지 못하는 경우가 있습니다.<br>
                                    → 일반 프롬프트로 이동 후 아래 프롬프트 실행:<br>
                                    <code class="d-block mt-1 p-2 bg-light">{deep research가 뽑아준 결과 복사(컨텐츠 복사가 아니라 마우스 드래그로 복사)}<br>---<br>html 형태로 정리해줘.</code>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STEP 2: 요약 만들기 -->
                <div class="card">
                    <div class="card-header py-2">
                        <span class="badge bg-success me-2">STEP 2</span>
                        <strong>요약 만들기</strong>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info py-2 mb-0">
                            <small>
                                <strong>방법:</strong> Gemini 리포트 결과에서 <code>웹페이지 만들기</code> 클릭<br>
                                <strong>저장:</strong> 생성된 HTML → 종목 편집 → 인사이트 → <code>요약</code> 탭
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 노다지 탭 -->
            <div class="tab-pane fade" id="nodaji-panel" role="tabpanel">
                <!-- STEP 1: 리포트 만들기 -->
                <div class="card">
                    <div class="card-header py-2">
                        <span class="badge bg-primary me-2">STEP 1</span>
                        <strong>리포트 만들기</strong>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-secondary py-2 mb-3">
                            <small>
                                <strong>도구:</strong> Gemini Deep Research + 사고모드<br>
                                <strong>소요:</strong> 10~30분<br>
                                <strong>저장:</strong> 노다지 편집 → <code>요약</code> 탭
                            </small>
                        </div>
                        <div class="alert alert-danger py-2 mb-3">
                            <strong>⚠️ 중요:</strong> 반드시 <strong>노다지 PDF 파일</strong>을 첨부하여 사용하세요!
                        </div>

                        <!-- 프롬프트 1: 리포트 생성 -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="form-label fw-bold small mb-0">1-1. 리포트 생성 프롬프트</label>
                                <button type="button" class="btn btn-sm btn-primary" id="btnSaveNodajiPrompt">저장</button>
                            </div>
                            <textarea class="form-control" id="promptNodaji" rows="8" placeholder="Deep Research용 프롬프트...">{{ saved_prompts.prompt_nodaji }}</textarea>
                            <small class="text-muted">Deep Research에 입력할 프롬프트 (PDF 첨부 필수)</small>
                        </div>

                        <!-- 프롬프트 2: HTML 파일 만들기 -->
                        <div>
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="form-label fw-bold small mb-0">1-2. HTML 변환 프롬프트</label>
                                <button type="button" class="btn btn-sm btn-primary" id="btnSaveNodajiHtmlPrompt">저장</button>
                            </div>
                            <textarea class="form-control" id="promptNodajiHtml" rows="8" placeholder="HTML 변환용 프롬프트...">{{ saved_prompts.prompt_nodaji_html }}</textarea>
                            <small class="text-muted">리포트 결과를 HTML 파일로 변환하는 프롬프트</small>
                            <div class="alert alert-warning py-2 mt-2 mb-0">
                                <small>
                                    <strong>⚠️ 생성 실패 시:</strong> 가끔 HTML을 만들지 못하는 경우가 있습니다.<br>
                                    → 일반 프롬프트로 이동 후 아래 프롬프트 실행:<br>
                                    <code class="d-block mt-1 p-2 bg-light">{deep research가 뽑아준 결과 복사(컨텐츠 복사가 아니라 마우스 드래그로 복사)}<br>---<br>html 형태로 정리해줘.</code>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 종목 데이터 조회 모달 -->
<div class="modal fade" id="stockDataModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title">종목 데이터 조회</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 종목 검색 -->
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="stockSearchInput" placeholder="종목명 또는 코드 검색...">
                        <button type="button" class="btn btn-outline-primary" id="btnStockSearch">검색</button>
                    </div>
                    <div id="stockSearchResults" class="list-group mt-2 d-none" style="max-height: 200px; overflow-y: auto;"></div>
                </div>

                <!-- 선택된 종목 정보 -->
                <div id="selectedStockInfo" class="d-none">
                    <div class="alert alert-info py-2 mb-3">
                        <strong id="selectedStockName"></strong>
                        <span class="text-muted ms-2" id="selectedStockCode"></span>
                    </div>

                    <!-- 데이터 로딩 -->
                    <div id="stockDataLoading" class="text-center py-4 d-none">
                        <div class="spinner-border text-primary"></div>
                        <p class="mt-2 mb-0">데이터 불러오는 중...</p>
                    </div>

                    <!-- 데이터 결과 -->
                    <div id="stockDataResult" class="d-none">
                        <!-- 복사 버튼 -->
                        <div class="d-flex justify-content-end mb-2">
                            <button type="button" class="btn btn-sm btn-success" id="btnCopyStockData">
                                전체 복사
                            </button>
                        </div>

                        <!-- 데이터 내용 -->
                        <div id="stockDataContent" class="border rounded p-3 bg-light" style="max-height: 400px; overflow-y: auto; font-size: 0.85rem; white-space: pre-wrap; font-family: monospace;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// === 대분류 관리 ===
const btnAddCategory = document.getElementById('btnAddCategory');
const categoryAddForm = document.getElementById('categoryAddForm');
const categoryAddName = document.getElementById('categoryAddName');
const btnSaveCategory = document.getElementById('btnSaveCategory');

btnAddCategory.addEventListener('click', () => {
    categoryAddForm.classList.toggle('d-none');
    themeAddForm.classList.add('d-none');
    if (!categoryAddForm.classList.contains('d-none')) {
        categoryAddName.focus();
    }
});

btnSaveCategory.addEventListener('click', async () => {
    const name = categoryAddName.value.trim();
    if (!name) {
        alert('대분류명을 입력해주세요.');
        return;
    }

    btnSaveCategory.disabled = true;

    try {
        const formData = new FormData();
        formData.append('name', name);

        const response = await fetch('/api/category/add/', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': getCsrfToken() }
        });

        const data = await response.json();

        if (data.success) {
            // 페이지 새로고침 (아코디언 구조 복잡)
            location.reload();
        } else {
            alert(data.error || '저장에 실패했습니다.');
        }
    } catch (err) {
        alert('오류: ' + err.message);
    } finally {
        btnSaveCategory.disabled = false;
    }
});

categoryAddName.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') btnSaveCategory.click();
});

// 대분류 삭제
document.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('btn-delete-category')) return;

    const categoryId = e.target.dataset.id;
    const categoryName = e.target.dataset.name;

    if (!confirm(`"${categoryName}" 대분류와 모든 소분류를 삭제하시겠습니까?`)) return;

    e.target.disabled = true;

    try {
        const response = await fetch(`/api/category/${categoryId}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCsrfToken() }
        });

        const data = await response.json();

        if (data.success) {
            location.reload();
        } else {
            alert(data.error || '삭제에 실패했습니다.');
            e.target.disabled = false;
        }
    } catch (err) {
        alert('오류: ' + err.message);
        e.target.disabled = false;
    }
});

// === 소분류 관리 ===
const btnAddTheme = document.getElementById('btnAddTheme');
const themeAddForm = document.getElementById('themeAddForm');
const themeAddCategory = document.getElementById('themeAddCategory');
const themeAddName = document.getElementById('themeAddName');
const btnSaveTheme = document.getElementById('btnSaveTheme');

btnAddTheme.addEventListener('click', () => {
    themeAddForm.classList.toggle('d-none');
    categoryAddForm.classList.add('d-none');
    if (!themeAddForm.classList.contains('d-none')) {
        themeAddCategory.focus();
    }
});

btnSaveTheme.addEventListener('click', async () => {
    const categoryId = themeAddCategory.value;
    const name = themeAddName.value.trim();

    if (!categoryId) {
        alert('대분류를 선택해주세요.');
        return;
    }
    if (!name) {
        alert('소분류명을 입력해주세요.');
        return;
    }

    btnSaveTheme.disabled = true;

    try {
        const formData = new FormData();
        formData.append('category_id', categoryId);
        formData.append('name', name);

        const response = await fetch('/api/theme/add/', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': getCsrfToken() }
        });

        const data = await response.json();

        if (data.success) {
            // 해당 대분류의 소분류 목록에 추가
            const themeList = document.querySelector(`.theme-list[data-category-id="${categoryId}"]`);
            if (themeList) {
                // 빈 메시지 제거
                const emptyMsg = themeList.querySelector('.theme-empty');
                if (emptyMsg) emptyMsg.remove();

                // 새 뱃지 추가
                const badge = document.createElement('span');
                badge.className = 'badge bg-light text-dark border d-flex align-items-center';
                badge.dataset.themeId = data.id;
                badge.innerHTML = `
                    ${escapeHtml(data.name)}
                    <button type="button" class="btn-close btn-close-sm ms-1 btn-delete-theme" data-id="${data.id}" data-name="${escapeHtml(data.name)}" style="font-size: 0.6rem;"></button>
                `;
                themeList.appendChild(badge);

                // 카운트 업데이트
                const accordion = document.querySelector(`.accordion-item[data-category-id="${categoryId}"]`);
                if (accordion) {
                    const countBadge = accordion.querySelector('.badge');
                    if (countBadge) {
                        countBadge.textContent = parseInt(countBadge.textContent) + 1;
                    }
                }
            }

            themeAddName.value = '';
            themeAddName.focus();
        } else {
            alert(data.error || '저장에 실패했습니다.');
        }
    } catch (err) {
        alert('오류: ' + err.message);
    } finally {
        btnSaveTheme.disabled = false;
    }
});

themeAddName.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') btnSaveTheme.click();
});

// 소분류 삭제
document.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('btn-delete-theme')) return;

    const themeId = e.target.dataset.id;
    const themeName = e.target.dataset.name;

    if (!confirm(`"${themeName}" 소분류를 삭제하시겠습니까?`)) return;

    e.target.disabled = true;

    try {
        const response = await fetch(`/api/theme/${themeId}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCsrfToken() }
        });

        const data = await response.json();

        if (data.success) {
            const badge = e.target.closest('[data-theme-id]');
            const themeList = badge.closest('.theme-list');
            const categoryId = themeList.dataset.categoryId;

            badge.remove();

            // 카운트 업데이트
            const accordion = document.querySelector(`.accordion-item[data-category-id="${categoryId}"]`);
            if (accordion) {
                const countBadge = accordion.querySelector('.badge');
                if (countBadge) {
                    const newCount = parseInt(countBadge.textContent) - 1;
                    countBadge.textContent = newCount;

                    // 0개면 빈 메시지 표시
                    if (newCount === 0) {
                        themeList.innerHTML = '<span class="text-muted small theme-empty">소분류가 없습니다.</span>';
                    }
                }
            }
        } else {
            alert(data.error || '삭제에 실패했습니다.');
            e.target.disabled = false;
        }
    } catch (err) {
        alert('오류: ' + err.message);
        e.target.disabled = false;
    }
});

// 공통 함수
function getCsrfToken() {
    const name = 'csrftoken';
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [key, value] = cookie.trim().split('=');
        if (key === name) return value;
    }
    return '';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}


// === 유튜브 제외 채널 관리 ===
const excludeChannelName = document.getElementById('excludeChannelName');
const btnAddExcludeChannel = document.getElementById('btnAddExcludeChannel');
const excludeChannelList = document.getElementById('excludeChannelList');

btnAddExcludeChannel.addEventListener('click', async () => {
    const name = excludeChannelName.value.trim();
    if (!name) {
        alert('채널명을 입력해주세요.');
        return;
    }

    btnAddExcludeChannel.disabled = true;

    try {
        const formData = new FormData();
        formData.append('name', name);

        const response = await fetch('/api/youtube/channel/add/', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': getCsrfToken() }
        });

        const data = await response.json();

        if (data.success) {
            // 빈 메시지 제거
            const noMsg = document.getElementById('noChannelMsg');
            if (noMsg) noMsg.remove();

            // 새 뱃지 추가
            const badge = document.createElement('span');
            badge.className = 'badge bg-light text-dark border d-flex align-items-center';
            badge.dataset.id = data.id;
            badge.innerHTML = `
                ${escapeHtml(data.name)}
                <button type="button" class="btn-close btn-close-sm ms-1 btn-delete-channel" data-id="${data.id}" style="font-size: 0.6rem;"></button>
            `;
            excludeChannelList.appendChild(badge);

            excludeChannelName.value = '';
            excludeChannelName.focus();
        } else {
            alert(data.error || '저장에 실패했습니다.');
        }
    } catch (err) {
        alert('오류: ' + err.message);
    } finally {
        btnAddExcludeChannel.disabled = false;
    }
});

excludeChannelName.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') btnAddExcludeChannel.click();
});

// 채널 삭제
document.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('btn-delete-channel')) return;

    const channelId = e.target.dataset.id;
    e.target.disabled = true;

    try {
        const response = await fetch(`/api/youtube/channel/${channelId}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCsrfToken() }
        });

        const data = await response.json();

        if (data.success) {
            const badge = e.target.closest('[data-id]');
            badge.remove();

            // 목록이 비었으면 메시지 표시
            if (excludeChannelList.children.length === 0) {
                excludeChannelList.innerHTML = '<span class="text-muted small" id="noChannelMsg">등록된 제외 채널이 없습니다.</span>';
            }
        } else {
            alert(data.error || '삭제에 실패했습니다.');
            e.target.disabled = false;
        }
    } catch (err) {
        alert('오류: ' + err.message);
        e.target.disabled = false;
    }
});

// === 유튜브 선호 채널 관리 ===
const preferredChannelName = document.getElementById('preferredChannelName');
const btnAddPreferredChannel = document.getElementById('btnAddPreferredChannel');
const preferredChannelList = document.getElementById('preferredChannelList');

btnAddPreferredChannel.addEventListener('click', async () => {
    const name = preferredChannelName.value.trim();
    if (!name) {
        alert('채널명을 입력해주세요.');
        return;
    }

    btnAddPreferredChannel.disabled = true;

    try {
        const formData = new FormData();
        formData.append('name', name);

        const response = await fetch('/api/youtube/preferred/add/', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': getCsrfToken() }
        });

        const data = await response.json();

        if (data.success) {
            // 빈 메시지 제거
            const noMsg = document.getElementById('noPreferredMsg');
            if (noMsg) noMsg.remove();

            // 새 뱃지 추가
            const badge = document.createElement('span');
            badge.className = 'badge bg-primary-subtle text-dark border d-flex align-items-center';
            badge.dataset.id = data.id;
            badge.innerHTML = `
                ${escapeHtml(data.name)}
                <button type="button" class="btn-close btn-close-sm ms-1 btn-delete-preferred" data-id="${data.id}" style="font-size: 0.6rem;"></button>
            `;
            preferredChannelList.appendChild(badge);

            preferredChannelName.value = '';
            preferredChannelName.focus();
        } else {
            alert(data.error || '저장에 실패했습니다.');
        }
    } catch (err) {
        alert('오류: ' + err.message);
    } finally {
        btnAddPreferredChannel.disabled = false;
    }
});

preferredChannelName.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') btnAddPreferredChannel.click();
});

// 선호 채널 삭제
document.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('btn-delete-preferred')) return;

    const channelId = e.target.dataset.id;
    e.target.disabled = true;

    try {
        const response = await fetch(`/api/youtube/preferred/${channelId}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCsrfToken() }
        });

        const data = await response.json();

        if (data.success) {
            const badge = e.target.closest('[data-id]');
            badge.remove();

            // 목록이 비었으면 메시지 표시
            if (preferredChannelList.children.length === 0) {
                preferredChannelList.innerHTML = '<span class="text-muted small" id="noPreferredMsg">등록된 선호 채널이 없습니다.</span>';
            }
        } else {
            alert(data.error || '삭제에 실패했습니다.');
            e.target.disabled = false;
        }
    } catch (err) {
        alert('오류: ' + err.message);
        e.target.disabled = false;
    }
});

// === 프롬프트 저장 ===
async function savePrompt(key, value, button) {
    button.disabled = true;
    const originalText = button.textContent;
    button.textContent = '저장 중...';

    try {
        const formData = new FormData();
        formData.append('key', key);
        formData.append('value', value);

        const response = await fetch('/api/setting/save/', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': getCsrfToken() }
        });

        const data = await response.json();

        if (data.success) {
            button.textContent = '저장됨';
            setTimeout(() => {
                button.textContent = originalText;
            }, 1500);
        } else {
            alert(data.error || '저장에 실패했습니다.');
            button.textContent = originalText;
        }
    } catch (err) {
        alert('오류: ' + err.message);
        button.textContent = originalText;
    } finally {
        button.disabled = false;
    }
}

// 종목분류 프롬프트 저장
document.getElementById('btnSaveClassifyPrompt').addEventListener('click', function() {
    const value = document.getElementById('stockClassifyPrompt').value;
    savePrompt('prompt_classify', value, this);
});

// 클립보드 복사 함수 (HTTPS/HTTP 모두 지원)
function copyToClipboard(text) {
    // 1. navigator.clipboard 사용 시도 (HTTPS 환경)
    if (navigator.clipboard && navigator.clipboard.writeText) {
        return navigator.clipboard.writeText(text);
    }

    // 2. fallback: execCommand 사용 (HTTP 환경)
    return new Promise((resolve, reject) => {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            resolve();
        } catch (err) {
            reject(err);
        } finally {
            document.body.removeChild(textarea);
        }
    });
}

// 전체 복사 (종목 리스트 + 프롬프트)
document.getElementById('btnCopyAll').addEventListener('click', async function() {
    const prompt = document.getElementById('stockClassifyPrompt').value;
    const list = document.getElementById('stockClassifyList').value;
    const combined = list + '\n\n' + prompt;

    try {
        await copyToClipboard(combined);
        const originalText = this.textContent;
        this.textContent = '복사됨!';
        this.classList.remove('btn-outline-primary');
        this.classList.add('btn-success');
        setTimeout(() => {
            this.textContent = originalText;
            this.classList.remove('btn-success');
            this.classList.add('btn-outline-primary');
        }, 1500);
    } catch (err) {
        alert('복사에 실패했습니다: ' + err.message);
    }
});

// 기업분석 1-1: 리포트 생성 프롬프트 저장
document.getElementById('btnSaveAnalysisPrompt').addEventListener('click', function() {
    const value = document.getElementById('promptAnalysis').value;
    savePrompt('prompt_analysis', value, this);
});

// 기업분석 1-2: HTML 변환 프롬프트 저장
document.getElementById('btnSaveAnalysisHtmlPrompt').addEventListener('click', function() {
    const value = document.getElementById('promptAnalysisHtml').value;
    savePrompt('prompt_analysis_html', value, this);
});

// 투자포인트 1-1: 리포트 생성 프롬프트 저장
document.getElementById('btnSaveSummaryPrompt').addEventListener('click', function() {
    const value = document.getElementById('promptSummary').value;
    savePrompt('prompt_summary', value, this);
});

// 투자포인트 1-2: HTML 변환 프롬프트 저장
document.getElementById('btnSaveSummaryHtmlPrompt').addEventListener('click', function() {
    const value = document.getElementById('promptSummaryHtml').value;
    savePrompt('prompt_summary_html', value, this);
});

// 노다지 1-1: 리포트 생성 프롬프트 저장
document.getElementById('btnSaveNodajiPrompt').addEventListener('click', function() {
    const value = document.getElementById('promptNodaji').value;
    savePrompt('prompt_nodaji', value, this);
});

// 노다지 1-2: HTML 변환 프롬프트 저장
document.getElementById('btnSaveNodajiHtmlPrompt').addEventListener('click', function() {
    const value = document.getElementById('promptNodajiHtml').value;
    savePrompt('prompt_nodaji_html', value, this);
});

// === 종목 데이터 조회 모달 ===
const stockSearchInput = document.getElementById('stockSearchInput');
const btnStockSearch = document.getElementById('btnStockSearch');
const stockSearchResults = document.getElementById('stockSearchResults');
const selectedStockInfo = document.getElementById('selectedStockInfo');
const selectedStockName = document.getElementById('selectedStockName');
const selectedStockCode = document.getElementById('selectedStockCode');
const stockDataLoading = document.getElementById('stockDataLoading');
const stockDataResult = document.getElementById('stockDataResult');
const stockDataContent = document.getElementById('stockDataContent');
const btnCopyStockData = document.getElementById('btnCopyStockData');

// 종목 검색
btnStockSearch.addEventListener('click', searchStock);
stockSearchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') searchStock();
});

async function searchStock() {
    const query = stockSearchInput.value.trim();
    if (!query) return;

    try {
        const response = await fetch(`/api/stock/search/?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        if (data.success && data.stocks.length > 0) {
            stockSearchResults.innerHTML = data.stocks.map(s => `
                <button type="button" class="list-group-item list-group-item-action" data-code="${s.code}" data-name="${s.name}">
                    <strong>${s.name}</strong> <small class="text-muted">${s.code}</small>
                </button>
            `).join('');
            stockSearchResults.classList.remove('d-none');
        } else {
            stockSearchResults.innerHTML = '<div class="list-group-item text-muted">검색 결과가 없습니다.</div>';
            stockSearchResults.classList.remove('d-none');
        }
    } catch (err) {
        alert('검색 오류: ' + err.message);
    }
}

// 종목 선택
stockSearchResults.addEventListener('click', async (e) => {
    const btn = e.target.closest('button[data-code]');
    if (!btn) return;

    const code = btn.dataset.code;
    const name = btn.dataset.name;

    // UI 업데이트
    selectedStockName.textContent = name;
    selectedStockCode.textContent = code;
    selectedStockInfo.classList.remove('d-none');
    stockSearchResults.classList.add('d-none');
    stockDataLoading.classList.remove('d-none');
    stockDataResult.classList.add('d-none');

    // 데이터 가져오기
    try {
        const response = await fetch(`/api/stock/${code}/prompt-data/`);
        const data = await response.json();

        if (data.success) {
            stockDataContent.textContent = data.data;
            stockDataLoading.classList.add('d-none');
            stockDataResult.classList.remove('d-none');
        } else {
            alert('데이터 조회 실패');
            stockDataLoading.classList.add('d-none');
        }
    } catch (err) {
        alert('오류: ' + err.message);
        stockDataLoading.classList.add('d-none');
    }
});

// 복사 (copyToClipboard 함수 사용)
btnCopyStockData.addEventListener('click', async () => {
    const text = stockDataContent.textContent;

    try {
        await copyToClipboard(text);
        btnCopyStockData.textContent = '복사됨!';
        btnCopyStockData.classList.remove('btn-success');
        btnCopyStockData.classList.add('btn-secondary');
        setTimeout(() => {
            btnCopyStockData.textContent = '전체 복사';
            btnCopyStockData.classList.remove('btn-secondary');
            btnCopyStockData.classList.add('btn-success');
        }, 1500);
    } catch (err) {
        alert('복사에 실패했습니다: ' + err.message);
    }
});

// 모달 닫힐 때 초기화
document.getElementById('stockDataModal').addEventListener('hidden.bs.modal', () => {
    stockSearchInput.value = '';
    stockSearchResults.classList.add('d-none');
    selectedStockInfo.classList.add('d-none');
    stockDataLoading.classList.add('d-none');
    stockDataResult.classList.add('d-none');
});

// === 섹터 관리 ===
const customSectorName = document.getElementById('customSectorName');
const btnAddCustomSector = document.getElementById('btnAddCustomSector');
const customSectorList = document.getElementById('customSectorList');

btnAddCustomSector.addEventListener('click', async () => {
    const name = customSectorName.value.trim();
    if (!name) {
        alert('섹터명을 입력해주세요.');
        return;
    }

    btnAddCustomSector.disabled = true;

    try {
        const formData = new FormData();
        formData.append('name', name);

        const response = await fetch('/api/custom-sector/add/', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': getCsrfToken() }
        });

        const data = await response.json();

        if (data.success) {
            // 빈 메시지 제거
            const noMsg = document.getElementById('noSectorMsg');
            if (noMsg) noMsg.remove();

            // 새 뱃지 추가
            const badge = document.createElement('span');
            badge.className = 'badge bg-light text-dark border d-flex align-items-center';
            badge.dataset.id = data.id;
            badge.innerHTML = `
                ${escapeHtml(data.name)}
                <button type="button" class="btn-close btn-close-sm ms-1 btn-delete-custom-sector" data-id="${data.id}" data-name="${escapeHtml(data.name)}" style="font-size: 0.6rem;"></button>
            `;
            customSectorList.appendChild(badge);

            customSectorName.value = '';
            customSectorName.focus();
        } else {
            alert(data.error || '저장에 실패했습니다.');
        }
    } catch (err) {
        alert('오류: ' + err.message);
    } finally {
        btnAddCustomSector.disabled = false;
    }
});

customSectorName.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') btnAddCustomSector.click();
});

// 섹터 삭제
document.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('btn-delete-custom-sector')) return;

    const sectorId = e.target.dataset.id;
    const sectorName = e.target.dataset.name;

    if (!confirm(`"${sectorName}" 섹터를 삭제하시겠습니까?`)) return;

    e.target.disabled = true;

    try {
        const response = await fetch(`/api/custom-sector/${sectorId}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCsrfToken() }
        });

        const data = await response.json();

        if (data.success) {
            const badge = e.target.closest('[data-id]');
            badge.remove();

            // 목록이 비었으면 메시지 표시
            if (customSectorList.children.length === 0) {
                customSectorList.innerHTML = '<span class="text-muted small" id="noSectorMsg">등록된 섹터가 없습니다.</span>';
            }
        } else {
            alert(data.error || '삭제에 실패했습니다.');
            e.target.disabled = false;
        }
    } catch (err) {
        alert('오류: ' + err.message);
        e.target.disabled = false;
    }
});
</script>
{% endblock %}
