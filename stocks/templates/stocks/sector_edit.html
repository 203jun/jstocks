{% extends 'stocks/base.html' %}

{% block title %}{{ sector.name }} 편집 - JStocks{% endblock %}

{% block content %}
<!-- 헤더 -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h4 class="mb-0">{{ sector.name }}</h4>
    </div>
    <div>
        <a href="{% url 'stocks:sector_detail' sector.id %}" class="btn btn-sm btn-outline-secondary">상세</a>
        <a href="{% url 'stocks:sector' %}" class="btn btn-sm btn-outline-secondary">목록</a>
    </div>
</div>

<!-- 메인 탭 -->
<ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-content" type="button" role="tab">기본정보</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report-content" type="button" role="tab">리포트</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="telegram-tab" data-bs-toggle="tab" data-bs-target="#telegram-content" type="button" role="tab">텔레그램</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="news-tab" data-bs-toggle="tab" data-bs-target="#news-content" type="button" role="tab">뉴스</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="youtube-tab" data-bs-toggle="tab" data-bs-target="#youtube-content" type="button" role="tab">유튜브</button>
    </li>
</ul>

<div class="tab-content" id="mainTabContent">
    <!-- 기본정보 탭 -->
    <div class="tab-pane fade show active" id="info-content" role="tabpanel">
        <form method="post" id="sectorInfoForm">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="info">

            <!-- 요약 -->
            <div class="card mb-3">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <strong>요약</strong>
                </div>
                <div class="card-body py-2">
                    <textarea class="form-control" name="summary" rows="5" placeholder="섹터 요약을 입력하세요...">{{ sector.summary }}</textarea>
                </div>
            </div>

            <!-- 메모 -->
            <div class="card mb-3">
                <div class="card-header py-2">
                    <strong>메모</strong>
                </div>
                <div class="card-body py-2">
                    <textarea class="form-control" name="memo" rows="5" placeholder="메모를 입력하세요...">{{ sector.memo }}</textarea>
                </div>
            </div>

            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-primary">저장</button>
            </div>
        </form>
    </div>

    <!-- 리포트 탭 -->
    <div class="tab-pane fade" id="report-content" role="tabpanel">
        <div class="card">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <div>
                    <strong>리포트 검색</strong>
                    <small class="text-muted ms-2">"{{ sector.name }}" 관련</small>
                </div>
                <button type="button" id="btnSearchReport" class="btn btn-sm btn-outline-primary">
                    검색
                </button>
            </div>
            <div class="card-body">
                <div id="reportLoading" class="text-center py-3 d-none">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <span class="ms-2">검색 중...</span>
                </div>
                <div id="reportTabs" class="d-none">
                    <ul class="nav nav-tabs" id="reportChannelTabs" role="tablist"></ul>
                    <div class="tab-content pt-3" id="reportChannelTabContent"></div>
                </div>
                <div id="reportEmpty" class="text-muted">버튼을 클릭하면 "{{ sector.name }}" 관련 리포트를 검색합니다.</div>
            </div>
        </div>
    </div>

    <!-- 텔레그램 탭 -->
    <div class="tab-pane fade" id="telegram-content" role="tabpanel">
        <!-- 저장된 메시지 -->
        <div class="card mb-3">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <strong>저장된 메시지</strong>
                <span class="badge bg-primary" id="savedTelegramCount">{{ telegram_messages|length }}</span>
            </div>
            <div class="card-body p-0">
                <div id="savedTelegramList" class="list-group list-group-flush">
                    {% for msg in telegram_messages %}
                    <div class="list-group-item py-2" data-id="{{ msg.id }}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1 overflow-hidden">
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <span class="badge bg-secondary">{{ msg.channel_name|default:msg.channel }}</span>
                                    <small class="text-muted">{{ msg.date }} {{ msg.time }}</small>
                                </div>
                                <div class="small text-truncate-2" style="white-space: pre-wrap; max-height: 3em; overflow: hidden;">{{ msg.text|truncatechars:150 }}</div>
                            </div>
                            <div class="d-flex gap-2 ms-2" style="white-space: nowrap;">
                                <button type="button" class="btn btn-sm btn-outline-primary btn-view-telegram"
                                    data-channel="{{ msg.channel_name|default:msg.channel }}"
                                    data-date="{{ msg.date }} {{ msg.time }}"
                                    data-text="{{ msg.text|escapejs }}">전체보기</button>
                                <button type="button" class="btn btn-sm btn-outline-danger btn-delete-telegram" data-id="{{ msg.id }}">삭제</button>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-3" id="noSavedTelegram">저장된 메시지가 없습니다.</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- 검색 -->
        <div class="card">
            <div class="card-header py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>텔레그램 검색</strong>
                        <small class="text-muted ms-2">1주일 데이터</small>
                    </div>
                </div>
                <div class="mt-2 d-flex gap-2">
                    <input type="text" id="telegramSearchInput" class="form-control form-control-sm" value="{{ sector.name }}" placeholder="검색어 입력">
                    <button type="button" id="btnSearchTelegram" class="btn btn-sm btn-outline-primary" style="white-space: nowrap;">
                        검색
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="telegramLoading" class="text-center py-3 d-none">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <span class="ms-2">검색 중...</span>
                </div>
                <div id="telegramTabs" class="d-none">
                    <ul class="nav nav-tabs" id="channelTabs" role="tablist"></ul>
                    <div class="tab-content pt-3" id="channelTabContent"></div>
                </div>
                <div id="telegramEmpty" class="text-muted">검색어를 입력하고 검색 버튼을 클릭하세요.</div>
            </div>
        </div>
    </div>

    <!-- 뉴스 탭 -->
    <div class="tab-pane fade" id="news-content" role="tabpanel">
        <!-- 링크로 저장 -->
        <div class="card mb-3">
            <div class="card-header py-2">
                <strong>링크로 저장</strong>
            </div>
            <div class="card-body py-2">
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control" id="newsLink" placeholder="뉴스 링크를 붙여넣기...">
                    <button type="button" class="btn btn-primary" id="btnSaveNewsLink">저장</button>
                </div>
                <small class="text-muted">네이버 뉴스, 구글 뉴스 등 뉴스 링크</small>
            </div>
        </div>

        <!-- 저장된 뉴스 -->
        <div class="card mb-3">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <strong>저장된 뉴스</strong>
                <span class="badge bg-primary" id="savedNewsCount">{{ news_articles|length }}</span>
            </div>
            <div class="card-body p-0">
                <div id="savedNewsList" class="list-group list-group-flush">
                    {% for news in news_articles %}
                    <div class="list-group-item py-2" data-id="{{ news.id }}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1 overflow-hidden">
                                <a href="{{ news.link }}" target="_blank" class="fw-semibold text-truncate d-block text-decoration-none">{{ news.title }}</a>
                                <small class="text-muted">{{ news.source }}</small>
                                <small class="text-muted ms-2">{{ news.published|slice:":10" }}</small>
                            </div>
                            <div class="d-flex gap-2 ms-2" style="white-space: nowrap;">
                                <a href="{% url 'stocks:sector_news_summary' news.id %}" class="text-decoration-none" title="요약">
                                    {% if news.summary %}
                                    <span class="badge bg-success">요약</span>
                                    {% else %}
                                    <span class="badge bg-secondary">요약</span>
                                    {% endif %}
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger btn-delete-news" data-id="{{ news.id }}">삭제</button>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-3" id="noSavedNews">저장된 뉴스가 없습니다.</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Google 뉴스 검색 -->
        <div class="card">
            <div class="card-header py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Google 뉴스</strong>
                    </div>
                </div>
                <div class="mt-2 d-flex gap-2">
                    <input type="text" id="newsSearchInput" class="form-control form-control-sm" value="{{ sector.name }}" placeholder="검색어 입력">
                    <button type="button" id="btnSearchNews" class="btn btn-sm btn-outline-info" style="white-space: nowrap;">
                        검색
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="newsLoading" class="text-center py-3 d-none">
                    <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                    <span class="ms-2">검색 중... (5~10초 소요)</span>
                </div>
                <div id="newsResult">
                    <div class="text-muted">검색어를 입력하고 검색 버튼을 클릭하세요.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 유튜브 탭 -->
    <div class="tab-pane fade" id="youtube-content" role="tabpanel">
        <!-- 링크로 저장 -->
        <div class="card mb-3">
            <div class="card-header py-2">
                <strong>링크로 저장</strong>
            </div>
            <div class="card-body py-2">
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control" id="youtubeLink" placeholder="유튜브 링크를 붙여넣기...">
                    <button type="button" class="btn btn-primary" id="btnSaveYoutubeLink">저장</button>
                </div>
                <small class="text-muted">예: https://www.youtube.com/watch?v=... 또는 https://youtu.be/...</small>
            </div>
        </div>

        <!-- 저장된 영상 -->
        <div class="card mb-3">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <strong>저장된 영상</strong>
                <span class="badge bg-primary" id="savedVideoCount">{{ youtube_videos|length }}</span>
            </div>
            <div class="card-body p-0">
                <div id="savedVideoList" class="list-group list-group-flush">
                    {% for video in youtube_videos %}
                    <div class="list-group-item d-flex gap-3 py-2" data-id="{{ video.id }}">
                        {% if video.thumbnail %}
                        <a href="{{ video.link }}" target="_blank">
                            <img src="{{ video.thumbnail }}" alt="" style="width:120px; height:68px; object-fit:cover; border-radius:4px;">
                        </a>
                        {% endif %}
                        <div class="flex-grow-1 overflow-hidden">
                            <a href="{{ video.link }}" target="_blank" class="fw-semibold text-truncate d-block text-decoration-none">{{ video.title }}</a>
                            <small class="text-muted">{{ video.channel }}</small>
                            <small class="text-muted ms-2">{{ video.views }}</small>
                            <small class="text-muted ms-2">{{ video.published }}</small>
                        </div>
                        <div class="d-flex gap-2 align-self-center" style="white-space: nowrap;">
                            <a href="{% url 'stocks:sector_youtube_summary' video.id %}" class="text-decoration-none" title="요약">
                                {% if video.summary %}
                                <span class="badge bg-success">요약</span>
                                {% else %}
                                <span class="badge bg-secondary">요약</span>
                                {% endif %}
                            </a>
                            <button type="button" class="btn btn-sm btn-outline-danger btn-delete-video" data-id="{{ video.id }}">삭제</button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-3" id="noSavedVideo">저장된 영상이 없습니다.</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- 검색 -->
        <div class="card">
            <div class="card-header py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <strong>검색</strong>
                    <div class="d-flex gap-2">
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" id="btnYoutubeGeneral" class="btn btn-outline-secondary active">일반</button>
                            <button type="button" id="btnYoutubePreferred" class="btn btn-outline-secondary">선호</button>
                        </div>
                        <button type="button" id="btnSearchYoutube" class="btn btn-sm btn-danger">검색</button>
                    </div>
                </div>
                <div class="mt-1">
                    <small class="text-muted" id="youtubeSearchInfo">"{{ sector.name }}" 검색 · 조회수 1,000회 이상 · 최신순</small>
                </div>
            </div>
            <div class="card-body">
                <div id="youtubeLoading" class="text-center py-3 d-none">
                    <div class="spinner-border spinner-border-sm text-danger" role="status"></div>
                    <span class="ms-2" id="youtubeLoadingText">검색 중...</span>
                </div>
                <div id="youtubeResult"></div>
            </div>
        </div>
    </div>
</div>

<!-- 텔레그램 메시지 전체보기 모달 -->
<div class="modal fade" id="telegramModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header py-2">
                <div>
                    <span class="badge bg-secondary" id="telegramModalChannel"></span>
                    <small class="text-muted ms-2" id="telegramModalDate"></small>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="white-space: pre-wrap; max-height: 70vh; overflow-y: auto;" id="telegramModalText"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.highlight {
    background-color: #fff3cd;
    padding: 0 2px;
    border-radius: 2px;
    font-weight: bold;
}
#channelTabs,
#reportChannelTabs {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px;
    border-bottom: none;
    padding-bottom: 8px;
    margin-bottom: 8px;
    border-bottom: 1px solid #dee2e6;
}
@media (min-width: 768px) {
    #channelTabs,
    #reportChannelTabs {
        grid-template-columns: repeat(6, 1fr);
    }
}
#channelTabs .nav-item,
#reportChannelTabs .nav-item {
    margin: 0;
}
#channelTabs .nav-link,
#reportChannelTabs .nav-link {
    display: block;
    width: 100%;
    padding: 4px 6px;
    font-size: 0.7rem;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    background: #f8f9fa;
    color: #495057;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
#channelTabs .nav-link:hover,
#reportChannelTabs .nav-link:hover {
    background: #e9ecef;
}
#channelTabs .nav-link.active,
#reportChannelTabs .nav-link.active {
    background: #0d6efd;
    color: white;
    border-color: #0d6efd;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
const sectorName = "{{ sector.name|escapejs }}";
const sectorId = {{ sector.id }};

// 저장된 텔레그램 메시지 키 (channel+date+time으로 중복 체크)
let savedTelegramKeys = new Set([
    {% for msg in telegram_messages %}'{{ msg.channel|escapejs }}_{{ msg.date|escapejs }}_{{ msg.time|escapejs }}',{% endfor %}
]);

// 공통 함수
function linkify(text) {
    const urlRegex = /(https?:\/\/[^\s<]+)/g;
    return text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener">$1</a>');
}

function highlightKeyword(text, keyword) {
    if (!keyword) return text;
    const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
}

function countMessages(channelData) {
    let total = 0;
    let recent = 0;
    const today = new Date();
    const threeDaysAgo = new Date(today.getTime() - 3 * 24 * 60 * 60 * 1000);
    const threeDaysAgoStr = threeDaysAgo.toISOString().split('T')[0];

    for (const date in channelData) {
        const count = channelData[date].length;
        total += count;
        if (date >= threeDaysAgoStr) {
            recent += count;
        }
    }
    return { total, recent };
}

function renderChannelContent(channel, channelName, channelData, keyword) {
    const dates = Object.keys(channelData).sort().reverse();
    if (dates.length === 0) {
        return '<div class="text-muted">검색 결과가 없습니다.</div>';
    }

    let html = '';
    for (const date of dates) {
        const items = channelData[date];
        html += `<div class="mb-3">`;
        html += `<h6 class="text-primary mb-2">${date} (${items.length}건)</h6>`;
        items.forEach((item, idx) => {
            const key = `${channel}_${date}_${item.time}`;
            const isSaved = savedTelegramKeys.has(key);
            const escapedText = item.text.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');

            let text = item.text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            text = linkify(text);
            text = highlightKeyword(text, keyword);

            html += `<div class="border-start border-2 border-primary ps-2 py-2 small bg-light mb-0">`;
            html += `<div class="d-flex justify-content-between align-items-start">`;
            html += `<div class="flex-grow-1">`;
            html += `<span class="text-muted">[${item.time}]</span> `;
            html += `<span style="white-space: pre-wrap;">${text}</span>`;
            html += `</div>`;
            html += `<div class="ms-2" style="white-space: nowrap;">`;
            if (isSaved) {
                html += `<span class="badge bg-success">저장됨</span>`;
            } else {
                html += `<button class="btn btn-sm btn-outline-primary btn-save-telegram"
                    data-channel="${channel}"
                    data-channel-name="${channelName}"
                    data-date="${date}"
                    data-time="${item.time}"
                    data-text="${escapedText}">저장</button>`;
            }
            html += `</div>`;
            html += `</div>`;
            html += `</div>`;
            if (idx < items.length - 1) {
                html += `<hr class="my-2">`;
            }
        });
        html += `</div>`;
    }
    return html;
}

// 텔레그램 검색
async function searchTelegram() {
    const searchQuery = document.getElementById('telegramSearchInput').value.trim();
    if (!searchQuery) {
        alert('검색어를 입력하세요.');
        return;
    }

    const loading = document.getElementById('telegramLoading');
    const tabs = document.getElementById('telegramTabs');
    const channelTabs = document.getElementById('channelTabs');
    const channelTabContent = document.getElementById('channelTabContent');
    const empty = document.getElementById('telegramEmpty');

    loading.classList.remove('d-none');
    tabs.classList.add('d-none');
    channelTabs.innerHTML = '';
    channelTabContent.innerHTML = '';
    empty.classList.add('d-none');

    try {
        const response = await fetch(`/api/telegram/search/?keyword=${encodeURIComponent(searchQuery)}&limit=30`);
        const data = await response.json();

        if (data.error) {
            channelTabContent.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            tabs.classList.remove('d-none');
            return;
        }

        const channels = Object.keys(data.results);
        const channelNames = data.channel_names || {};

        if (channels.length === 0) {
            empty.textContent = '검색 결과가 없습니다.';
            empty.classList.remove('d-none');
            return;
        }

        let tabsHtml = '';
        let contentHtml = '';

        channels.forEach((channel, idx) => {
            const channelId = channel.replace('@', '');
            const displayName = channelNames[channel] || channel;
            const isActive = idx === 0;
            const { total, recent } = countMessages(data.results[channel]);

            const recentBadge = recent > 0 ? `<span class="badge bg-danger">${recent}</span>` : '';
            const totalBadge = total > 0 ? `<span class="badge bg-secondary">${total}</span>` : '';

            tabsHtml += `
                <li class="nav-item" role="presentation">
                    <button class="nav-link ${isActive ? 'active' : ''} ${recent > 0 ? 'has-recent' : ''}"
                            id="${channelId}-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#${channelId}-content"
                            type="button" role="tab">
                        ${displayName} ${recentBadge}${totalBadge}
                    </button>
                </li>`;

            contentHtml += `
                <div class="tab-pane fade ${isActive ? 'show active' : ''}"
                     id="${channelId}-content" role="tabpanel">
                    ${renderChannelContent(channel, displayName, data.results[channel], searchQuery)}
                </div>`;
        });

        channelTabs.innerHTML = tabsHtml;
        channelTabContent.innerHTML = contentHtml;
        tabs.classList.remove('d-none');

    } catch (err) {
        channelTabContent.innerHTML = `<div class="alert alert-danger">오류: ${err.message}</div>`;
        tabs.classList.remove('d-none');
    } finally {
        loading.classList.add('d-none');
    }
}

document.getElementById('btnSearchTelegram').addEventListener('click', searchTelegram);
document.getElementById('telegramSearchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') searchTelegram();
});

// 리포트 검색 (텔레그램에서 리포트 관련 채널 검색)
document.getElementById('btnSearchReport').addEventListener('click', async function() {
    const loading = document.getElementById('reportLoading');
    const tabs = document.getElementById('reportTabs');
    const reportChannelTabs = document.getElementById('reportChannelTabs');
    const reportChannelTabContent = document.getElementById('reportChannelTabContent');
    const empty = document.getElementById('reportEmpty');

    loading.classList.remove('d-none');
    tabs.classList.add('d-none');
    reportChannelTabs.innerHTML = '';
    reportChannelTabContent.innerHTML = '';
    empty.classList.add('d-none');

    try {
        const response = await fetch(`/api/telegram/search/?keyword=${encodeURIComponent(sectorName)}&limit=30`);
        const data = await response.json();

        if (data.error) {
            reportChannelTabContent.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            tabs.classList.remove('d-none');
            return;
        }

        const channels = Object.keys(data.results);
        const channelNames = data.channel_names || {};

        if (channels.length === 0) {
            empty.textContent = '검색 결과가 없습니다.';
            empty.classList.remove('d-none');
            return;
        }

        let tabsHtml = '';
        let contentHtml = '';

        channels.forEach((channel, idx) => {
            const channelId = 'rpt_' + channel.replace('@', '');
            const displayName = channelNames[channel] || channel;
            const isActive = idx === 0;
            const { total, recent } = countMessages(data.results[channel]);

            const recentBadge = recent > 0 ? `<span class="badge bg-danger">${recent}</span>` : '';
            const totalBadge = total > 0 ? `<span class="badge bg-secondary">${total}</span>` : '';

            tabsHtml += `
                <li class="nav-item" role="presentation">
                    <button class="nav-link ${isActive ? 'active' : ''}"
                            id="${channelId}-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#${channelId}-content"
                            type="button" role="tab">
                        ${displayName} ${recentBadge}${totalBadge}
                    </button>
                </li>`;

            contentHtml += `
                <div class="tab-pane fade ${isActive ? 'show active' : ''}"
                     id="${channelId}-content" role="tabpanel">
                    ${renderChannelContent(channel, displayName, data.results[channel], sectorName)}
                </div>`;
        });

        reportChannelTabs.innerHTML = tabsHtml;
        reportChannelTabContent.innerHTML = contentHtml;
        tabs.classList.remove('d-none');

    } catch (err) {
        reportChannelTabContent.innerHTML = `<div class="alert alert-danger">오류: ${err.message}</div>`;
        tabs.classList.remove('d-none');
    } finally {
        loading.classList.add('d-none');
    }
});

// 뉴스 검색
async function searchNews() {
    const searchQuery = document.getElementById('newsSearchInput').value.trim();
    if (!searchQuery) {
        alert('검색어를 입력하세요.');
        return;
    }

    const loading = document.getElementById('newsLoading');
    const result = document.getElementById('newsResult');

    loading.classList.remove('d-none');
    result.innerHTML = '';

    try {
        const response = await fetch(`/api/news/search/?keyword=${encodeURIComponent(searchQuery)}`);
        const data = await response.json();

        if (data.error) {
            result.innerHTML = `<div class="alert alert-danger mb-0">${data.error}</div>`;
        } else if (data.results.length === 0) {
            result.innerHTML = '<div class="text-muted">검색 결과가 없습니다.</div>';
        } else {
            let html = '<div class="table-responsive"><table class="table table-sm table-hover mb-0">';
            html += '<thead class="table-light"><tr><th class="ps-3" style="width:100px;">날짜</th><th>제목</th><th style="width:100px;" class="d-none d-md-table-cell">출처</th><th style="width:60px;"></th></tr></thead><tbody>';
            data.results.forEach(item => {
                const isSaved = savedNewsLinks.has(item.link);
                html += `<tr>`;
                html += `<td class="text-muted ps-3" style="font-size:0.75rem;">${(item.date || '').slice(0, 10) || '-'}</td>`;
                html += `<td><a href="${item.link}" target="_blank" class="text-decoration-none">${item.title}</a></td>`;
                html += `<td class="text-muted d-none d-md-table-cell" style="font-size:0.75rem;">${item.source || ''}</td>`;
                html += `<td class="text-end pe-3">`;
                if (isSaved) {
                    html += `<span class="badge bg-success" style="white-space:nowrap;">저장됨</span>`;
                } else {
                    html += `<button class="btn btn-sm btn-outline-primary btn-save-news" style="white-space:nowrap;" data-link="${item.link}" data-title="${item.title.replace(/"/g, '&quot;')}" data-source="${item.source || ''}" data-published="${item.date || ''}">저장</button>`;
                }
                html += `</td></tr>`;
            });
            html += '</tbody></table></div>';
            result.innerHTML = html;

            // 저장 버튼 이벤트
            result.querySelectorAll('.btn-save-news').forEach(btn => {
                btn.addEventListener('click', () => {
                    saveNewsFromSearch(btn, btn.dataset.link, btn.dataset.title, btn.dataset.source, btn.dataset.published);
                });
            });
        }
    } catch (err) {
        result.innerHTML = '<div class="text-danger">오류: ' + err.message + '</div>';
    } finally {
        loading.classList.add('d-none');
    }
}

document.getElementById('btnSearchNews').addEventListener('click', searchNews);
document.getElementById('newsSearchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') searchNews();
});

// ============ 유튜브 저장/삭제 ============
// 저장된 video_id 목록 (중복 체크용)
let savedVideoIds = new Set([
    {% for video in youtube_videos %}'{{ video.video_id }}',{% endfor %}
]);

// video_id 추출 함수 (youtube.com/watch?v=... 및 youtu.be/... 지원)
function extractVideoId(link) {
    // youtube.com/watch?v=VIDEO_ID
    let match = link.match(/[?&]v=([^&]+)/);
    if (match) return match[1];
    // youtu.be/VIDEO_ID
    match = link.match(/youtu\.be\/([^?&]+)/);
    if (match) return match[1];
    // youtube.com/embed/VIDEO_ID
    match = link.match(/embed\/([^?&]+)/);
    if (match) return match[1];
    return '';
}

// 링크로 유튜브 저장
const btnSaveYoutubeLink = document.getElementById('btnSaveYoutubeLink');
const youtubeLinkInput = document.getElementById('youtubeLink');

btnSaveYoutubeLink.addEventListener('click', async () => {
    const link = youtubeLinkInput.value.trim();
    if (!link) {
        alert('유튜브 링크를 입력하세요.');
        return;
    }

    const videoId = extractVideoId(link);
    if (!videoId) {
        alert('올바른 유튜브 링크가 아닙니다.');
        return;
    }

    if (savedVideoIds.has(videoId)) {
        alert('이미 저장된 영상입니다.');
        return;
    }

    btnSaveYoutubeLink.disabled = true;
    btnSaveYoutubeLink.textContent = '저장 중...';

    try {
        const formData = new FormData();
        formData.append('sector_id', sectorId);
        formData.append('link', link);

        const response = await fetch('/api/sector/youtube/video/save-by-link/', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
        });
        const data = await response.json();

        if (data.error) {
            alert(data.error);
        } else {
            // 저장 성공 - 목록에 추가
            savedVideoIds.add(data.video_id);
            addVideoToList(data);
            youtubeLinkInput.value = '';
            alert('저장되었습니다.');
        }
    } catch (err) {
        alert('오류: ' + err.message);
    } finally {
        btnSaveYoutubeLink.disabled = false;
        btnSaveYoutubeLink.textContent = '저장';
    }
});

// 엔터키로 저장
youtubeLinkInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        btnSaveYoutubeLink.click();
    }
});

// 영상 목록에 추가
function addVideoToList(data) {
    const savedList = document.getElementById('savedVideoList');
    const noVideo = document.getElementById('noSavedVideo');
    if (noVideo) noVideo.remove();

    const newItem = document.createElement('div');
    newItem.className = 'list-group-item d-flex gap-3 py-2';
    newItem.dataset.id = data.id;
    newItem.innerHTML = `
        ${data.thumbnail ? `<a href="https://www.youtube.com/watch?v=${data.video_id}" target="_blank"><img src="${data.thumbnail}" alt="" style="width:120px; height:68px; object-fit:cover; border-radius:4px;"></a>` : ''}
        <div class="flex-grow-1 overflow-hidden">
            <a href="https://www.youtube.com/watch?v=${data.video_id}" target="_blank" class="fw-semibold text-truncate d-block text-decoration-none">${data.title}</a>
            <small class="text-muted">${data.channel || ''}</small>
            <small class="text-muted ms-2">${data.views || ''}</small>
            <small class="text-muted ms-2">${data.published || ''}</small>
        </div>
        <div class="d-flex gap-2 align-self-center" style="white-space: nowrap;">
            <a href="/sector/youtube/${data.id}/summary/" class="text-decoration-none" title="요약">
                <span class="badge bg-secondary">요약</span>
            </a>
            <button type="button" class="btn btn-sm btn-outline-danger btn-delete-video" data-id="${data.id}">삭제</button>
        </div>
    `;
    savedList.insertBefore(newItem, savedList.firstChild);

    // 카운트 업데이트
    const countEl = document.getElementById('savedVideoCount');
    countEl.textContent = parseInt(countEl.textContent) + 1;
}

// 유튜브 검색 모드
let youtubeSearchMode = 'general';

document.getElementById('btnYoutubeGeneral').addEventListener('click', function() {
    youtubeSearchMode = 'general';
    this.classList.add('active');
    document.getElementById('btnYoutubePreferred').classList.remove('active');
    document.getElementById('youtubeSearchInfo').textContent = `"${sectorName}" 검색 · 조회수 1,000회 이상 · 최신순`;
});

document.getElementById('btnYoutubePreferred').addEventListener('click', function() {
    youtubeSearchMode = 'preferred';
    this.classList.add('active');
    document.getElementById('btnYoutubeGeneral').classList.remove('active');
    document.getElementById('youtubeSearchInfo').textContent = `선호 채널에서 "${sectorName}" 검색`;
});

// 검색 결과 렌더링 함수
function renderYoutubeResults(data) {
    if (data.error) {
        return `<div class="alert alert-danger mb-0">${data.error}</div>`;
    }

    if (data.message && data.results.length === 0) {
        return `<div class="alert alert-warning mb-0">${data.message}</div>`;
    }

    if (data.results.length === 0) {
        return '<div class="text-muted">검색 결과가 없습니다.</div>';
    }

    let html = '';

    // 선호 모드면 검색된 채널 목록 표시
    if (data.channels_searched && data.channels_searched.length > 0) {
        html += `<div class="small text-muted mb-2">검색 채널: ${data.channels_searched.join(', ')}</div>`;
    }

    html += '<div class="list-group list-group-flush">';
    data.results.forEach(video => {
        const videoId = extractVideoId(video.link);
        const isSaved = savedVideoIds.has(videoId);

        html += `<div class="list-group-item d-flex gap-3 py-2">`;
        if (video.thumbnail) {
            html += `<a href="${video.link}" target="_blank"><img src="${video.thumbnail}" alt="" style="width:120px; height:68px; object-fit:cover; border-radius:4px;"></a>`;
        }
        html += `<div class="flex-grow-1 overflow-hidden">`;
        html += `<a href="${video.link}" target="_blank" class="fw-semibold text-truncate d-block text-decoration-none">${video.title}</a>`;
        html += `<small class="text-muted">${video.channel}</small>`;
        html += `<small class="text-muted ms-2">${video.views || ''}</small>`;
        html += `<small class="text-muted ms-2">${video.published || ''}</small>`;
        html += `</div>`;

        if (isSaved) {
            html += `<span class="badge bg-success align-self-center" style="white-space:nowrap;">저장됨</span>`;
        } else {
            html += `<button type="button" class="btn btn-sm btn-outline-primary align-self-center btn-save-video" style="white-space:nowrap;"
                data-video-id="${videoId}"
                data-title="${video.title.replace(/"/g, '&quot;')}"
                data-channel="${video.channel.replace(/"/g, '&quot;')}"
                data-thumbnail="${video.thumbnail || ''}"
                data-duration="${video.duration || ''}"
                data-views="${video.views || ''}"
                data-published="${video.published || ''}">저장</button>`;
        }

        html += `</div>`;
    });
    html += '</div>';
    return html;
}

// 유튜브 검색
document.getElementById('btnSearchYoutube').addEventListener('click', async function() {
    const loading = document.getElementById('youtubeLoading');
    const loadingText = document.getElementById('youtubeLoadingText');
    const result = document.getElementById('youtubeResult');

    loading.classList.remove('d-none');
    result.innerHTML = '';

    let url;
    if (youtubeSearchMode === 'preferred') {
        loadingText.textContent = '선호 채널 검색 중... (채널 수에 따라 20~40초 소요)';
        url = `/api/youtube/search/preferred/?keyword=${encodeURIComponent(sectorName)}&min_views=1000`;
    } else {
        loadingText.textContent = '검색 중...';
        url = `/api/youtube/search/?keyword=${encodeURIComponent(sectorName)}&min_views=1000`;
    }

    try {
        const response = await fetch(url);
        const data = await response.json();
        result.innerHTML = renderYoutubeResults(data);
    } catch (err) {
        result.innerHTML = '<div class="text-danger">오류: ' + err.message + '</div>';
    } finally {
        loading.classList.add('d-none');
    }
});

// 검색 결과에서 저장 버튼 클릭 (이벤트 위임)
document.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('btn-save-video')) return;

    const btn = e.target;
    btn.disabled = true;
    btn.textContent = '저장 중...';

    const videoId = btn.dataset.videoId;
    const title = btn.dataset.title;
    const channel = btn.dataset.channel;
    const thumbnail = btn.dataset.thumbnail;
    const duration = btn.dataset.duration;
    const views = btn.dataset.views;
    const published = btn.dataset.published;

    try {
        const formData = new FormData();
        formData.append('sector_id', sectorId);
        formData.append('video_id', videoId);
        formData.append('title', title);
        formData.append('channel', channel);
        formData.append('thumbnail', thumbnail);
        formData.append('duration', duration);
        formData.append('views', views);
        formData.append('published', published);

        const response = await fetch('/api/sector/youtube/video/save/', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        const data = await response.json();

        if (data.success) {
            // 저장된 영상 목록에 추가
            savedVideoIds.add(videoId);
            addVideoToList({
                id: data.id,
                video_id: videoId,
                title: title,
                channel: channel,
                thumbnail: thumbnail,
                views: views,
                published: published
            });

            // 버튼을 "저장됨" 뱃지로 교체
            const badge = document.createElement('span');
            badge.className = 'badge bg-success align-self-center';
            badge.textContent = '저장됨';
            btn.replaceWith(badge);
        } else {
            alert(data.error || '저장에 실패했습니다.');
            btn.disabled = false;
            btn.textContent = '저장';
        }
    } catch (err) {
        alert('오류: ' + err.message);
        btn.disabled = false;
        btn.textContent = '저장';
    }
});

// 삭제 버튼 클릭 (이벤트 위임)
document.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('btn-delete-video')) return;

    if (!confirm('삭제하시겠습니까?')) return;

    const btn = e.target;
    const videoDbId = btn.dataset.id;
    btn.disabled = true;

    try {
        const response = await fetch(`/api/sector/youtube/video/${videoDbId}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        const data = await response.json();

        if (data.success) {
            const item = btn.closest('.list-group-item');
            // video_id 찾기 (삭제 시 savedVideoIds에서 제거)
            const link = item.querySelector('a[href*="youtube.com"]');
            if (link) {
                const vid = extractVideoId(link.href);
                savedVideoIds.delete(vid);
            }
            item.remove();

            // 카운트 업데이트
            const countEl = document.getElementById('savedVideoCount');
            const newCount = parseInt(countEl.textContent) - 1;
            countEl.textContent = newCount;

            // 목록이 비었으면 메시지 표시
            const savedList = document.getElementById('savedVideoList');
            if (savedList.querySelectorAll('.list-group-item[data-id]').length === 0) {
                savedList.innerHTML = '<div class="text-center text-muted py-3" id="noSavedVideo">저장된 영상이 없습니다.</div>';
            }
        } else {
            alert(data.error || '삭제에 실패했습니다.');
            btn.disabled = false;
        }
    } catch (err) {
        alert('오류: ' + err.message);
        btn.disabled = false;
    }
});

// URL 해시로 탭 활성화
document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;
    if (hash) {
        const tabButton = document.querySelector(`button[data-bs-target="${hash}"]`);
        if (tabButton) {
            const tab = new bootstrap.Tab(tabButton);
            tab.show();
        }
    }
});

// ============ 텔레그램 저장/삭제 ============

// 메시지 저장
document.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('btn-save-telegram')) return;

    const btn = e.target;
    const channel = btn.dataset.channel;
    const channelName = btn.dataset.channelName;
    const date = btn.dataset.date;
    const time = btn.dataset.time;
    const text = btn.dataset.text;

    const key = `${channel}_${date}_${time}`;
    if (savedTelegramKeys.has(key)) {
        alert('이미 저장된 메시지입니다.');
        return;
    }

    btn.disabled = true;
    btn.textContent = '저장 중...';

    try {
        const formData = new FormData();
        formData.append('sector_id', sectorId);
        formData.append('channel', channel);
        formData.append('channel_name', channelName);
        formData.append('date', date);
        formData.append('time', time);
        formData.append('text', text);

        const response = await fetch('/api/sector/telegram/save/', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
        });
        const data = await response.json();

        if (data.error) {
            alert(data.error);
            btn.disabled = false;
            btn.textContent = '저장';
        } else {
            savedTelegramKeys.add(key);
            addTelegramToList(data);
            // 버튼을 뱃지로 교체
            const badge = document.createElement('span');
            badge.className = 'badge bg-success';
            badge.textContent = '저장됨';
            btn.replaceWith(badge);
        }
    } catch (err) {
        alert('오류: ' + err.message);
        btn.disabled = false;
        btn.textContent = '저장';
    }
});

// 저장된 목록에 추가
function addTelegramToList(data) {
    const savedList = document.getElementById('savedTelegramList');
    const noMsg = document.getElementById('noSavedTelegram');
    if (noMsg) noMsg.remove();

    const newItem = document.createElement('div');
    newItem.className = 'list-group-item py-2';
    newItem.dataset.id = data.id;
    const truncatedText = data.text.length > 150 ? data.text.substring(0, 150) + '...' : data.text;
    const escapedText = data.text.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
    newItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1 overflow-hidden">
                <div class="d-flex align-items-center gap-2 mb-1">
                    <span class="badge bg-secondary">${data.channel_name || data.channel}</span>
                    <small class="text-muted">${data.date} ${data.time}</small>
                </div>
                <div class="small" style="white-space: pre-wrap; max-height: 3em; overflow: hidden;">${truncatedText}</div>
            </div>
            <div class="d-flex gap-2 ms-2" style="white-space: nowrap;">
                <button type="button" class="btn btn-sm btn-outline-primary btn-view-telegram"
                    data-channel="${data.channel_name || data.channel}"
                    data-date="${data.date} ${data.time}"
                    data-text="${escapedText}">전체보기</button>
                <button type="button" class="btn btn-sm btn-outline-danger btn-delete-telegram" data-id="${data.id}">삭제</button>
            </div>
        </div>
    `;
    savedList.insertBefore(newItem, savedList.firstChild);

    const countEl = document.getElementById('savedTelegramCount');
    countEl.textContent = parseInt(countEl.textContent) + 1;
}

// 메시지 삭제
document.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('btn-delete-telegram')) return;

    if (!confirm('삭제하시겠습니까?')) return;

    const msgId = e.target.dataset.id;
    e.target.disabled = true;

    try {
        const response = await fetch(`/api/sector/telegram/${msgId}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });
        const data = await response.json();

        if (data.success) {
            const item = e.target.closest('.list-group-item');
            item.remove();

            const countEl = document.getElementById('savedTelegramCount');
            const newCount = parseInt(countEl.textContent) - 1;
            countEl.textContent = newCount;

            if (newCount === 0) {
                document.getElementById('savedTelegramList').innerHTML = '<div class="text-center text-muted py-3" id="noSavedTelegram">저장된 메시지가 없습니다.</div>';
            }
        } else {
            alert(data.error || '삭제 실패');
            e.target.disabled = false;
        }
    } catch (err) {
        alert('오류: ' + err.message);
        e.target.disabled = false;
    }
});

// 메시지 전체보기
document.addEventListener('click', (e) => {
    if (!e.target.classList.contains('btn-view-telegram')) return;

    const channel = e.target.dataset.channel;
    const date = e.target.dataset.date;
    // 이스케이프 시퀀스 디코딩
    let text = e.target.dataset.text;
    // 유니코드 이스케이프 시퀀스 디코딩 (\uXXXX)
    text = text.replace(/\\u([0-9a-fA-F]{4})/g, (m, cc) => String.fromCharCode(parseInt(cc, 16)));
    // \n을 실제 줄바꿈으로 변환
    text = text.replace(/\\n/g, '\n');
    // 줄 끝의 백슬래시 제거
    text = text.replace(/\\\n/g, '\n');
    text = text.replace(/\\$/gm, '');

    document.getElementById('telegramModalChannel').textContent = channel;
    document.getElementById('telegramModalDate').textContent = date;
    document.getElementById('telegramModalText').textContent = text;

    const modal = new bootstrap.Modal(document.getElementById('telegramModal'));
    modal.show();
});

// ============ 뉴스 저장/삭제 ============
// 저장된 뉴스 링크 목록 (중복 체크용)
let savedNewsLinks = new Set([
    {% for news in news_articles %}'{{ news.link|escapejs }}',{% endfor %}
]);

// 링크로 뉴스 저장
const btnSaveNewsLink = document.getElementById('btnSaveNewsLink');
const newsLinkInput = document.getElementById('newsLink');

btnSaveNewsLink.addEventListener('click', async () => {
    const link = newsLinkInput.value.trim();
    if (!link) {
        alert('뉴스 링크를 입력하세요.');
        return;
    }

    if (savedNewsLinks.has(link)) {
        alert('이미 저장된 뉴스입니다.');
        return;
    }

    btnSaveNewsLink.disabled = true;
    btnSaveNewsLink.textContent = '저장 중...';

    try {
        const formData = new FormData();
        formData.append('sector_id', sectorId);
        formData.append('link', link);

        const response = await fetch('/api/sector/news/save-by-link/', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
        });
        const data = await response.json();

        if (data.error) {
            alert(data.error);
        } else {
            savedNewsLinks.add(data.link);
            addNewsToList(data);
            newsLinkInput.value = '';
            alert('저장되었습니다.');
        }
    } catch (err) {
        alert('오류: ' + err.message);
    } finally {
        btnSaveNewsLink.disabled = false;
        btnSaveNewsLink.textContent = '저장';
    }
});

newsLinkInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') btnSaveNewsLink.click();
});

// 뉴스 목록에 추가
function addNewsToList(data) {
    const savedList = document.getElementById('savedNewsList');
    const noNews = document.getElementById('noSavedNews');
    if (noNews) noNews.remove();

    const newItem = document.createElement('div');
    newItem.className = 'list-group-item py-2';
    newItem.dataset.id = data.id;
    newItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1 overflow-hidden">
                <a href="${data.link}" target="_blank" class="fw-semibold text-truncate d-block text-decoration-none">${data.title}</a>
                <small class="text-muted">${data.source || ''}</small>
                <small class="text-muted ms-2">${(data.published || '').slice(0, 10)}</small>
            </div>
            <div class="d-flex gap-2 ms-2" style="white-space: nowrap;">
                <a href="/sector/news/${data.id}/summary/" class="text-decoration-none" title="요약">
                    <span class="badge bg-secondary">요약</span>
                </a>
                <button type="button" class="btn btn-sm btn-outline-danger btn-delete-news" data-id="${data.id}">삭제</button>
            </div>
        </div>
    `;
    savedList.insertBefore(newItem, savedList.firstChild);

    const countEl = document.getElementById('savedNewsCount');
    countEl.textContent = parseInt(countEl.textContent) + 1;
}

// 검색 결과에서 뉴스 저장
async function saveNewsFromSearch(btn, link, title, source, published) {
    if (savedNewsLinks.has(link)) {
        alert('이미 저장된 뉴스입니다.');
        return;
    }

    btn.disabled = true;
    btn.textContent = '저장 중...';

    try {
        const formData = new FormData();
        formData.append('sector_id', sectorId);
        formData.append('link', link);
        formData.append('title', title);
        formData.append('source', source);
        formData.append('published', published);

        const response = await fetch('/api/sector/news/save/', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
        });
        const data = await response.json();

        if (data.error) {
            alert(data.error);
            btn.disabled = false;
            btn.textContent = '저장';
        } else {
            savedNewsLinks.add(data.link);
            addNewsToList(data);
            // 버튼을 "저장됨" 뱃지로 교체
            const badge = document.createElement('span');
            badge.className = 'badge bg-success';
            badge.textContent = '저장됨';
            btn.replaceWith(badge);
        }
    } catch (err) {
        alert('오류: ' + err.message);
        btn.disabled = false;
        btn.textContent = '저장';
    }
}

// 뉴스 삭제
document.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('btn-delete-news')) return;

    if (!confirm('삭제하시겠습니까?')) return;

    const newsId = e.target.dataset.id;
    e.target.disabled = true;

    try {
        const response = await fetch(`/api/sector/news/${newsId}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });
        const data = await response.json();

        if (data.success) {
            const item = e.target.closest('.list-group-item');
            const link = item.querySelector('a[target="_blank"]').href;
            savedNewsLinks.delete(link);
            item.remove();

            const countEl = document.getElementById('savedNewsCount');
            const newCount = parseInt(countEl.textContent) - 1;
            countEl.textContent = newCount;

            if (newCount === 0) {
                document.getElementById('savedNewsList').innerHTML = '<div class="text-center text-muted py-3" id="noSavedNews">저장된 뉴스가 없습니다.</div>';
            }
        } else {
            alert(data.error || '삭제 실패');
            e.target.disabled = false;
        }
    } catch (err) {
        alert('오류: ' + err.message);
        e.target.disabled = false;
    }
});
</script>
{% endblock %}
