{% extends 'stocks/base.html' %}
{% load humanize %}

{% block title %}{{ stock.name }} - JStocks{% endblock %}

{% block content %}
<!-- ì¢…ëª© í—¤ë” -->
<div class="d-flex justify-content-between align-items-start mb-3">
    <div>
        <h4 class="mb-2 d-flex align-items-center">
            {{ stock.name }}
            <small class="text-muted ms-2" style="font-size: 0.5em; font-weight: normal;">{{ stock.code }}</small>
            {% if stock.interest_level %}
            <button type="button" id="btnRefreshStock" class="btn btn-sm ms-2" data-code="{{ stock.code }}" title="ìƒˆë¡œê³ ì¹¨" style="padding: 0; border: none; background: none; font-size: 1rem; line-height: 1; cursor: pointer;">ğŸ”„</button>
            {% endif %}
        </h4>
        <div class="d-flex align-items-center gap-1">
            <span class="badge {% if stock.market == 'KOSPI' %}bg-primary{% else %}bg-success{% endif %}">{{ stock.market }}</span>
            {% if stock.is_holding %}
            <span class="badge bg-success">ë³´ìœ </span>
            {% endif %}
            {% if stock.interest_level == 'super' %}
            <span class="badge bg-danger">ì´ˆê´€ì‹¬</span>
            {% elif stock.interest_level == 'normal' %}
            <span class="badge bg-warning text-dark">ê´€ì‹¬</span>
            {% elif stock.interest_level == 'incubator' %}
            <span class="badge bg-info">ì¸íë² ì´í„°</span>
            {% endif %}
        </div>
    </div>
    <div>
        <a href="{% url 'stocks:stock_edit' stock.code %}" class="btn btn-outline-primary btn-sm me-1">í¸ì§‘</a>
        <a href="{% url 'stocks:stock_list' %}" class="btn btn-outline-secondary btn-sm">ëª©ë¡</a>
    </div>
</div>

<!-- í…Œë§ˆ / ì—…ì¢… ì •ë³´ -->
<table class="table table-borderless mb-3" style="width: auto;">
    {% if stock.themes.all %}
    <tr>
        <td class="text-muted py-1 pe-3" style="white-space: nowrap; vertical-align: top;">í…Œë§ˆ</td>
        <td class="py-1">
            {% regroup stock.themes.all by category as theme_groups %}
            {% for group in theme_groups %}
            <div class="d-flex align-items-center flex-wrap mb-1">
                <span class="badge bg-primary me-2">{{ group.grouper.name }}</span>
                {% for theme in group.list %}
                <span class="badge border border-primary text-primary me-1" style="background: transparent;">{{ theme.name }}</span>
                {% endfor %}
            </div>
            {% endfor %}
        </td>
    </tr>
    {% endif %}
    {% if sectors %}
    <tr>
        <td class="text-muted py-1 pe-3" style="white-space: nowrap; vertical-align: top;">ì—…ì¢…</td>
        <td class="py-1">
            {% for s in sectors %}
            <span class="badge border border-secondary text-secondary me-1" style="background: transparent;">{{ s.name }}</span>
            {% endfor %}
        </td>
    </tr>
    {% endif %}
</table>

<!-- ê°€ê²© ì •ë³´ ì¹´ë“œ -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row">
            <div class="col-6 col-md-3">
                <small class="text-muted">í˜„ì¬ê°€</small>
                <div class="fs-4 fw-bold" id="currentPrice">
                    {% if stock.current_price %}
                        {{ stock.current_price|intcomma }}
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
            <div class="col-6 col-md-3">
                <small class="text-muted">ë“±ë½ìœ¨</small>
                <div class="fs-4 fw-bold {% if stock.change_rate > 0 %}text-up{% elif stock.change_rate < 0 %}text-down{% endif %}" id="changeRate">
                    {% if stock.change_rate %}
                        {% if stock.change_rate > 0 %}+{% endif %}{{ stock.change_rate }}%
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
            <div class="col-6 col-md-3">
                <small class="text-muted">ì „ì¼ëŒ€ë¹„</small>
                <div class="{% if stock.price_change > 0 %}text-up{% elif stock.price_change < 0 %}text-down{% endif %}" id="priceChange">
                    {% if stock.price_change %}
                        {% if stock.price_change > 0 %}+{% endif %}{{ stock.price_change|intcomma }}
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
            <div class="col-6 col-md-3">
                <small class="text-muted">ê±°ë˜ëŸ‰</small>
                <div id="volume">
                    {% if stock.volume %}
                        {{ stock.volume|intcomma }}
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì¸ì‚¬ì´íŠ¸ (íˆ¬ìí¬ì¸íŠ¸/ë¦¬ìŠ¤í¬/ì¼ì • í†µí•©) -->
{% if stock.insight_summary_html or stock.insight_report_html %}
<div class="card mb-3">
    <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <strong>ì¸ì‚¬ì´íŠ¸</strong>
        {% if stock.insight_updated_at %}<small class="text-muted">update: {{ stock.insight_updated_at|date:"Y-m-d" }}</small>{% endif %}
    </div>
    <div class="card-body p-0">
        <!-- íƒ­ (ë‘˜ ë‹¤ ìˆì„ ë•Œë§Œ í‘œì‹œ) -->
        {% if stock.insight_summary_html and stock.insight_report_html %}
        <ul class="nav nav-tabs nav-tabs-sm px-3 pt-2" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="insight-summary-tab" data-bs-toggle="tab" data-bs-target="#insight-summary-panel" type="button" role="tab">ìš”ì•½</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="insight-report-tab" data-bs-toggle="tab" data-bs-target="#insight-report-panel" type="button" role="tab">ë¦¬í¬íŠ¸</button>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane fade show active" id="insight-summary-panel" role="tabpanel">
                <iframe src="{% url 'stocks:stock_insight_summary_html' stock.code %}" style="width: 100%; height: 500px; border: none;"></iframe>
            </div>
            <div class="tab-pane fade" id="insight-report-panel" role="tabpanel">
                <iframe src="{% url 'stocks:stock_insight_report_html' stock.code %}" style="width: 100%; height: 600px; border: none;"></iframe>
            </div>
        </div>
        {% elif stock.insight_summary_html %}
        <!-- ìš”ì•½ë§Œ ìˆì„ ë•Œ -->
        <iframe src="{% url 'stocks:stock_insight_summary_html' stock.code %}" style="width: 100%; height: 500px; border: none;"></iframe>
        {% else %}
        <!-- ë¦¬í¬íŠ¸ë§Œ ìˆì„ ë•Œ -->
        <iframe src="{% url 'stocks:stock_insight_report_html' stock.code %}" style="width: 100%; height: 600px; border: none;"></iframe>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- ë©”ëª¨ -->
<div class="card mb-3">
    <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <strong>ë©”ëª¨</strong>
        {% if stock.memo_updated_at %}<small class="text-muted">update: {{ stock.memo_updated_at|date:"Y-m-d" }}</small>{% endif %}
    </div>
    <div class="card-body">
        <div class="content markdown-content" id="memoMarkdown"></div>
        <script type="text/plain" id="memoRaw">{{ stock.memo|default:"-"|safe }}</script>
    </div>
</div>

<div class="row">
    <!-- íˆ¬ì ì§€í‘œ -->
    <div class="col-12 col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>íˆ¬ì ì§€í‘œ</strong>
            </div>
            <div class="card-body py-2">
                <table class="table table-sm mb-0">
                    <tr>
                        <td class="text-muted">PER</td>
                        <td class="text-end">{% if stock.per %}{{ stock.per }}ë°°{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">PBR</td>
                        <td class="text-end">{% if stock.pbr %}{{ stock.pbr }}ë°°{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">ROE</td>
                        <td class="text-end">{% if stock.roe %}{{ stock.roe }}%{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">EPS</td>
                        <td class="text-end">{% if stock.eps %}{{ stock.eps|intcomma }}ì›{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">BPS</td>
                        <td class="text-end">{% if stock.bps %}{{ stock.bps|intcomma }}ì›{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">EV</td>
                        <td class="text-end">{% if stock.ev %}{{ stock.ev }}{% else %}-{% endif %}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- ì‹œê°€ì´ì•¡ ì •ë³´ -->
    <div class="col-12 col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>ì‹œê°€ì´ì•¡</strong>
            </div>
            <div class="card-body py-2">
                <table class="table table-sm mb-0">
                    <tr>
                        <td class="text-muted">ì‹œê°€ì´ì•¡</td>
                        <td class="text-end">{% if stock.market_cap %}{{ stock.market_cap|intcomma }}ì–µ{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">ìœ í†µë¹„ìœ¨</td>
                        <td class="text-end">{% if stock.listed_ratio %}{{ stock.listed_ratio }}%{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">ì‹ ìš©ë¹„ìœ¨</td>
                        <td class="text-end">{% if stock.credit_ratio %}{{ stock.credit_ratio }}%{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">ì™¸ì¸ì†Œì§„ë¥ </td>
                        <td class="text-end">{% if stock.foreign_exhaustion %}{{ stock.foreign_exhaustion }}%{% else %}-{% endif %}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ì‹¤ì  ì°¨íŠ¸ -->
<div class="row">
    <div class="col-12 col-md-4 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>ì—°ê°„ ì‹¤ì </strong>
            </div>
            <div class="card-body py-2">
                <div style="height: 400px;">
                    <canvas id="annualChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-8 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>ë¶„ê¸° ì‹¤ì </strong>
            </div>
            <div class="card-body py-2">
                <div style="height: 400px;">
                    <canvas id="quarterlyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì¼ë´‰ ì°¨íŠ¸ -->
<div class="card mb-3">
    <div class="card-header py-2 d-flex align-items-center justify-content-between">
        <div>
            <strong>ì¼ë´‰</strong>
            <small class="text-muted ms-2">ìµœê·¼ 240ì¼</small>
        </div>
        <div class="d-flex gap-1">
            <span class="badge ma-toggle active" data-ma="10" style="background-color: #ff9800; cursor: pointer;">10</span>
            <span class="badge ma-toggle active" data-ma="20" style="background-color: #2196f3; cursor: pointer;">20</span>
            <span class="badge ma-toggle active" data-ma="60" style="background-color: #4caf50; cursor: pointer;">60</span>
            <span class="badge ma-toggle active" data-ma="120" style="background-color: #9c27b0; cursor: pointer;">120</span>
        </div>
    </div>
    <div class="card-body py-2">
        <div id="dailyChart" style="height: 400px;"></div>
    </div>
</div>

<!-- ì£¼ë´‰ ì°¨íŠ¸ -->
<div class="card mb-3">
    <div class="card-header py-2">
        <strong>ì£¼ë´‰</strong>
        <small class="text-muted ms-2">ìµœê·¼ 2ë…„</small>
    </div>
    <div class="card-body py-2">
        <div id="weeklyChart" style="height: 400px;"></div>
    </div>
</div>

<!-- ì›”ë´‰ ì°¨íŠ¸ -->
<div class="card mb-3">
    <div class="card-header py-2">
        <strong>ì›”ë´‰</strong>
        <small class="text-muted ms-2">ìµœê·¼ 6ë…„</small>
    </div>
    <div class="card-body py-2">
        <div id="monthlyChart" style="height: 400px;"></div>
    </div>
</div>

<!-- ê¸°ì—…ë¶„ì„ -->
{% if stock.analysis_text or analysis_html_exists %}
<div class="card mb-3">
    <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <strong>ê¸°ì—…ë¶„ì„</strong>
        {% if stock.analysis_updated_at %}<small class="text-muted">update: {{ stock.analysis_updated_at|date:"Y-m-d" }}</small>{% endif %}
    </div>
    <div class="card-body p-0">
        <!-- íƒ­ (ë‘˜ ë‹¤ ìˆì„ ë•Œë§Œ í‘œì‹œ) -->
        {% if stock.analysis_text and analysis_html_exists %}
        <ul class="nav nav-tabs nav-tabs-sm px-3 pt-2" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="analysis-summary-view-tab" data-bs-toggle="tab" data-bs-target="#analysis-summary-view-panel" type="button" role="tab">ìš”ì•½</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analysis-report-view-tab" data-bs-toggle="tab" data-bs-target="#analysis-report-view-panel" type="button" role="tab">ë¦¬í¬íŠ¸</button>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane fade show active" id="analysis-summary-view-panel" role="tabpanel">
                <iframe src="{% url 'stocks:stock_analysis_summary_html' stock.code %}" style="width: 100%; height: 500px; border: none;"></iframe>
            </div>
            <div class="tab-pane fade" id="analysis-report-view-panel" role="tabpanel">
                <iframe src="{% url 'stocks:stock_analysis_html' stock.code %}" style="width: 100%; height: 600px; border: none;"></iframe>
            </div>
        </div>
        {% elif stock.analysis_text %}
        <!-- ìš”ì•½ë§Œ ìˆì„ ë•Œ -->
        <iframe src="{% url 'stocks:stock_analysis_summary_html' stock.code %}" style="width: 100%; height: 500px; border: none;"></iframe>
        {% else %}
        <!-- ë¦¬í¬íŠ¸ë§Œ ìˆì„ ë•Œ -->
        <iframe src="{% url 'stocks:stock_analysis_html' stock.code %}" style="width: 100%; height: 600px; border: none;"></iframe>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- ì—…ë°ì´íŠ¸ ì‹œê°„ -->
<div class="text-muted text-end small">
    ì—…ë°ì´íŠ¸: {{ stock.updated_at|date:"Y-m-d H:i" }}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// marked.js ì˜µì…˜ ì„¤ì •
marked.setOptions({
    breaks: true,      // ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜
    gfm: true,         // GitHub Flavored Markdown í™œì„±í™”
    headerIds: false,  // í—¤ë” ID ë¹„í™œì„±í™” (ë¶ˆí•„ìš”í•œ ì†ì„± ë°©ì§€)
    mangle: false      // ì´ë©”ì¼ ì£¼ì†Œ ë‚œë…í™” ë¹„í™œì„±í™”
});

// ì½˜í…ì¸  ë Œë”ë§ í•¨ìˆ˜ (HTML/ë§ˆí¬ë‹¤ìš´ ìë™ ê°ì§€, Gemini citation ì œê±°)
function renderContent(rawId, markdownId) {
    const rawEl = document.getElementById(rawId);
    const markdownEl = document.getElementById(markdownId);
    if (rawEl && markdownEl) {
        let content = rawEl.textContent;
        // HTML íƒœê·¸ ì œê±° í›„ ì‹¤ì œ í…ìŠ¤íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
        const textOnly = content.replace(/<[^>]*>/g, '').trim();
        if (content && textOnly !== '-' && textOnly !== '') {
            // Gemini citation ì œê±° ([cite_start], [cite: xxx] ë“±)
            content = content.replace(/\[cite_start\]/g, '');
            content = content.replace(/\[cite_end\]/g, '');
            content = content.replace(/\[cite:\s*[\d,\s]+\]/g, '');
            content = content.replace(/\[\/cite\]/g, '');

            // HTML íƒœê·¸ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ HTMLë¡œ ë Œë”ë§, ì•„ë‹ˆë©´ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ë Œë”ë§
            if (/<[a-z][\s\S]*>/i.test(content)) {
                markdownEl.innerHTML = content;
            } else {
                markdownEl.innerHTML = marked.parse(content);
            }
        } else {
            markdownEl.textContent = '-';
        }
    }
}

// ë©”ëª¨ ë Œë”ë§
renderContent('memoRaw', 'memoMarkdown');
</script>
<style>
/* ë§ˆí¬ë‹¤ìš´ ì½˜í…ì¸  ê³µí†µ ìŠ¤íƒ€ì¼ */
.markdown-content {
    font-size: 0.85rem;
    line-height: 1.6;
}
.markdown-content h1, .markdown-content h2, .markdown-content h3 {
    font-size: 1rem;
    font-weight: bold;
    margin-top: 0.8rem;
    margin-bottom: 0.4rem;
}
.markdown-content ul, .markdown-content ol {
    padding-left: 1.2rem;
    margin-bottom: 0.5rem;
}
.markdown-content p {
    margin-bottom: 0.5rem;
}
</style>
<style>
.ma-toggle { opacity: 1; transition: opacity 0.2s; }
.ma-toggle:not(.active) { opacity: 0.3; }
</style>
<script>
// ì´ë™í‰ê·  ê³„ì‚° í•¨ìˆ˜
function calculateMA(data, period) {
    const result = [];
    for (let i = 0; i < data.length; i++) {
        if (i < period - 1) continue;
        let sum = 0;
        for (let j = 0; j < period; j++) {
            sum += data[i - j].close;
        }
        result.push({
            time: data[i].time,
            value: Math.round(sum / period)
        });
    }
    return result;
}

// ì´í‰ì„  ì‹œë¦¬ì¦ˆ ì €ì¥
const maSeries = {};

// ì¼ë´‰ ì°¨íŠ¸ ìƒì„± (ì´í‰ì„  í† ê¸€ í¬í•¨)
function createDailyChartWithMA(containerId, candleData, volumeData, emptyMessage) {
    const container = document.getElementById(containerId);

    if (candleData.length === 0) {
        container.innerHTML = `<div class="text-muted text-center py-5">${emptyMessage}</div>`;
        return;
    }

    const chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: 400,
        layout: {
            backgroundColor: '#ffffff',
            textColor: '#333',
        },
        grid: {
            vertLines: { color: '#f0f0f0' },
            horzLines: { color: '#f0f0f0' },
        },
        crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
        },
        rightPriceScale: {
            borderColor: '#ddd',
        },
        timeScale: {
            borderColor: '#ddd',
            timeVisible: true,
            fixLeftEdge: true,
            fixRightEdge: true,
        },
        handleScale: {
            axisPressedMouseMove: { price: false },
        },
    });

    // ìº”ë“¤ìŠ¤í‹± ì‹œë¦¬ì¦ˆ
    const candleSeries = chart.addCandlestickSeries({
        upColor: '#ef5350',
        downColor: '#26a69a',
        borderUpColor: '#ef5350',
        borderDownColor: '#26a69a',
        wickUpColor: '#ef5350',
        wickDownColor: '#26a69a',
    });
    candleSeries.setData(candleData);

    // ì´ë™í‰ê· ì„  (10, 20, 60, 120)
    const maConfig = {
        10: '#ff9800',
        20: '#2196f3',
        60: '#4caf50',
        120: '#9c27b0'
    };

    for (const [period, color] of Object.entries(maConfig)) {
        const series = chart.addLineSeries({
            color: color,
            lineWidth: 1,
            priceLineVisible: false,
            lastValueVisible: false,
        });
        series.setData(calculateMA(candleData, parseInt(period)));
        maSeries[period] = series;
    }

    // ê±°ë˜ëŸ‰ ì‹œë¦¬ì¦ˆ
    const volumeSeries = chart.addHistogramSeries({
        color: '#26a69a',
        priceFormat: { type: 'volume' },
        priceScaleId: '',
        scaleMargins: { top: 0.8, bottom: 0 },
    });
    volumeSeries.setData(volumeData);

    // ì°¨íŠ¸ ìë™ í¬ê¸° ì¡°ì •
    chart.timeScale().fitContent();

    // ë°˜ì‘í˜•
    new ResizeObserver(entries => {
        if (entries.length > 0) {
            chart.applyOptions({ width: entries[0].contentRect.width });
        }
    }).observe(container);
}

// ìº”ë“¤ìŠ¤í‹± ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜
function createCandleChart(containerId, candleData, volumeData, emptyMessage) {
    const container = document.getElementById(containerId);

    if (candleData.length === 0) {
        container.innerHTML = `<div class="text-muted text-center py-5">${emptyMessage}</div>`;
        return;
    }

    const chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: 400,
        layout: {
            backgroundColor: '#ffffff',
            textColor: '#333',
        },
        grid: {
            vertLines: { color: '#f0f0f0' },
            horzLines: { color: '#f0f0f0' },
        },
        crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
        },
        rightPriceScale: {
            borderColor: '#ddd',
        },
        timeScale: {
            borderColor: '#ddd',
            timeVisible: true,
            fixLeftEdge: true,
            fixRightEdge: true,
        },
        handleScale: {
            axisPressedMouseMove: { price: false },
        },
    });

    const candleSeries = chart.addCandlestickSeries({
        upColor: '#ef5350',
        downColor: '#26a69a',
        borderUpColor: '#ef5350',
        borderDownColor: '#26a69a',
        wickUpColor: '#ef5350',
        wickDownColor: '#26a69a',
    });
    candleSeries.setData(candleData);

    const volumeSeries = chart.addHistogramSeries({
        color: '#26a69a',
        priceFormat: { type: 'volume' },
        priceScaleId: '',
        scaleMargins: { top: 0.8, bottom: 0 },
    });
    volumeSeries.setData(volumeData);

    chart.timeScale().fitContent();

    new ResizeObserver(entries => {
        if (entries.length > 0) {
            chart.applyOptions({ width: entries[0].contentRect.width });
        }
    }).observe(container);
}

// ì¼ë´‰ ì°¨íŠ¸ (ì´í‰ì„  í¬í•¨)
createDailyChartWithMA(
    'dailyChart',
    {{ daily_candle_data|safe }},
    {{ daily_volume_data|safe }},
    'ì¼ë´‰ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'
);

// ì£¼ë´‰ ì°¨íŠ¸
createCandleChart(
    'weeklyChart',
    {{ weekly_candle_data|safe }},
    {{ weekly_volume_data|safe }},
    'ì£¼ë´‰ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'
);

// ì›”ë´‰ ì°¨íŠ¸
createCandleChart(
    'monthlyChart',
    {{ monthly_candle_data|safe }},
    {{ monthly_volume_data|safe }},
    'ì›”ë´‰ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'
);

// ì´í‰ì„  í† ê¸€ ì´ë²¤íŠ¸
document.querySelectorAll('.ma-toggle').forEach(badge => {
    badge.addEventListener('click', function() {
        const period = this.dataset.ma;
        const series = maSeries[period];
        if (!series) return;

        const isActive = this.classList.toggle('active');
        series.applyOptions({ visible: isActive });
    });
});

// ë¹ˆ HTML ì½˜í…ì¸  ì²´í¬ (íˆ¬ìí¬ì¸íŠ¸, ë¦¬ìŠ¤í¬, ë©”ëª¨)
document.querySelectorAll('.content').forEach(el => {
    const text = el.textContent.trim();
    if (!text || text === '') {
        el.innerHTML = '<span class="text-muted">-</span>';
    }
});
</script>
<script>
const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    interaction: {
        mode: 'index',
        intersect: false,
    },
    plugins: {
        legend: {
            position: 'bottom',
            labels: { boxWidth: 12, padding: 8, font: { size: 11 } }
        }
    },
    scales: {
        y: {
            type: 'linear',
            position: 'left',
            beginAtZero: true,
            ticks: {
                callback: function(value) {
                    return value.toLocaleString();
                },
                font: { size: 10 }
            },
            title: {
                display: true,
                text: 'ë§¤ì¶œ(ì–µ)',
                font: { size: 10 }
            }
        },
        y1: {
            type: 'linear',
            position: 'right',
            beginAtZero: true,
            grid: {
                drawOnChartArea: false
            },
            ticks: {
                callback: function(value) {
                    return value.toLocaleString();
                },
                font: { size: 10 }
            },
            title: {
                display: true,
                text: 'ì˜ì—…ì´ìµ(ì–µ)',
                font: { size: 10 }
            }
        },
        x: {
            ticks: { font: { size: 10 } }
        }
    }
};

// ìƒ‰ìƒ ìƒì„± í•¨ìˆ˜ (ì¶”ì •ì¹˜ëŠ” ì—°í•œ ìƒ‰)
function getBarColors(estimated) {
    return estimated.map(e => e ? 'rgba(54, 162, 235, 0.3)' : 'rgba(54, 162, 235, 0.7)');
}
function getLineColors(estimated) {
    return estimated.map(e => e ? 'rgba(255, 99, 132, 0.4)' : 'rgba(255, 99, 132, 1)');
}
function getPointColors(estimated) {
    return estimated.map(e => e ? 'rgba(255, 99, 132, 0.4)' : 'rgba(255, 99, 132, 1)');
}

// ì—°ê°„ ë°ì´í„°
const annualEstimated = {{ annual_estimated|safe }};
const quarterlyEstimated = {{ quarterly_estimated|safe }};

// ì—°ê°„ ì°¨íŠ¸
new Chart(document.getElementById('annualChart'), {
    type: 'bar',
    data: {
        labels: {{ annual_labels|safe }},
        datasets: [
            {
                label: 'ë§¤ì¶œ(ì–µ)',
                data: {{ annual_revenue|safe }},
                backgroundColor: getBarColors(annualEstimated),
                yAxisID: 'y',
                order: 2
            },
            {
                label: 'ì˜ì—…ì´ìµ(ì–µ)',
                data: {{ annual_op|safe }},
                type: 'line',
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                borderWidth: 2,
                pointRadius: 4,
                pointBackgroundColor: getPointColors(annualEstimated),
                segment: {
                    borderColor: ctx => annualEstimated[ctx.p1DataIndex] ? 'rgba(255, 99, 132, 0.4)' : 'rgba(255, 99, 132, 1)',
                    borderDash: ctx => annualEstimated[ctx.p1DataIndex] ? [5, 5] : []
                },
                yAxisID: 'y1',
                order: 1
            }
        ]
    },
    options: chartOptions
});

// ë¶„ê¸° ì°¨íŠ¸
new Chart(document.getElementById('quarterlyChart'), {
    type: 'bar',
    data: {
        labels: {{ quarterly_labels|safe }},
        datasets: [
            {
                label: 'ë§¤ì¶œ(ì–µ)',
                data: {{ quarterly_revenue|safe }},
                backgroundColor: getBarColors(quarterlyEstimated),
                yAxisID: 'y',
                order: 2
            },
            {
                label: 'ì˜ì—…ì´ìµ(ì–µ)',
                data: {{ quarterly_op|safe }},
                type: 'line',
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                borderWidth: 2,
                pointRadius: 4,
                pointBackgroundColor: getPointColors(quarterlyEstimated),
                segment: {
                    borderColor: ctx => quarterlyEstimated[ctx.p1DataIndex] ? 'rgba(255, 99, 132, 0.4)' : 'rgba(255, 99, 132, 1)',
                    borderDash: ctx => quarterlyEstimated[ctx.p1DataIndex] ? [5, 5] : []
                },
                yAxisID: 'y1',
                order: 1
            }
        ]
    },
    options: chartOptions
});

// ì¢…ëª© ìƒˆë¡œê³ ì¹¨
const btnRefreshStock = document.getElementById('btnRefreshStock');
if (btnRefreshStock) btnRefreshStock.addEventListener('click', async function() {
    const code = this.dataset.code;

    this.disabled = true;
    this.classList.add('spin');

    try {
        const response = await fetch(`/api/stock/${code}/refresh/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            }
        });
        const data = await response.json();

        if (data.success) {
            // ê°€ê²© ì •ë³´ ì—…ë°ì´íŠ¸
            const d = data.data;

            // í˜„ì¬ê°€
            document.getElementById('currentPrice').textContent = d.current_price ? d.current_price.toLocaleString('ko-KR') : '-';

            // ë“±ë½ìœ¨
            const changeRateEl = document.getElementById('changeRate');
            if (d.change_rate !== null) {
                const sign = d.change_rate > 0 ? '+' : '';
                changeRateEl.textContent = `${sign}${d.change_rate}%`;
                changeRateEl.className = 'fs-4 fw-bold ' + (d.change_rate > 0 ? 'text-up' : d.change_rate < 0 ? 'text-down' : '');
            } else {
                changeRateEl.textContent = '-';
                changeRateEl.className = 'fs-4 fw-bold';
            }

            // ì „ì¼ëŒ€ë¹„
            const priceChangeEl = document.getElementById('priceChange');
            if (d.price_change !== null) {
                const sign = d.price_change > 0 ? '+' : '';
                priceChangeEl.textContent = `${sign}${d.price_change.toLocaleString('ko-KR')}`;
                priceChangeEl.className = d.price_change > 0 ? 'text-up' : d.price_change < 0 ? 'text-down' : '';
            } else {
                priceChangeEl.textContent = '-';
                priceChangeEl.className = '';
            }

            // ê±°ë˜ëŸ‰
            document.getElementById('volume').textContent = d.volume ? d.volume.toLocaleString('ko-KR') : '-';

            // ê²°ê³¼ ì•Œë¦¼
            const results = data.results;
            let msg = 'ì—…ë°ì´íŠ¸ ì™„ë£Œ: ';
            msg += `ê¸°ë³¸ì •ë³´(${results.info}), `;
            msg += `ìˆ˜ê¸‰(${results.investor}), `;
            msg += `ê³µë§¤ë„(${results.short})`;

            // ì—ëŸ¬ê°€ ìˆìœ¼ë©´ ì•Œë¦¼
            if (results.info !== 'success' || results.investor !== 'success' || results.short !== 'success') {
                alert(msg);
            }
        } else {
            alert(data.error || 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
        }
    } catch (err) {
        alert('ì˜¤ë¥˜: ' + err.message);
    } finally {
        this.disabled = false;
        this.classList.remove('spin');
    }
});
</script>
<style>
#btnRefreshStock.spin {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}
