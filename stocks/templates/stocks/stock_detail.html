{% extends 'stocks/base.html' %}
{% load humanize %}

{% block title %}{{ stock.name }} - JStocks{% endblock %}

{% block content %}
<!-- 종목 헤더 -->
<div class="d-flex justify-content-between align-items-start mb-3">
    <div>
        <h4 class="mb-2 d-flex align-items-center">
            {{ stock.name }}
            <small class="text-muted ms-2" style="font-size: 0.5em; font-weight: normal;">{{ stock.code }}</small>
        </h4>
        <div class="d-flex align-items-center gap-1">
            <span class="badge {% if stock.market == 'KOSPI' %}bg-primary{% else %}bg-success{% endif %}">{{ stock.market }}</span>
            {% if stock.is_holding %}
            <span class="badge bg-success">보유</span>
            {% endif %}
            {% if stock.interest_level == 'super' %}
            <span class="badge bg-danger">초관심</span>
            {% elif stock.interest_level == 'normal' %}
            <span class="badge bg-warning text-dark">관심</span>
            {% elif stock.interest_level == 'incubator' %}
            <span class="badge bg-info">인큐베이터</span>
            {% endif %}
        </div>
    </div>
    <div>
        <a href="{% url 'stocks:stock_edit' stock.code %}" class="btn btn-outline-primary btn-sm me-1">편집</a>
        <a href="{% url 'stocks:stock_list' %}" class="btn btn-outline-secondary btn-sm">목록</a>
    </div>
</div>

<!-- 테마 / 업종 정보 -->
<table class="table table-borderless mb-3" style="width: auto;">
    {% if stock.themes.all %}
    <tr>
        <td class="text-muted py-1 pe-3" style="white-space: nowrap; vertical-align: top;">테마</td>
        <td class="py-1">
            {% regroup stock.themes.all by category as theme_groups %}
            {% for group in theme_groups %}
            <div class="d-flex align-items-center flex-wrap mb-1">
                <span class="badge bg-primary me-2">{{ group.grouper.name }}</span>
                {% for theme in group.list %}
                <span class="badge border border-primary text-primary me-1" style="background: transparent;">{{ theme.name }}</span>
                {% endfor %}
            </div>
            {% endfor %}
        </td>
    </tr>
    {% endif %}
    {% if sectors %}
    <tr>
        <td class="text-muted py-1 pe-3" style="white-space: nowrap; vertical-align: top;">업종</td>
        <td class="py-1">
            {% for s in sectors %}
            <span class="badge border border-secondary text-secondary me-1" style="background: transparent;">{{ s.name }}</span>
            {% endfor %}
        </td>
    </tr>
    {% endif %}
</table>

<!-- 가격 정보 카드 -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row">
            <div class="col-6 col-md-3">
                <small class="text-muted">현재가</small>
                <div class="fs-4 fw-bold">
                    {% if stock.current_price %}
                        {{ stock.current_price|intcomma }}
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
            <div class="col-6 col-md-3">
                <small class="text-muted">등락율</small>
                <div class="fs-4 fw-bold {% if stock.change_rate > 0 %}text-up{% elif stock.change_rate < 0 %}text-down{% endif %}">
                    {% if stock.change_rate %}
                        {% if stock.change_rate > 0 %}+{% endif %}{{ stock.change_rate }}%
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
            <div class="col-6 col-md-3">
                <small class="text-muted">전일대비</small>
                <div class="{% if stock.price_change > 0 %}text-up{% elif stock.price_change < 0 %}text-down{% endif %}">
                    {% if stock.price_change %}
                        {% if stock.price_change > 0 %}+{% endif %}{{ stock.price_change|intcomma }}
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
            <div class="col-6 col-md-3">
                <small class="text-muted">거래량</small>
                <div>
                    {% if stock.volume %}
                        {{ stock.volume|intcomma }}
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 투자포인트 / 리스크 -->
{% if stock.investment_point or stock.risk %}
<div class="row mb-3">
    <div class="col-md-6 mb-3 mb-md-0">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>투자포인트</strong>
            </div>
            <div class="card-body">
                {% if stock.investment_point %}
                <div class="content">{{ stock.investment_point|safe }}</div>
                {% else %}
                <div class="text-muted">-</div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>리스크</strong>
            </div>
            <div class="card-body">
                {% if stock.risk %}
                <div class="content">{{ stock.risk|safe }}</div>
                {% else %}
                <div class="text-muted">-</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 일정 -->
{% if schedules %}
<div class="card mb-3">
    <div class="card-header py-2">
        <strong>일정</strong>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-3" style="width:100px;">날짜</th>
                        <th style="width:110px;">알림일자</th>
                        <th>내용</th>
                    </tr>
                </thead>
                <tbody>
                    {% for schedule in schedules %}
                    <tr>
                        <td class="ps-3">{{ schedule.date_text }}</td>
                        <td class="text-muted small">{{ schedule.date_sort|date:"Y-m-d"|default:"-" }}</td>
                        <td>{{ schedule.content }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <!-- 투자 지표 -->
    <div class="col-12 col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>투자 지표</strong>
            </div>
            <div class="card-body py-2">
                <table class="table table-sm mb-0">
                    <tr>
                        <td class="text-muted">PER</td>
                        <td class="text-end">{% if stock.per %}{{ stock.per }}배{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">PBR</td>
                        <td class="text-end">{% if stock.pbr %}{{ stock.pbr }}배{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">ROE</td>
                        <td class="text-end">{% if stock.roe %}{{ stock.roe }}%{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">EPS</td>
                        <td class="text-end">{% if stock.eps %}{{ stock.eps|intcomma }}원{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">BPS</td>
                        <td class="text-end">{% if stock.bps %}{{ stock.bps|intcomma }}원{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">EV</td>
                        <td class="text-end">{% if stock.ev %}{{ stock.ev }}{% else %}-{% endif %}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- 시가총액 정보 -->
    <div class="col-12 col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>시가총액</strong>
            </div>
            <div class="card-body py-2">
                <table class="table table-sm mb-0">
                    <tr>
                        <td class="text-muted">시가총액</td>
                        <td class="text-end">{% if stock.market_cap %}{{ stock.market_cap|intcomma }}억{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">유통비율</td>
                        <td class="text-end">{% if stock.listed_ratio %}{{ stock.listed_ratio }}%{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">신용비율</td>
                        <td class="text-end">{% if stock.credit_ratio %}{{ stock.credit_ratio }}%{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">외인소진률</td>
                        <td class="text-end">{% if stock.foreign_exhaustion %}{{ stock.foreign_exhaustion }}%{% else %}-{% endif %}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 실적 차트 -->
<div class="row">
    <div class="col-12 col-md-4 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>연간 실적</strong>
            </div>
            <div class="card-body py-2">
                <div style="height: 400px;">
                    <canvas id="annualChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-8 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>분기 실적</strong>
            </div>
            <div class="card-body py-2">
                <div style="height: 400px;">
                    <canvas id="quarterlyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 일봉 차트 -->
<div class="card mb-3">
    <div class="card-header py-2">
        <strong>일봉</strong>
        <small class="text-muted ms-2">최근 240일</small>
        <span class="badge bg-warning text-dark ms-2" style="font-size: 0.65rem;">MA20</span>
        <span class="badge bg-primary ms-1" style="font-size: 0.65rem;">MA60</span>
    </div>
    <div class="card-body py-2">
        <div id="dailyChart" style="height: 400px;"></div>
    </div>
</div>

<!-- 주봉 차트 -->
<div class="card mb-3">
    <div class="card-header py-2">
        <strong>주봉</strong>
        <small class="text-muted ms-2">최근 2년</small>
    </div>
    <div class="card-body py-2">
        <div id="weeklyChart" style="height: 400px;"></div>
    </div>
</div>

<!-- 월봉 차트 -->
<div class="card mb-3">
    <div class="card-header py-2">
        <strong>월봉</strong>
        <small class="text-muted ms-2">최근 6년</small>
    </div>
    <div class="card-body py-2">
        <div id="monthlyChart" style="height: 400px;"></div>
    </div>
</div>

<!-- 업데이트 시간 -->
<div class="text-muted text-end small">
    업데이트: {{ stock.updated_at|date:"Y-m-d H:i" }}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
<script>
// 캔들스틱 차트 생성 함수
function createCandleChart(containerId, candleData, volumeData, emptyMessage, ma20Data, ma60Data) {
    const container = document.getElementById(containerId);

    if (candleData.length === 0) {
        container.innerHTML = `<div class="text-muted text-center py-5">${emptyMessage}</div>`;
        return;
    }

    const chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: 400,
        layout: {
            backgroundColor: '#ffffff',
            textColor: '#333',
        },
        grid: {
            vertLines: { color: '#f0f0f0' },
            horzLines: { color: '#f0f0f0' },
        },
        crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
        },
        rightPriceScale: {
            borderColor: '#ddd',
        },
        timeScale: {
            borderColor: '#ddd',
            timeVisible: true,
            fixLeftEdge: true,
            fixRightEdge: true,
        },
    });

    // 캔들스틱 시리즈
    const candleSeries = chart.addCandlestickSeries({
        upColor: '#ef5350',
        downColor: '#26a69a',
        borderUpColor: '#ef5350',
        borderDownColor: '#26a69a',
        wickUpColor: '#ef5350',
        wickDownColor: '#26a69a',
    });
    candleSeries.setData(candleData);

    // 이동평균선 (MA20 - 노란색)
    if (ma20Data && ma20Data.length > 0) {
        const ma20Series = chart.addLineSeries({
            color: '#ffc107',
            lineWidth: 1,
            priceLineVisible: false,
            lastValueVisible: false,
        });
        ma20Series.setData(ma20Data);
    }

    // 이동평균선 (MA60 - 파란색)
    if (ma60Data && ma60Data.length > 0) {
        const ma60Series = chart.addLineSeries({
            color: '#0d6efd',
            lineWidth: 1,
            priceLineVisible: false,
            lastValueVisible: false,
        });
        ma60Series.setData(ma60Data);
    }

    // 거래량 시리즈
    const volumeSeries = chart.addHistogramSeries({
        color: '#26a69a',
        priceFormat: { type: 'volume' },
        priceScaleId: '',
        scaleMargins: { top: 0.8, bottom: 0 },
    });
    volumeSeries.setData(volumeData);

    // 차트 자동 크기 조정
    chart.timeScale().fitContent();

    // 반응형
    new ResizeObserver(entries => {
        if (entries.length > 0) {
            chart.applyOptions({ width: entries[0].contentRect.width });
        }
    }).observe(container);
}

// 일봉 차트 (이평선 포함)
createCandleChart(
    'dailyChart',
    {{ daily_candle_data|safe }},
    {{ daily_volume_data|safe }},
    '일봉 데이터가 없습니다.',
    {{ daily_ma20_data|safe }},
    {{ daily_ma60_data|safe }}
);

// 주봉 차트
createCandleChart(
    'weeklyChart',
    {{ weekly_candle_data|safe }},
    {{ weekly_volume_data|safe }},
    '주봉 데이터가 없습니다.'
);

// 월봉 차트
createCandleChart(
    'monthlyChart',
    {{ monthly_candle_data|safe }},
    {{ monthly_volume_data|safe }},
    '월봉 데이터가 없습니다.'
);
</script>
<script>
const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    interaction: {
        mode: 'index',
        intersect: false,
    },
    plugins: {
        legend: {
            position: 'bottom',
            labels: { boxWidth: 12, padding: 8, font: { size: 11 } }
        }
    },
    scales: {
        y: {
            type: 'linear',
            position: 'left',
            beginAtZero: true,
            ticks: {
                callback: function(value) {
                    return value.toLocaleString();
                },
                font: { size: 10 }
            },
            title: {
                display: true,
                text: '매출(억)',
                font: { size: 10 }
            }
        },
        y1: {
            type: 'linear',
            position: 'right',
            beginAtZero: true,
            grid: {
                drawOnChartArea: false
            },
            ticks: {
                callback: function(value) {
                    return value.toLocaleString();
                },
                font: { size: 10 }
            },
            title: {
                display: true,
                text: '영업이익(억)',
                font: { size: 10 }
            }
        },
        x: {
            ticks: { font: { size: 10 } }
        }
    }
};

// 색상 생성 함수 (추정치는 연한 색)
function getBarColors(estimated) {
    return estimated.map(e => e ? 'rgba(54, 162, 235, 0.3)' : 'rgba(54, 162, 235, 0.7)');
}
function getLineColors(estimated) {
    return estimated.map(e => e ? 'rgba(255, 99, 132, 0.4)' : 'rgba(255, 99, 132, 1)');
}
function getPointColors(estimated) {
    return estimated.map(e => e ? 'rgba(255, 99, 132, 0.4)' : 'rgba(255, 99, 132, 1)');
}

// 연간 데이터
const annualEstimated = {{ annual_estimated|safe }};
const quarterlyEstimated = {{ quarterly_estimated|safe }};

// 연간 차트
new Chart(document.getElementById('annualChart'), {
    type: 'bar',
    data: {
        labels: {{ annual_labels|safe }},
        datasets: [
            {
                label: '매출(억)',
                data: {{ annual_revenue|safe }},
                backgroundColor: getBarColors(annualEstimated),
                yAxisID: 'y',
                order: 2
            },
            {
                label: '영업이익(억)',
                data: {{ annual_op|safe }},
                type: 'line',
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                borderWidth: 2,
                pointRadius: 4,
                pointBackgroundColor: getPointColors(annualEstimated),
                segment: {
                    borderColor: ctx => annualEstimated[ctx.p1DataIndex] ? 'rgba(255, 99, 132, 0.4)' : 'rgba(255, 99, 132, 1)',
                    borderDash: ctx => annualEstimated[ctx.p1DataIndex] ? [5, 5] : []
                },
                yAxisID: 'y1',
                order: 1
            }
        ]
    },
    options: chartOptions
});

// 분기 차트
new Chart(document.getElementById('quarterlyChart'), {
    type: 'bar',
    data: {
        labels: {{ quarterly_labels|safe }},
        datasets: [
            {
                label: '매출(억)',
                data: {{ quarterly_revenue|safe }},
                backgroundColor: getBarColors(quarterlyEstimated),
                yAxisID: 'y',
                order: 2
            },
            {
                label: '영업이익(억)',
                data: {{ quarterly_op|safe }},
                type: 'line',
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                borderWidth: 2,
                pointRadius: 4,
                pointBackgroundColor: getPointColors(quarterlyEstimated),
                segment: {
                    borderColor: ctx => quarterlyEstimated[ctx.p1DataIndex] ? 'rgba(255, 99, 132, 0.4)' : 'rgba(255, 99, 132, 1)',
                    borderDash: ctx => quarterlyEstimated[ctx.p1DataIndex] ? [5, 5] : []
                },
                yAxisID: 'y1',
                order: 1
            }
        ]
    },
    options: chartOptions
});
</script>
{% endblock %}
