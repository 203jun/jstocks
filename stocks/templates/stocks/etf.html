{% extends 'stocks/base.html' %}
{% load humanize %}

{% block title %}ETF - JStocks{% endblock %}

{% block content %}
<h4 class="mb-3">ETF</h4>

<!-- ETF ì¶”ê°€ í¼ -->
<div class="card mb-3">
    <div class="card-body py-2">
        <form id="add-etf-form" class="d-flex align-items-center gap-2">
            {% csrf_token %}
            <label for="etf-code" class="form-label mb-0 text-nowrap">ì¢…ëª©ì½”ë“œ</label>
            <input type="text" class="form-control form-control-sm" id="etf-code" placeholder="ì˜ˆ: 069500" style="max-width: 120px;">
            <button type="submit" class="btn btn-primary btn-sm" id="add-etf-btn">ì¡°íšŒ</button>
            <span id="add-etf-result" class="ms-2 small"></span>
        </form>
    </div>
</div>

<!-- ëŒ€ì‹œë³´ë“œ ì¹´ë“œ -->
<div class="row mb-4">
    <!-- ì¹´ë“œ A: ì¥ê¸° ì‹ í˜¸ (60ì¼ ì‹ ê³ ê±°ë˜ëŸ‰) -->
    <div class="col-md-6 mb-3">
        <div class="card h-100 signal-card">
            <div class="card-header py-2">
                <strong>ğŸ¥‡ ì¥ê¸° ì‹ í˜¸</strong>
                <small class="text-muted d-block">60ì¼ ì‹ ê³ ê±°ë˜ëŸ‰ Â· ê¸‰ë“±(ì–‘ë´‰+MA20â†‘) Â· ê¸‰ë½(ìŒë´‰+MA20â†“)</small>
            </div>
            <!-- PC: í…Œì´ë¸” -->
            <div class="card-body p-0 d-none d-md-block">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="px-3">ETFëª…</th>
                                <th class="text-end px-3">ë“±ë½ìœ¨</th>
                                <th class="text-end px-3">ê³ ì ëŒ€ë¹„</th>
                                <th class="text-end px-3">10ì¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="table-danger"><td colspan="4" class="px-3 py-1 small fw-bold text-danger">ê¸‰ë“±</td></tr>
                            {% for item in card_a_etfs %}
                            <tr onclick="location.href='{% url 'stocks:etf_detail' item.etf.code %}'" style="cursor:pointer;">
                                <td class="px-3 py-2">
                                    <strong class="small {% if item.above_ma120 %}text-danger{% endif %}">{{ item.etf.name }}</strong>
                                </td>
                                <td class="text-end px-3 py-2 {% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %}">
                                    {% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%
                                </td>
                                <td class="text-end px-3 py-2 small {% if item.high_position >= -15 %}text-danger fw-bold{% elif item.high_position <= -40 %}text-secondary{% endif %}">{{ item.high_position }}%{% if item.high_position >= -15 %} ğŸš€{% elif item.high_position <= -40 %} â™»ï¸{% endif %}</td>
                                <td class="text-end px-3 py-2"><canvas class="sparkline" data-values="{{ item.sparkline|join:',' }}" width="60" height="20"></canvas></td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center text-muted py-2"><small>í•´ë‹¹ ETF ì—†ìŒ</small></td></tr>
                            {% endfor %}
                            <tr class="table-primary"><td colspan="4" class="px-3 py-1 small fw-bold text-primary">ê¸‰ë½</td></tr>
                            {% for item in card_a_down_etfs %}
                            <tr onclick="location.href='{% url 'stocks:etf_detail' item.etf.code %}'" style="cursor:pointer;">
                                <td class="px-3 py-2">
                                    <strong class="small {% if item.above_ma120 %}text-danger{% endif %}">{{ item.etf.name }}</strong>
                                </td>
                                <td class="text-end px-3 py-2 {% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %}">
                                    {% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%
                                </td>
                                <td class="text-end px-3 py-2 small {% if item.high_position >= -15 %}text-danger fw-bold{% elif item.high_position <= -40 %}text-secondary{% endif %}">{{ item.high_position }}%{% if item.high_position >= -15 %} ğŸš€{% elif item.high_position <= -40 %} â™»ï¸{% endif %}</td>
                                <td class="text-end px-3 py-2"><canvas class="sparkline" data-values="{{ item.sparkline|join:',' }}" width="60" height="20"></canvas></td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center text-muted py-2"><small>í•´ë‹¹ ETF ì—†ìŒ</small></td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- ëª¨ë°”ì¼: ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
            <div class="card-body p-2 d-md-none">
                <div class="bg-danger-subtle px-2 py-1 mb-1 small fw-bold text-danger">ê¸‰ë“±</div>
                {% for item in card_a_etfs %}
                <div class="mobile-stock-item border-bottom py-2" onclick="location.href='{% url 'stocks:etf_detail' item.etf.code %}'" style="cursor:pointer;">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong class="{% if item.above_ma120 %}text-danger{% endif %}">{{ item.etf.name }}</strong>
                        <span class="{% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %} fw-bold">{% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center text-muted small mt-1">
                        <span>ê³ ì  <span class="{% if item.high_position >= -15 %}text-danger fw-bold{% elif item.high_position <= -40 %}text-secondary{% endif %}">{{ item.high_position }}%{% if item.high_position >= -15 %} ğŸš€{% elif item.high_position <= -40 %} â™»ï¸{% endif %}</span></span>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted py-2"><small>í•´ë‹¹ ETF ì—†ìŒ</small></div>
                {% endfor %}
                <div class="bg-primary-subtle px-2 py-1 mb-1 mt-2 small fw-bold text-primary">ê¸‰ë½</div>
                {% for item in card_a_down_etfs %}
                <div class="mobile-stock-item border-bottom py-2" onclick="location.href='{% url 'stocks:etf_detail' item.etf.code %}'" style="cursor:pointer;">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong class="{% if item.above_ma120 %}text-danger{% endif %}">{{ item.etf.name }}</strong>
                        <span class="{% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %} fw-bold">{% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center text-muted small mt-1">
                        <span>ê³ ì  <span class="{% if item.high_position >= -15 %}text-danger fw-bold{% elif item.high_position <= -40 %}text-secondary{% endif %}">{{ item.high_position }}%{% if item.high_position >= -15 %} ğŸš€{% elif item.high_position <= -40 %} â™»ï¸{% endif %}</span></span>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted py-2"><small>í•´ë‹¹ ETF ì—†ìŒ</small></div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- ì¹´ë“œ B: ë‹¨ê¸° ì‹ í˜¸ (20ì¼ ì‹ ê³ ê±°ë˜ëŸ‰) -->
    <div class="col-md-6 mb-3">
        <div class="card h-100 signal-card">
            <div class="card-header py-2">
                <strong>ğŸ¥ˆ ë‹¨ê¸° ì‹ í˜¸</strong>
                <small class="text-muted d-block">20ì¼ ì‹ ê³ ê±°ë˜ëŸ‰ Â· ê¸‰ë“±(ì–‘ë´‰+MA20â†‘) Â· ê¸‰ë½(ìŒë´‰+MA20â†“)</small>
            </div>
            <!-- PC: í…Œì´ë¸” -->
            <div class="card-body p-0 d-none d-md-block">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="px-3">ETFëª…</th>
                                <th class="text-end px-3">ë“±ë½ìœ¨</th>
                                <th class="text-end px-3">ê³ ì ëŒ€ë¹„</th>
                                <th class="text-end px-3">10ì¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="table-danger"><td colspan="4" class="px-3 py-1 small fw-bold text-danger">ê¸‰ë“±</td></tr>
                            {% for item in card_b_etfs %}
                            <tr onclick="location.href='{% url 'stocks:etf_detail' item.etf.code %}'" style="cursor:pointer;">
                                <td class="px-3 py-2">
                                    <strong class="small {% if item.above_ma120 %}text-danger{% endif %}">{{ item.etf.name }}</strong>
                                </td>
                                <td class="text-end px-3 py-2 {% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %}">
                                    {% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%
                                </td>
                                <td class="text-end px-3 py-2 small {% if item.high_position >= -15 %}text-danger fw-bold{% elif item.high_position <= -40 %}text-secondary{% endif %}">{{ item.high_position }}%{% if item.high_position >= -15 %} ğŸš€{% elif item.high_position <= -40 %} â™»ï¸{% endif %}</td>
                                <td class="text-end px-3 py-2"><canvas class="sparkline" data-values="{{ item.sparkline|join:',' }}" width="60" height="20"></canvas></td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center text-muted py-2"><small>í•´ë‹¹ ETF ì—†ìŒ</small></td></tr>
                            {% endfor %}
                            <tr class="table-primary"><td colspan="4" class="px-3 py-1 small fw-bold text-primary">ê¸‰ë½</td></tr>
                            {% for item in card_b_down_etfs %}
                            <tr onclick="location.href='{% url 'stocks:etf_detail' item.etf.code %}'" style="cursor:pointer;">
                                <td class="px-3 py-2">
                                    <strong class="small {% if item.above_ma120 %}text-danger{% endif %}">{{ item.etf.name }}</strong>
                                </td>
                                <td class="text-end px-3 py-2 {% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %}">
                                    {% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%
                                </td>
                                <td class="text-end px-3 py-2 small {% if item.high_position >= -15 %}text-danger fw-bold{% elif item.high_position <= -40 %}text-secondary{% endif %}">{{ item.high_position }}%{% if item.high_position >= -15 %} ğŸš€{% elif item.high_position <= -40 %} â™»ï¸{% endif %}</td>
                                <td class="text-end px-3 py-2"><canvas class="sparkline" data-values="{{ item.sparkline|join:',' }}" width="60" height="20"></canvas></td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center text-muted py-2"><small>í•´ë‹¹ ETF ì—†ìŒ</small></td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- ëª¨ë°”ì¼: ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
            <div class="card-body p-2 d-md-none">
                <div class="bg-danger-subtle px-2 py-1 mb-1 small fw-bold text-danger">ê¸‰ë“±</div>
                {% for item in card_b_etfs %}
                <div class="mobile-stock-item border-bottom py-2" onclick="location.href='{% url 'stocks:etf_detail' item.etf.code %}'" style="cursor:pointer;">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong class="{% if item.above_ma120 %}text-danger{% endif %}">{{ item.etf.name }}</strong>
                        <span class="{% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %} fw-bold">{% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center text-muted small mt-1">
                        <span>ê³ ì  <span class="{% if item.high_position >= -15 %}text-danger fw-bold{% elif item.high_position <= -40 %}text-secondary{% endif %}">{{ item.high_position }}%{% if item.high_position >= -15 %} ğŸš€{% elif item.high_position <= -40 %} â™»ï¸{% endif %}</span></span>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted py-2"><small>í•´ë‹¹ ETF ì—†ìŒ</small></div>
                {% endfor %}
                <div class="bg-primary-subtle px-2 py-1 mb-1 mt-2 small fw-bold text-primary">ê¸‰ë½</div>
                {% for item in card_b_down_etfs %}
                <div class="mobile-stock-item border-bottom py-2" onclick="location.href='{% url 'stocks:etf_detail' item.etf.code %}'" style="cursor:pointer;">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong class="{% if item.above_ma120 %}text-danger{% endif %}">{{ item.etf.name }}</strong>
                        <span class="{% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %} fw-bold">{% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center text-muted small mt-1">
                        <span>ê³ ì  <span class="{% if item.high_position >= -15 %}text-danger fw-bold{% elif item.high_position <= -40 %}text-secondary{% endif %}">{{ item.high_position }}%{% if item.high_position >= -15 %} ğŸš€{% elif item.high_position <= -40 %} â™»ï¸{% endif %}</span></span>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted py-2"><small>í•´ë‹¹ ETF ì—†ìŒ</small></div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- ì¹´ë“œ D: ì´í‰ì„  ì¤ì¤ -->
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>ğŸ§² ì´í‰ì„  ì¤ì¤</strong>
                <small class="text-muted d-block">ì •ë°°ì—´ + 60ì„ â†— + ì¢…ê°€&lt;MA20</small>
            </div>
            {% if card_d_etfs %}
            <!-- PC: í…Œì´ë¸” -->
            <div class="card-body p-0 d-none d-md-block">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="px-3">ETFëª…</th>
                                <th class="text-end px-3">ë“±ë½ìœ¨</th>
                                <th class="text-end px-3">60ì„ ëŒ€ë¹„</th>
                                <th class="text-end px-3">10ì¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in card_d_etfs %}
                            <tr onclick="location.href='{% url 'stocks:etf_detail' item.etf.code %}'" style="cursor:pointer;">
                                <td class="px-3 py-2">
                                    <strong class="small">{{ item.etf.name }}</strong>
                                </td>
                                <td class="text-end px-3 py-2 {% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %}">
                                    {% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%
                                </td>
                                <td class="text-end px-3 py-2 small {% if item.gap_from_ma60 >= 0 %}text-danger{% elif item.gap_from_ma60 < -5 %}text-primary{% endif %}">{{ item.gap_from_ma60 }}%</td>
                                <td class="text-end px-3 py-2"><canvas class="sparkline" data-values="{{ item.sparkline|join:',' }}" width="60" height="20"></canvas></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- ëª¨ë°”ì¼: ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
            <div class="card-body p-2 d-md-none">
                {% for item in card_d_etfs %}
                <div class="mobile-stock-item border-bottom py-2" onclick="location.href='{% url 'stocks:etf_detail' item.etf.code %}'" style="cursor:pointer;">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>{{ item.etf.name }}</strong>
                        <span class="{% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %} fw-bold">{% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center text-muted small mt-1">
                        <span>60ì„  <span class="{% if item.gap_from_ma60 >= 0 %}text-danger{% elif item.gap_from_ma60 < -5 %}text-primary{% endif %}">{{ item.gap_from_ma60 }}%</span></span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card-body text-center text-muted py-4">
                <small>í•´ë‹¹ ETF ì—†ìŒ</small>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ì¹´ë“œ C: ì‹ í˜¸ ì¶”ì  -->
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>ğŸ“¡ ì‹ í˜¸ ì¶”ì </strong>
                <small class="text-muted d-block">ìµœê·¼ 5ì¼ ë‚´ ì¡°ê±´ ì¶©ì¡±</small>
            </div>
            {% if card_c_etfs %}
            <!-- PC: í…Œì´ë¸” -->
            <div class="card-body p-0 d-none d-md-block">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="px-3">ETFëª…</th>
                                <th class="text-center px-3">ì‹ í˜¸</th>
                                <th class="text-center px-3">ë‚ ì§œ</th>
                                <th class="text-end px-3">ì–‘ë´‰ëŒ€ë¹„</th>
                                <th class="text-end px-3">10ì¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in card_c_etfs %}
                            <tr style="cursor:pointer;">
                                <td class="px-3 py-2" onclick="location.href='{% url 'stocks:etf_detail' item.etf.code %}'">
                                    <strong class="small {% if item.above_ma120 %}text-danger{% endif %}">{{ item.etf.name }}</strong>
                                </td>
                                <td class="text-center px-3 py-2" onclick="location.href='{% url 'stocks:etf_detail' item.etf.code %}'"><span class="badge" style="background-color: {% if item.signal_type == '60ì¼' %}#4caf50{% else %}#2196f3{% endif %};">{{ item.signal_type }}</span></td>
                                <td class="text-center px-3 py-2 small" onclick="location.href='{% url 'stocks:etf_detail' item.etf.code %}'">{{ item.signal_days_ago }}ì¼ì „</td>
                                <td class="text-end px-3 py-2 signal-chart-btn {% if item.signal_price_change > 0 %}text-danger{% elif item.signal_price_change < 0 %}text-primary{% endif %}"
                                    data-code="{{ item.etf.code }}"
                                    data-name="{{ item.etf.name }}"
                                    data-signal-date="{{ item.signal_date }}"
                                    data-signal-close="{{ item.signal_close }}"
                                    data-current-price="{{ item.current_price }}"
                                    style="text-decoration: underline; cursor: pointer;">
                                    {% if item.signal_price_change > 0 %}+{% endif %}{{ item.signal_price_change }}%
                                </td>
                                <td class="text-end px-3 py-2" onclick="location.href='{% url 'stocks:etf_detail' item.etf.code %}'"><canvas class="sparkline" data-values="{{ item.sparkline|join:',' }}" width="60" height="20"></canvas></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- ëª¨ë°”ì¼: ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
            <div class="card-body p-2 d-md-none">
                {% for item in card_c_etfs %}
                <div class="mobile-stock-item border-bottom py-2" style="cursor:pointer;">
                    <div class="d-flex justify-content-between align-items-center" onclick="location.href='{% url 'stocks:etf_detail' item.etf.code %}'">
                        <span>
                            <strong class="{% if item.above_ma120 %}text-danger{% endif %}">{{ item.etf.name }}</strong>
                            <span class="badge ms-1" style="background-color: {% if item.signal_type == '60ì¼' %}#4caf50{% else %}#2196f3{% endif %}; font-size: 0.7em;">{{ item.signal_type }}</span>
                        </span>
                        <span class="signal-chart-btn {% if item.signal_price_change > 0 %}text-danger{% elif item.signal_price_change < 0 %}text-primary{% endif %} fw-bold"
                            data-code="{{ item.etf.code }}"
                            data-name="{{ item.etf.name }}"
                            data-signal-date="{{ item.signal_date }}"
                            data-signal-close="{{ item.signal_close }}"
                            data-current-price="{{ item.current_price }}"
                            style="text-decoration: underline;">{% if item.signal_price_change > 0 %}+{% endif %}{{ item.signal_price_change }}%</span>
                    </div>
                    <div class="text-muted small mt-1" onclick="location.href='{% url 'stocks:etf_detail' item.etf.code %}'">{{ item.signal_days_ago }}ì¼ì „</div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card-body text-center text-muted py-4">
                <small>í•´ë‹¹ ETF ì—†ìŒ</small>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ê´€ì‹¬ ETF ëª©ë¡ -->
{% if etfs %}
<div class="card mb-3">
    <div class="card-header py-2">
        <strong>ê´€ì‹¬ ETF</strong>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover stock-table mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="px-3">ì¢…ëª©ëª…</th>
                        <th class="text-end px-3">í˜„ì¬ê°€</th>
                        <th class="text-end px-3">ë“±ë½ë¥ </th>
                        <th class="text-end px-3 hide-mobile">ì‹œê°€ì´ì•¡</th>
                    </tr>
                </thead>
                <tbody>
                    {% for etf in etfs %}
                    <tr style="cursor:pointer;" onclick="location.href='{% url 'stocks:etf_detail' etf.code %}'">
                        <td class="px-3">
                            <strong>{{ etf.name }}</strong>
                            <small class="text-muted ms-1">{{ etf.code }}</small>
                            {% for sector in etf.custom_sectors.all %}
                            <span class="badge bg-success ms-1" style="font-size: 0.7em;">{{ sector.name }}</span>
                            {% endfor %}
                        </td>
                        <td class="text-end px-3">{% if etf.current_price %}{{ etf.current_price|intcomma }}{% else %}-{% endif %}</td>
                        <td class="text-end px-3 {% if etf.change_rate > 0 %}text-up{% elif etf.change_rate < 0 %}text-down{% endif %}">
                            {% if etf.change_rate %}{% if etf.change_rate > 0 %}+{% endif %}{{ etf.change_rate }}%{% else %}-{% endif %}
                        </td>
                        <td class="text-end px-3 hide-mobile">{% if etf.market_cap %}{{ etf.market_cap|intcomma }}ì–µ{% else %}-{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- ì¡°íšŒ ê²°ê³¼ -->
<div id="etf-data" class="card d-none">
    <div class="card-body">
        <h5 id="etf-name" class="mb-3"></h5>
        <table class="table table-sm mb-3">
            <tbody>
                <tr><th style="width:100px">ì¢…ëª©ì½”ë“œ</th><td id="etf-code-result"></td></tr>
                <tr><th>í˜„ì¬ê°€</th><td id="etf-price"></td></tr>
                <tr><th>ë“±ë½ë¥ </th><td id="etf-rate"></td></tr>
                <tr><th>NAV</th><td id="etf-nav"></td></tr>
                <tr><th>ì‹œê°€ì´ì•¡</th><td id="etf-market-cap"></td></tr>
            </tbody>
        </table>
        <h6>êµ¬ì„±ì¢…ëª©</h6>
        <table class="table table-sm">
            <thead><tr><th>ì¢…ëª©</th><th class="text-end">ë¹„ì¤‘</th></tr></thead>
            <tbody id="etf-holdings"></tbody>
        </table>
        <div class="mt-3 d-flex align-items-center gap-2">
            <button type="button" class="btn btn-success btn-sm" id="save-etf-btn">ê´€ì‹¬ì¢…ëª© ì €ì¥</button>
            <span id="save-etf-result" class="small"></span>
        </div>
    </div>
</div>

<!-- ì‹ í˜¸ ì°¨íŠ¸ ëª¨ë‹¬ -->
<div class="modal fade" id="signalChartModal" tabindex="-1" aria-labelledby="signalChartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title" id="signalChartModalLabel">ì‹ í˜¸ ì°¨íŠ¸</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-2">
                <div id="signalChartContainer" style="height: 400px;"></div>
                <div class="mt-2 small text-muted">
                    <span class="me-3"><span style="color: #ff9800;">- - -</span> ì‹ í˜¸ì¼ ì¢…ê°€</span>
                    <span><span style="color: #2196f3;">- - -</span> í˜„ì¬ê°€</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// í˜„ì¬ ì¡°íšŒëœ ETF ë°ì´í„° ì €ì¥
let currentETFData = null;

document.getElementById('add-etf-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const code = document.getElementById('etf-code').value.trim();
    const resultSpan = document.getElementById('add-etf-result');
    const submitBtn = document.getElementById('add-etf-btn');
    const dataCard = document.getElementById('etf-data');
    const saveResultSpan = document.getElementById('save-etf-result');

    if (!code) {
        resultSpan.innerHTML = '<span class="text-danger">ì¢…ëª©ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>';
        return;
    }

    // ë¡œë”© ìƒíƒœ
    submitBtn.disabled = true;
    submitBtn.textContent = 'ì¡°íšŒ ì¤‘...';
    resultSpan.innerHTML = '<span class="text-muted">ë„¤ì´ë²„ì—ì„œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</span>';
    dataCard.classList.add('d-none');
    saveResultSpan.innerHTML = '';
    currentETFData = null;

    try {
        const formData = new FormData();
        formData.append('code', code);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        const response = await fetch('{% url "stocks:add_etf" %}', {
            method: 'POST',
            body: formData,
        });

        const data = await response.json();

        if (data.success) {
            resultSpan.innerHTML = '<span class="text-success">ì¡°íšŒ ì™„ë£Œ</span>';

            // ë°ì´í„° ì €ì¥
            currentETFData = data;

            // ë°ì´í„° í‘œì‹œ
            document.getElementById('etf-name').textContent = data.name;
            document.getElementById('etf-code-result').textContent = data.code;
            document.getElementById('etf-price').textContent = data.current_price ? data.current_price.toLocaleString() + 'ì›' : '-';

            const rateEl = document.getElementById('etf-rate');
            if (data.change_rate !== null) {
                const sign = data.change_rate > 0 ? '+' : '';
                rateEl.textContent = sign + data.change_rate.toFixed(2) + '%';
                rateEl.className = data.change_rate > 0 ? 'text-up' : (data.change_rate < 0 ? 'text-down' : '');
            } else {
                rateEl.textContent = '-';
            }

            document.getElementById('etf-nav').textContent = data.nav ? data.nav.toLocaleString() + 'ì›' : '-';
            document.getElementById('etf-market-cap').textContent = data.market_cap ? data.market_cap.toLocaleString() + 'ì–µì›' : '-';

            // êµ¬ì„±ì¢…ëª©
            const holdingsBody = document.getElementById('etf-holdings');
            holdingsBody.innerHTML = '';
            if (data.holdings && data.holdings.length > 0) {
                data.holdings.forEach(h => {
                    holdingsBody.innerHTML += `<tr><td>${h.name}</td><td class="text-end">${h.ratio}</td></tr>`;
                });
            } else {
                holdingsBody.innerHTML = '<tr><td colspan="2" class="text-muted">êµ¬ì„±ì¢…ëª© ì •ë³´ ì—†ìŒ</td></tr>';
            }

            dataCard.classList.remove('d-none');
        } else {
            resultSpan.innerHTML = `<span class="text-danger">${data.error}</span>`;
        }
    } catch (error) {
        resultSpan.innerHTML = `<span class="text-danger">ì˜¤ë¥˜: ${error.message}</span>`;
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ì¡°íšŒ';
    }
});

// ê´€ì‹¬ì¢…ëª© ì €ì¥ ë²„íŠ¼
document.getElementById('save-etf-btn').addEventListener('click', async function() {
    if (!currentETFData) {
        return;
    }

    const saveBtn = this;
    const saveResultSpan = document.getElementById('save-etf-result');

    saveBtn.disabled = true;
    saveBtn.textContent = 'ì €ì¥ ì¤‘...';
    saveResultSpan.innerHTML = '<span class="text-muted">ì°¨íŠ¸ ë°ì´í„° ì €ì¥ ì¤‘... (ìµœëŒ€ 30ì´ˆ)</span>';

    try {
        const formData = new FormData();
        formData.append('code', currentETFData.code);
        formData.append('name', currentETFData.name);
        formData.append('current_price', currentETFData.current_price || '');
        formData.append('change_rate', currentETFData.change_rate || '');
        formData.append('nav', currentETFData.nav || '');
        formData.append('market_cap', currentETFData.market_cap || '');
        formData.append('holdings', JSON.stringify(currentETFData.holdings || []));
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        const response = await fetch('{% url "stocks:save_etf" %}', {
            method: 'POST',
            body: formData,
        });

        const data = await response.json();

        if (data.success) {
            const msg = data.created ? 'ê´€ì‹¬ì¢…ëª©ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.';
            saveResultSpan.innerHTML = `<span class="text-success">${msg}</span>`;
        } else {
            saveResultSpan.innerHTML = `<span class="text-danger">${data.error}</span>`;
        }
    } catch (error) {
        saveResultSpan.innerHTML = `<span class="text-danger">ì˜¤ë¥˜: ${error.message}</span>`;
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'ê´€ì‹¬ì¢…ëª© ì €ì¥';
    }
});

// ìŠ¤íŒŒí¬ë¼ì¸ ê·¸ë¦¬ê¸°
function drawSparklines() {
    document.querySelectorAll('.sparkline').forEach(canvas => {
        const ctx = canvas.getContext('2d');
        const values = canvas.dataset.values.split(',').map(Number);
        if (values.length < 2 || values.every(v => v === 0)) return;

        const width = canvas.width;
        const height = canvas.height;
        const min = Math.min(...values);
        const max = Math.max(...values);
        const range = max - min || 1;

        ctx.clearRect(0, 0, width, height);
        ctx.beginPath();
        ctx.strokeStyle = values[values.length - 1] >= values[0] ? '#dc3545' : '#0d6efd';
        ctx.lineWidth = 1.5;

        values.forEach((val, i) => {
            const x = (i / (values.length - 1)) * width;
            const y = height - ((val - min) / range) * (height - 4) - 2;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.stroke();
    });
}
drawSparklines();

// ì‹ í˜¸ ì°¨íŠ¸ íŒì—…
let signalChart = null;
let signalCandleSeries = null;
let signalVolumeSeries = null;
let pendingChartData = null;

function renderSignalChart() {
    if (!pendingChartData) return;

    const { signalDate, signalClose, currentPrice, candleData, volumeData } = pendingChartData;

    // ì‹ í˜¸ ë°œìƒì¼ ë´‰ì„ ê²€ì •ìƒ‰ìœ¼ë¡œ ë³€ê²½
    const styledCandleData = candleData.map(candle => {
        if (candle.time === signalDate) {
            return {
                ...candle,
                color: '#000000',
                borderColor: '#000000',
                wickColor: '#000000',
            };
        }
        return candle;
    });

    const container = document.getElementById('signalChartContainer');
    container.innerHTML = '';

    const containerWidth = container.clientWidth || 750;

    signalChart = LightweightCharts.createChart(container, {
        width: containerWidth,
        height: 400,
        layout: {
            background: { type: 'solid', color: '#ffffff' },
            textColor: '#333',
        },
        grid: {
            vertLines: { color: '#f0f0f0' },
            horzLines: { color: '#f0f0f0' },
        },
        crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
        },
        rightPriceScale: {
            borderColor: '#ddd',
        },
        timeScale: {
            borderColor: '#ddd',
            timeVisible: false,
            rightOffset: 0,
            fixLeftEdge: true,
            fixRightEdge: true,
            lockVisibleTimeRangeOnResize: true,
        },
        handleScroll: {
            mouseWheel: true,
            pressedMouseMove: true,
            horzTouchDrag: true,
            vertTouchDrag: false,
        },
        handleScale: {
            axisPressedMouseMove: true,
            mouseWheel: true,
            pinch: true,
        },
    });

    signalCandleSeries = signalChart.addCandlestickSeries({
        upColor: '#ef5350',
        downColor: '#2196f3',
        borderUpColor: '#ef5350',
        borderDownColor: '#2196f3',
        wickUpColor: '#ef5350',
        wickDownColor: '#2196f3',
    });

    signalCandleSeries.setData(styledCandleData);

    signalVolumeSeries = signalChart.addHistogramSeries({
        priceFormat: {
            type: 'volume',
        },
        priceScaleId: '',
        scaleMargins: {
            top: 0.8,
            bottom: 0,
        },
    });

    signalVolumeSeries.setData(volumeData);

    // ì‹ í˜¸ì¼ ì¢…ê°€ ë¼ì¸
    if (signalClose) {
        signalCandleSeries.createPriceLine({
            price: signalClose,
            color: '#ff9800',
            lineWidth: 1,
            lineStyle: LightweightCharts.LineStyle.Dashed,
            axisLabelVisible: false,
            title: '',
        });
    }

    // í˜„ì¬ê°€ ë¼ì¸
    if (currentPrice) {
        signalCandleSeries.createPriceLine({
            price: currentPrice,
            color: '#2196f3',
            lineWidth: 2,
            lineStyle: LightweightCharts.LineStyle.Dashed,
            axisLabelVisible: false,
            title: '',
        });
    }

    // ì •ë³´ í‘œì‹œ
    const priceChange = signalClose && currentPrice ? ((currentPrice - signalClose) / signalClose * 100).toFixed(1) : 0;
    const legendDiv = document.createElement('div');
    legendDiv.style.cssText = 'position: absolute; top: 10px; left: 10px; z-index: 10; font-size: 12px; background: rgba(255,255,255,0.9); padding: 5px 10px; border-radius: 4px;';
    legendDiv.innerHTML = `<span style="color: #ff9800;">ì‹ í˜¸ì¼ ì¢…ê°€</span> &nbsp; <span style="color: ${priceChange >= 0 ? '#ef5350' : '#2196f3'};">ì–‘ë´‰ëŒ€ë¹„: ${priceChange >= 0 ? '+' : ''}${priceChange}%</span>`;
    container.style.position = 'relative';
    container.appendChild(legendDiv);

    signalChart.timeScale().fitContent();
    pendingChartData = null;
}

document.getElementById('signalChartModal').addEventListener('shown.bs.modal', function() {
    renderSignalChart();
});

document.addEventListener('click', function(e) {
    const btn = e.target.closest('.signal-chart-btn');
    if (!btn) return;

    e.stopPropagation();

    const code = btn.dataset.code;
    const name = btn.dataset.name;
    const signalDate = btn.dataset.signalDate;
    const signalClose = parseFloat(btn.dataset.signalClose) || 0;
    const currentPrice = parseFloat(btn.dataset.currentPrice) || 0;

    document.getElementById('signalChartModalLabel').textContent = `${name} ì‹ í˜¸ ì°¨íŠ¸`;
    document.getElementById('signalChartContainer').innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">ì°¨íŠ¸ ë¡œë”© ì¤‘...</p></div>';

    const modal = new bootstrap.Modal(document.getElementById('signalChartModal'));
    modal.show();

    fetch(`/api/etf/${code}/signal-chart/`)
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                document.getElementById('signalChartContainer').innerHTML = '<div class="text-center py-5 text-muted">ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            pendingChartData = {
                signalDate,
                signalClose,
                currentPrice,
                candleData: data.candle_data,
                volumeData: data.volume_data,
            };

            const modalEl = document.getElementById('signalChartModal');
            if (modalEl.classList.contains('show')) {
                renderSignalChart();
            }
        })
        .catch(err => {
            console.error('ì°¨íŠ¸ ë¡œë“œ ì—ëŸ¬:', err);
            document.getElementById('signalChartContainer').innerHTML = '<div class="text-center py-5 text-danger">ì°¨íŠ¸ ë¡œë“œ ì—ëŸ¬</div>';
        });
});

document.getElementById('signalChartModal').addEventListener('hidden.bs.modal', function() {
    if (signalChart) {
        signalChart.remove();
        signalChart = null;
        signalCandleSeries = null;
        signalVolumeSeries = null;
    }
});

window.addEventListener('resize', function() {
    if (signalChart) {
        const container = document.getElementById('signalChartContainer');
        signalChart.applyOptions({ width: container.clientWidth });
    }
});
</script>
{% endblock %}
