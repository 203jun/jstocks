{% extends 'stocks/base.html' %}
{% load humanize %}

{% block title %}ì„¹í„° - JStocks{% endblock %}

{% block content %}
<h4 class="mb-3">ì„¹í„°</h4>

<!-- KOSPI / KOSDAQ íƒ­ -->
<ul class="nav nav-pills mb-3" id="sectorTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="kospi-tab" data-bs-toggle="pill" data-bs-target="#kospi-content" type="button" role="tab">KOSPI</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="kosdaq-tab" data-bs-toggle="pill" data-bs-target="#kosdaq-content" type="button" role="tab">KOSDAQ</button>
    </li>
</ul>

<div class="tab-content" id="sectorTabsContent">
    <!-- KOSPI -->
    <div class="tab-pane fade show active" id="kospi-content" role="tabpanel">
        <div class="card mb-3">
            <div class="card-header py-2 d-flex align-items-center justify-content-between">
                <div>
                    <strong>ëˆ„ì  ìˆœë§¤ìˆ˜</strong>
                    <small class="text-muted ms-2" id="kospi-chart-name">ì—…ì¢…ì„ ì„ íƒí•˜ì„¸ìš”</small>
                </div>
                <div class="d-flex gap-1">
                    <span class="badge text-bg-warning text-dark" style="font-size: 0.65rem;">ê°œì¸</span>
                    <span class="badge text-bg-success" style="font-size: 0.65rem;">ì™¸êµ­ì¸</span>
                    <span class="badge text-bg-danger" style="font-size: 0.65rem;">ê¸°ê´€</span>
                </div>
            </div>
            <div class="card-body p-2">
                <div id="kospiSectorChart" style="height: 280px;">
                    <div class="d-flex justify-content-center align-items-center h-100 text-muted">ì—…ì¢…ì„ í´ë¦­í•˜ì„¸ìš”</div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header py-2 d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2">
                    <strong>ì—…ì¢…ë³„ ìˆœë§¤ìˆ˜</strong>
                    {% if latest_kospi_date %}<small class="text-muted" id="kospi-date">{{ latest_kospi_date|date:"m.d" }} ê¸°ì¤€</small>{% endif %}
                    <button type="button" class="btn btn-sm btn-refresh-sector" data-market="KOSPI" title="ìƒˆë¡œê³ ì¹¨" style="padding: 0; border: none; background: none; font-size: 1rem; line-height: 1; cursor: pointer;">ğŸ”„</button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0" id="kospiSectorTable">
                        <thead class="table-light sticky-top">
                            <tr class="small">
                                <th class="ps-3">ì—…ì¢…</th>
                                <th class="text-end">ê°œì¸</th>
                                <th class="text-end">ì™¸êµ­ì¸</th>
                                <th class="text-end">ê¸°ê´€</th>
                                <th class="text-end">ì¦ê¶Œ</th>
                                <th class="text-end">ë³´í—˜</th>
                                <th class="text-end">íˆ¬ì‹ </th>
                                <th class="text-end">ì€í–‰</th>
                                <th class="text-end">ì—°ê¸°ê¸ˆ</th>
                                <th class="text-end">ì‚¬ëª¨</th>
                                <th class="text-end pe-3">ê¸°íƒ€ë²•ì¸</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in kospi_sectors %}
                            <tr class="small sector-row" data-code="{{ s.code }}" data-market="KOSPI" data-name="{{ s.name }}" style="cursor: pointer;">
                                <td class="ps-3">{{ s.name }}</td>
                                <td class="text-end {% if s.individual_net_buying > 0 %}text-up{% elif s.individual_net_buying < 0 %}text-down{% endif %}">{{ s.individual_net_buying|intcomma }}</td>
                                <td class="text-end {% if s.foreign_net_buying > 0 %}text-up{% elif s.foreign_net_buying < 0 %}text-down{% endif %}">{{ s.foreign_net_buying|intcomma }}</td>
                                <td class="text-end {% if s.institution_net_buying > 0 %}text-up{% elif s.institution_net_buying < 0 %}text-down{% endif %}">{{ s.institution_net_buying|intcomma }}</td>
                                <td class="text-end {% if s.securities_net_buying > 0 %}text-up{% elif s.securities_net_buying < 0 %}text-down{% endif %}">{{ s.securities_net_buying|intcomma }}</td>
                                <td class="text-end {% if s.insurance_net_buying > 0 %}text-up{% elif s.insurance_net_buying < 0 %}text-down{% endif %}">{{ s.insurance_net_buying|intcomma }}</td>
                                <td class="text-end {% if s.investment_trust_net_buying > 0 %}text-up{% elif s.investment_trust_net_buying < 0 %}text-down{% endif %}">{{ s.investment_trust_net_buying|intcomma }}</td>
                                <td class="text-end {% if s.bank_net_buying > 0 %}text-up{% elif s.bank_net_buying < 0 %}text-down{% endif %}">{{ s.bank_net_buying|intcomma }}</td>
                                <td class="text-end {% if s.pension_fund_net_buying > 0 %}text-up{% elif s.pension_fund_net_buying < 0 %}text-down{% endif %}">{{ s.pension_fund_net_buying|intcomma }}</td>
                                <td class="text-end {% if s.private_fund_net_buying > 0 %}text-up{% elif s.private_fund_net_buying < 0 %}text-down{% endif %}">{{ s.private_fund_net_buying|intcomma }}</td>
                                <td class="text-end pe-3 {% if s.other_corporation_net_buying > 0 %}text-up{% elif s.other_corporation_net_buying < 0 %}text-down{% endif %}">{{ s.other_corporation_net_buying|intcomma }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="11" class="text-center text-muted py-3">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- KOSDAQ -->
    <div class="tab-pane fade" id="kosdaq-content" role="tabpanel">
        <div class="card mb-3">
            <div class="card-header py-2 d-flex align-items-center justify-content-between">
                <div>
                    <strong>ëˆ„ì  ìˆœë§¤ìˆ˜</strong>
                    <small class="text-muted ms-2" id="kosdaq-chart-name">ì—…ì¢…ì„ ì„ íƒí•˜ì„¸ìš”</small>
                </div>
                <div class="d-flex gap-1">
                    <span class="badge text-bg-warning text-dark" style="font-size: 0.65rem;">ê°œì¸</span>
                    <span class="badge text-bg-success" style="font-size: 0.65rem;">ì™¸êµ­ì¸</span>
                    <span class="badge text-bg-danger" style="font-size: 0.65rem;">ê¸°ê´€</span>
                </div>
            </div>
            <div class="card-body p-2">
                <div id="kosdaqSectorChart" style="height: 280px;">
                    <div class="d-flex justify-content-center align-items-center h-100 text-muted">ì—…ì¢…ì„ í´ë¦­í•˜ì„¸ìš”</div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header py-2 d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2">
                    <strong>ì—…ì¢…ë³„ ìˆœë§¤ìˆ˜</strong>
                    {% if latest_kosdaq_date %}<small class="text-muted" id="kosdaq-date">{{ latest_kosdaq_date|date:"m.d" }} ê¸°ì¤€</small>{% endif %}
                    <button type="button" class="btn btn-sm btn-refresh-sector" data-market="KOSDAQ" title="ìƒˆë¡œê³ ì¹¨" style="padding: 0; border: none; background: none; font-size: 1rem; line-height: 1; cursor: pointer;">ğŸ”„</button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0" id="kosdaqSectorTable">
                        <thead class="table-light sticky-top">
                            <tr class="small">
                                <th class="ps-3">ì—…ì¢…</th>
                                <th class="text-end">ê°œì¸</th>
                                <th class="text-end">ì™¸êµ­ì¸</th>
                                <th class="text-end">ê¸°ê´€</th>
                                <th class="text-end">ì¦ê¶Œ</th>
                                <th class="text-end">ë³´í—˜</th>
                                <th class="text-end">íˆ¬ì‹ </th>
                                <th class="text-end">ì€í–‰</th>
                                <th class="text-end">ì—°ê¸°ê¸ˆ</th>
                                <th class="text-end">ì‚¬ëª¨</th>
                                <th class="text-end pe-3">ê¸°íƒ€ë²•ì¸</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in kosdaq_sectors %}
                            <tr class="small sector-row" data-code="{{ s.code }}" data-market="KOSDAQ" data-name="{{ s.name }}" style="cursor: pointer;">
                                <td class="ps-3">{{ s.name }}</td>
                                <td class="text-end {% if s.individual_net_buying > 0 %}text-up{% elif s.individual_net_buying < 0 %}text-down{% endif %}">{{ s.individual_net_buying|intcomma }}</td>
                                <td class="text-end {% if s.foreign_net_buying > 0 %}text-up{% elif s.foreign_net_buying < 0 %}text-down{% endif %}">{{ s.foreign_net_buying|intcomma }}</td>
                                <td class="text-end {% if s.institution_net_buying > 0 %}text-up{% elif s.institution_net_buying < 0 %}text-down{% endif %}">{{ s.institution_net_buying|intcomma }}</td>
                                <td class="text-end {% if s.securities_net_buying > 0 %}text-up{% elif s.securities_net_buying < 0 %}text-down{% endif %}">{{ s.securities_net_buying|intcomma }}</td>
                                <td class="text-end {% if s.insurance_net_buying > 0 %}text-up{% elif s.insurance_net_buying < 0 %}text-down{% endif %}">{{ s.insurance_net_buying|intcomma }}</td>
                                <td class="text-end {% if s.investment_trust_net_buying > 0 %}text-up{% elif s.investment_trust_net_buying < 0 %}text-down{% endif %}">{{ s.investment_trust_net_buying|intcomma }}</td>
                                <td class="text-end {% if s.bank_net_buying > 0 %}text-up{% elif s.bank_net_buying < 0 %}text-down{% endif %}">{{ s.bank_net_buying|intcomma }}</td>
                                <td class="text-end {% if s.pension_fund_net_buying > 0 %}text-up{% elif s.pension_fund_net_buying < 0 %}text-down{% endif %}">{{ s.pension_fund_net_buying|intcomma }}</td>
                                <td class="text-end {% if s.private_fund_net_buying > 0 %}text-up{% elif s.private_fund_net_buying < 0 %}text-down{% endif %}">{{ s.private_fund_net_buying|intcomma }}</td>
                                <td class="text-end pe-3 {% if s.other_corporation_net_buying > 0 %}text-up{% elif s.other_corporation_net_buying < 0 %}text-down{% endif %}">{{ s.other_corporation_net_buying|intcomma }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="11" class="text-center text-muted py-3">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const kospiChartData = {{ kospi_chart_data|safe }};
const kosdaqChartData = {{ kosdaq_chart_data|safe }};

let kospiChart = null;
let kosdaqChart = null;

function createSectorChart(containerId, sectorData) {
    const container = document.getElementById(containerId);
    if (!container || !sectorData || sectorData.data.length === 0) return null;

    container.innerHTML = `<canvas id="${containerId}Canvas"></canvas>`;
    const ctx = document.getElementById(`${containerId}Canvas`);
    const data = sectorData.data;

    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d.date),
            datasets: [
                { label: 'ê°œì¸', data: data.map(d => d.individual), borderColor: '#ffc107', borderWidth: 2, tension: 0.3, pointRadius: 2, fill: false },
                { label: 'ì™¸êµ­ì¸', data: data.map(d => d.foreign), borderColor: '#198754', borderWidth: 2, tension: 0.3, pointRadius: 2, fill: false },
                { label: 'ê¸°ê´€', data: data.map(d => d.institution), borderColor: '#dc3545', borderWidth: 2, tension: 0.3, pointRadius: 2, fill: false }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.raw.toLocaleString('ko-KR') }}
            },
            scales: {
                x: { grid: { display: false }, ticks: { maxTicksLimit: 10 }},
                y: { ticks: { callback: v => Math.abs(v) >= 100000000 ? (v/100000000).toFixed(1)+'ì–µ' : Math.abs(v) >= 10000 ? (v/10000).toFixed(1)+'ë§Œ' : v.toFixed(0) }, grid: { color: '#f0f0f0' }}
            }
        }
    });
}

document.querySelectorAll('.sector-row').forEach(row => {
    row.addEventListener('click', function() {
        const code = this.dataset.code;
        const market = this.dataset.market;
        const name = this.dataset.name;

        this.closest('tbody').querySelectorAll('tr').forEach(tr => tr.classList.remove('table-active'));
        this.classList.add('table-active');

        const chartData = market === 'KOSPI' ? kospiChartData : kosdaqChartData;
        const sectorData = chartData[code];
        if (!sectorData || sectorData.data.length === 0) return;

        const chartId = market === 'KOSPI' ? 'kospiSectorChart' : 'kosdaqSectorChart';
        const nameId = market === 'KOSPI' ? 'kospi-chart-name' : 'kosdaq-chart-name';

        document.getElementById(nameId).textContent = name;

        if (market === 'KOSPI' && kospiChart) kospiChart.destroy();
        else if (market === 'KOSDAQ' && kosdaqChart) kosdaqChart.destroy();

        const newChart = createSectorChart(chartId, sectorData);
        if (market === 'KOSPI') kospiChart = newChart;
        else kosdaqChart = newChart;
    });
});

// ì—…ì¢…ë³„ ìˆœë§¤ìˆ˜ ìƒˆë¡œê³ ì¹¨
document.querySelectorAll('.btn-refresh-sector').forEach(btn => {
    btn.addEventListener('click', async function() {
        const market = this.dataset.market;

        this.disabled = true;
        this.classList.add('spin');

        try {
            const response = await fetch(`/api/sector/${market}/refresh/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                }
            });
            const data = await response.json();

            if (data.success) {
                updateSectorTable(market, data.table_data);
                // ë‚ ì§œ ì—…ë°ì´íŠ¸
                const dateEl = document.getElementById(`${market.toLowerCase()}-date`);
                if (dateEl) dateEl.textContent = data.date + ' ê¸°ì¤€';
            } else {
                alert(data.error || 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
            }
        } catch (err) {
            alert('ì˜¤ë¥˜: ' + err.message);
        } finally {
            this.disabled = false;
            this.classList.remove('spin');
        }
    });
});

function updateSectorTable(market, tableData) {
    const tableId = `${market.toLowerCase()}SectorTable`;
    const table = document.getElementById(tableId);
    if (!table) return;

    const tbody = table.querySelector('tbody');
    if (!tbody) return;

    function formatNumber(num) {
        return new Intl.NumberFormat('ko-KR').format(num);
    }

    function getColorClass(value) {
        if (value > 0) return 'text-up';
        if (value < 0) return 'text-down';
        return '';
    }

    tbody.innerHTML = tableData.map(s => `
        <tr class="small sector-row" data-code="${s.code}" data-market="${market}" data-name="${s.name}" style="cursor: pointer;">
            <td class="ps-3">${s.name}</td>
            <td class="text-end ${getColorClass(s.individual_net_buying)}">${formatNumber(s.individual_net_buying)}</td>
            <td class="text-end ${getColorClass(s.foreign_net_buying)}">${formatNumber(s.foreign_net_buying)}</td>
            <td class="text-end ${getColorClass(s.institution_net_buying)}">${formatNumber(s.institution_net_buying)}</td>
            <td class="text-end ${getColorClass(s.securities_net_buying)}">${formatNumber(s.securities_net_buying)}</td>
            <td class="text-end ${getColorClass(s.insurance_net_buying)}">${formatNumber(s.insurance_net_buying)}</td>
            <td class="text-end ${getColorClass(s.investment_trust_net_buying)}">${formatNumber(s.investment_trust_net_buying)}</td>
            <td class="text-end ${getColorClass(s.bank_net_buying)}">${formatNumber(s.bank_net_buying)}</td>
            <td class="text-end ${getColorClass(s.pension_fund_net_buying)}">${formatNumber(s.pension_fund_net_buying)}</td>
            <td class="text-end ${getColorClass(s.private_fund_net_buying)}">${formatNumber(s.private_fund_net_buying)}</td>
            <td class="text-end pe-3 ${getColorClass(s.other_corporation_net_buying)}">${formatNumber(s.other_corporation_net_buying)}</td>
        </tr>
    `).join('');

    // ìƒˆë¡œ ì¶”ê°€ëœ í–‰ì— í´ë¦­ ì´ë²¤íŠ¸ ë‹¤ì‹œ ë°”ì¸ë”©
    tbody.querySelectorAll('.sector-row').forEach(row => {
        row.addEventListener('click', function() {
            const code = this.dataset.code;
            const market = this.dataset.market;
            const name = this.dataset.name;

            this.closest('tbody').querySelectorAll('tr').forEach(tr => tr.classList.remove('table-active'));
            this.classList.add('table-active');

            const chartData = market === 'KOSPI' ? kospiChartData : kosdaqChartData;
            const sectorData = chartData[code];
            if (!sectorData || sectorData.data.length === 0) return;

            const chartId = market === 'KOSPI' ? 'kospiSectorChart' : 'kosdaqSectorChart';
            const nameId = market === 'KOSPI' ? 'kospi-chart-name' : 'kosdaq-chart-name';

            document.getElementById(nameId).textContent = name;

            if (market === 'KOSPI' && kospiChart) kospiChart.destroy();
            else if (market === 'KOSDAQ' && kosdaqChart) kosdaqChart.destroy();

            const newChart = createSectorChart(chartId, sectorData);
            if (market === 'KOSPI') kospiChart = newChart;
            else kosdaqChart = newChart;
        });
    });
}
</script>
<style>
.btn-refresh-sector.spin {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}
