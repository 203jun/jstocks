{% extends 'stocks/base.html' %}
{% load humanize %}

{% block title %}ì¢…ëª© - JStocks{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">ì¢…ëª©</h4>
    <a href="{% url 'stocks:stock_list' %}" class="btn btn-outline-primary btn-sm">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search me-1" viewBox="0 0 16 16">
            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
        </svg>
        ì¢…ëª© ê²€ìƒ‰
    </a>
</div>

<!-- ëŒ€ì‹œë³´ë“œ ì¹´ë“œ -->
<div class="row mb-4">
    <!-- ì¹´ë“œ A: ì¥ê¸° ê¸‰ë“± (60ì¼ ì‹ ê³ ê±°ë˜ëŸ‰) -->
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>ğŸ¥‡ ì¥ê¸° ê¸‰ë“±</strong>
                <small class="text-muted d-block">60ì¼ ì‹ ê³ ê±°ë˜ëŸ‰</small>
            </div>
            {% if card_a_stocks %}
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0 dashboard-table">
                        <thead class="table-light">
                            <tr>
                                <th class="px-3">ì¢…ëª©ëª…</th>
                                <th class="text-end px-3">ë“±ë½ìœ¨</th>
                                <th class="text-end px-3">ê³ ì ëŒ€ë¹„</th>
                                <th class="text-end px-3">ê±°ë˜ëŒ€ê¸ˆ</th>
                                <th class="text-end px-3">10ì¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in card_a_stocks %}
                            <tr onclick="location.href='{% url 'stocks:stock_detail' item.stock.code %}'" style="cursor:pointer;">
                                <td class="px-3 py-2">
                                    <strong class="small {% if item.above_ma120 %}text-danger{% endif %}">{{ item.stock.name }}</strong>
                                </td>
                                <td class="text-end px-3 py-2 {% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %}">
                                    {% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%
                                </td>
                                <td class="text-end px-3 py-2 small {% if item.high_position >= -15 %}text-danger fw-bold{% elif item.high_position <= -40 %}text-secondary{% endif %}">{{ item.high_position }}%{% if item.high_position >= -15 %} ğŸš€{% elif item.high_position <= -40 %} â™»ï¸{% endif %}</td>
                                <td class="text-end px-3 py-2 small">{{ item.trading_value|intcomma }}ì–µ</td>
                                <td class="text-end px-3 py-2"><canvas class="sparkline" data-values="{{ item.sparkline|join:',' }}" width="60" height="20"></canvas></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
            <div class="card-body text-center text-muted py-4">
                <small>í•´ë‹¹ ì¢…ëª© ì—†ìŒ</small>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ì¹´ë“œ B: ë‹¨ê¸° ê¸‰ë“± (20ì¼ ì‹ ê³ ê±°ë˜ëŸ‰) -->
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>ğŸ¥ˆ ë‹¨ê¸° ê¸‰ë“±</strong>
                <small class="text-muted d-block">20ì¼ ì‹ ê³ ê±°ë˜ëŸ‰</small>
            </div>
            {% if card_b_stocks %}
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0 dashboard-table">
                        <thead class="table-light">
                            <tr>
                                <th class="px-3">ì¢…ëª©ëª…</th>
                                <th class="text-end px-3">ë“±ë½ìœ¨</th>
                                <th class="text-end px-3">ê³ ì ëŒ€ë¹„</th>
                                <th class="text-end px-3">ê±°ë˜ëŒ€ê¸ˆ</th>
                                <th class="text-end px-3">10ì¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in card_b_stocks %}
                            <tr onclick="location.href='{% url 'stocks:stock_detail' item.stock.code %}'" style="cursor:pointer;">
                                <td class="px-3 py-2">
                                    <strong class="small {% if item.above_ma120 %}text-danger{% endif %}">{{ item.stock.name }}</strong>
                                </td>
                                <td class="text-end px-3 py-2 {% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %}">
                                    {% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%
                                </td>
                                <td class="text-end px-3 py-2 small {% if item.high_position >= -15 %}text-danger fw-bold{% elif item.high_position <= -40 %}text-secondary{% endif %}">{{ item.high_position }}%{% if item.high_position >= -15 %} ğŸš€{% elif item.high_position <= -40 %} â™»ï¸{% endif %}</td>
                                <td class="text-end px-3 py-2 small">{{ item.trading_value|intcomma }}ì–µ</td>
                                <td class="text-end px-3 py-2"><canvas class="sparkline" data-values="{{ item.sparkline|join:',' }}" width="60" height="20"></canvas></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
            <div class="card-body text-center text-muted py-4">
                <small>í•´ë‹¹ ì¢…ëª© ì—†ìŒ</small>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ì¹´ë“œ D: ì´í‰ì„  ì¤ì¤ -->
    <div class="col-12 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>ğŸ§² ì´í‰ì„  ì¤ì¤</strong>
                <small class="text-muted d-block">ì¡°ìš©í•œ ì§€ì§€</small>
            </div>
            {% if card_d_stocks %}
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0 dashboard-table">
                        <thead class="table-light">
                            <tr>
                                <th class="px-3">ì¢…ëª©ëª…</th>
                                <th class="text-center px-3">ì§€ì§€</th>
                                <th class="text-end px-3">ë“±ë½ìœ¨</th>
                                <th class="text-end px-3">ê³ ì ëŒ€ë¹„</th>
                                <th class="text-end px-3">ê±°ë˜ëŒ€ê¸ˆ</th>
                                <th class="text-end px-3">10ì¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in card_d_stocks %}
                            <tr onclick="location.href='{% url 'stocks:stock_detail' item.stock.code %}'" style="cursor:pointer;">
                                <td class="px-3 py-2">
                                    <strong class="small {% if item.above_ma120 %}text-danger{% endif %}">{{ item.stock.name }}</strong>
                                    {% if item.has_tail_badge %}<span class="ms-1" title="ê¼¬ë¦¬ ì§€ì§€">ğŸ“</span>{% endif %}
                                </td>
                                <td class="text-center px-3 py-2"><span class="badge {% if item.support_type == 'MA20' %}bg-success{% else %}bg-info{% endif %}">{{ item.support_type }}</span></td>
                                <td class="text-end px-3 py-2 {% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %}">
                                    {% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%
                                </td>
                                <td class="text-end px-3 py-2 small {% if item.high_position >= -15 %}text-danger fw-bold{% elif item.high_position <= -40 %}text-secondary{% endif %}">{{ item.high_position }}%{% if item.high_position >= -15 %} ğŸš€{% elif item.high_position <= -40 %} â™»ï¸{% endif %}</td>
                                <td class="text-end px-3 py-2 small">{{ item.trading_value|intcomma }}ì–µ</td>
                                <td class="text-end px-3 py-2"><canvas class="sparkline" data-values="{{ item.sparkline|join:',' }}" width="60" height="20"></canvas></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
            <div class="card-body text-center text-muted py-4">
                <small>í•´ë‹¹ ì¢…ëª© ì—†ìŒ</small>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ì¹´ë“œ C: ì‹ í˜¸ ì¶”ì  -->
    <div class="col-12 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>ğŸ“¡ ì‹ í˜¸ ì¶”ì </strong>
                <small class="text-muted d-block">ìµœê·¼ 5ì¼ ë‚´ ì¡°ê±´ ì¶©ì¡±</small>
            </div>
            {% if card_c_stocks %}
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for item in card_c_stocks %}
                    <a href="{% url 'stocks:stock_detail' item.stock.code %}" class="list-group-item list-group-item-action py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong class="small">{{ item.stock.name }}</strong>
                                <span class="badge bg-warning text-dark ms-1" style="font-size: 0.65rem;">{{ item.signal_type }} / {{ item.signal_days_ago }}ì¼ì „</span>
                            </div>
                            <span class="badge {% if item.change_rate > 0 %}bg-danger{% elif item.change_rate < 0 %}bg-primary{% else %}bg-secondary{% endif %}">
                                {% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%
                            </span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-1">
                            <small class="text-muted">ê³ ì ëŒ€ë¹„ {{ item.high_position }}%</small>
                            <canvas class="sparkline" data-values="{{ item.sparkline|join:',' }}" width="60" height="20"></canvas>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="card-body text-center text-muted py-4">
                <small>í•´ë‹¹ ì¢…ëª© ì—†ìŒ</small>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ê´€ì‹¬ë‹¨ê³„ íƒ­ -->
<ul class="nav nav-pills mb-3" id="interestTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="super-tab" data-bs-toggle="pill" data-bs-target="#super-content" type="button" role="tab">
            ì´ˆê´€ì‹¬ <span class="badge bg-secondary">{{ super_stocks|length }}</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="normal-tab" data-bs-toggle="pill" data-bs-target="#normal-content" type="button" role="tab">
            ê´€ì‹¬ <span class="badge bg-secondary">{{ normal_stocks|length }}</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="incubator-tab" data-bs-toggle="pill" data-bs-target="#incubator-content" type="button" role="tab">
            ì¸íë² ì´í„° <span class="badge bg-secondary">{{ incubator_stocks|length }}</span>
        </button>
    </li>
</ul>

<div class="tab-content" id="interestTabsContent">
    <!-- ì´ˆê´€ì‹¬ -->
    <div class="tab-pane fade show active" id="super-content" role="tabpanel">
        {% if super_stocks %}
        <div class="table-responsive">
            <table class="table table-hover stock-table mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ì¢…ëª©ëª…</th>
                        <th class="hide-mobile">ëŒ€ë¶„ë¥˜</th>
                        <th class="hide-mobile">ì†Œë¶„ë¥˜</th>
                        <th class="text-end">í˜„ì¬ê°€</th>
                        <th class="text-end">ë“±ë½ìœ¨</th>
                        <th class="text-end hide-mobile">ì‹œê°€ì´ì•¡</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock in super_stocks %}
                    <tr onclick="location.href='{% url 'stocks:stock_detail' stock.code %}'" style="cursor:pointer;">
                        <td>
                            <strong>{{ stock.name }}</strong>
                            <small class="text-muted ms-1">{{ stock.code }}</small>
                        </td>
                        <td class="hide-mobile small text-muted">{% for theme in stock.themes.all %}{% if forloop.first %}{{ theme.category.name }}{% endif %}{% empty %}-{% endfor %}</td>
                        <td class="hide-mobile small">{% for theme in stock.themes.all %}{{ theme.name }}{% if not forloop.last %}, {% endif %}{% empty %}-{% endfor %}</td>
                        <td class="text-end">{% if stock.current_price %}{{ stock.current_price|intcomma }}{% else %}-{% endif %}</td>
                        <td class="text-end {% if stock.change_rate > 0 %}text-up{% elif stock.change_rate < 0 %}text-down{% endif %}">
                            {% if stock.change_rate %}{% if stock.change_rate > 0 %}+{% endif %}{{ stock.change_rate }}%{% else %}-{% endif %}
                        </td>
                        <td class="text-end hide-mobile">{% if stock.market_cap %}{{ stock.market_cap|intcomma }}ì–µ{% else %}-{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center text-muted py-4">ë“±ë¡ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
        {% endif %}
    </div>

    <!-- ê´€ì‹¬ -->
    <div class="tab-pane fade" id="normal-content" role="tabpanel">
        {% if normal_stocks %}
        <div class="table-responsive">
            <table class="table table-hover stock-table mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ì¢…ëª©ëª…</th>
                        <th class="hide-mobile">ëŒ€ë¶„ë¥˜</th>
                        <th class="hide-mobile">ì†Œë¶„ë¥˜</th>
                        <th class="text-end">í˜„ì¬ê°€</th>
                        <th class="text-end">ë“±ë½ìœ¨</th>
                        <th class="text-end hide-mobile">ì‹œê°€ì´ì•¡</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock in normal_stocks %}
                    <tr onclick="location.href='{% url 'stocks:stock_detail' stock.code %}'" style="cursor:pointer;">
                        <td>
                            <strong>{{ stock.name }}</strong>
                            <small class="text-muted ms-1">{{ stock.code }}</small>
                        </td>
                        <td class="hide-mobile small text-muted">{% for theme in stock.themes.all %}{% if forloop.first %}{{ theme.category.name }}{% endif %}{% empty %}-{% endfor %}</td>
                        <td class="hide-mobile small">{% for theme in stock.themes.all %}{{ theme.name }}{% if not forloop.last %}, {% endif %}{% empty %}-{% endfor %}</td>
                        <td class="text-end">{% if stock.current_price %}{{ stock.current_price|intcomma }}{% else %}-{% endif %}</td>
                        <td class="text-end {% if stock.change_rate > 0 %}text-up{% elif stock.change_rate < 0 %}text-down{% endif %}">
                            {% if stock.change_rate %}{% if stock.change_rate > 0 %}+{% endif %}{{ stock.change_rate }}%{% else %}-{% endif %}
                        </td>
                        <td class="text-end hide-mobile">{% if stock.market_cap %}{{ stock.market_cap|intcomma }}ì–µ{% else %}-{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center text-muted py-4">ë“±ë¡ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
        {% endif %}
    </div>

    <!-- ì¸íë² ì´í„° -->
    <div class="tab-pane fade" id="incubator-content" role="tabpanel">
        {% if incubator_stocks %}
        <div class="table-responsive">
            <table class="table table-hover stock-table mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ì¢…ëª©ëª…</th>
                        <th class="hide-mobile">ëŒ€ë¶„ë¥˜</th>
                        <th class="hide-mobile">ì†Œë¶„ë¥˜</th>
                        <th class="text-end">í˜„ì¬ê°€</th>
                        <th class="text-end">ë“±ë½ìœ¨</th>
                        <th class="text-end hide-mobile">ì‹œê°€ì´ì•¡</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock in incubator_stocks %}
                    <tr onclick="location.href='{% url 'stocks:stock_detail' stock.code %}'" style="cursor:pointer;">
                        <td>
                            <strong>{{ stock.name }}</strong>
                            <small class="text-muted ms-1">{{ stock.code }}</small>
                        </td>
                        <td class="hide-mobile small text-muted">{% for theme in stock.themes.all %}{% if forloop.first %}{{ theme.category.name }}{% endif %}{% empty %}-{% endfor %}</td>
                        <td class="hide-mobile small">{% for theme in stock.themes.all %}{{ theme.name }}{% if not forloop.last %}, {% endif %}{% empty %}-{% endfor %}</td>
                        <td class="text-end">{% if stock.current_price %}{{ stock.current_price|intcomma }}{% else %}-{% endif %}</td>
                        <td class="text-end {% if stock.change_rate > 0 %}text-up{% elif stock.change_rate < 0 %}text-down{% endif %}">
                            {% if stock.change_rate %}{% if stock.change_rate > 0 %}+{% endif %}{{ stock.change_rate }}%{% else %}-{% endif %}
                        </td>
                        <td class="text-end hide-mobile">{% if stock.market_cap %}{{ stock.market_cap|intcomma }}ì–µ{% else %}-{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center text-muted py-4">ë“±ë¡ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ìŠ¤íŒŒí¬ë¼ì¸ ê·¸ë¦¬ê¸°
document.querySelectorAll('.sparkline').forEach(canvas => {
    const values = canvas.dataset.values.split(',').map(Number);
    if (values.length < 2) return;

    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;

    const min = Math.min(...values);
    const max = Math.max(...values);
    const range = max - min || 1;

    // ì‹œì‘ì ê³¼ ëì  ë¹„êµí•´ì„œ ìƒ‰ìƒ ê²°ì •
    const color = values[values.length - 1] >= values[0] ? '#ef5350' : '#2196f3';

    ctx.strokeStyle = color;
    ctx.lineWidth = 1.5;
    ctx.beginPath();

    values.forEach((val, i) => {
        const x = (i / (values.length - 1)) * width;
        const y = height - ((val - min) / range) * (height - 4) - 2;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });

    ctx.stroke();
});
</script>
{% endblock %}
