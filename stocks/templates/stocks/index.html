{% extends 'stocks/base.html' %}
{% load humanize %}

{% block title %}종목 - JStocks{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">종목</h4>
    <a href="{% url 'stocks:stock_list' %}" class="btn btn-outline-primary btn-sm">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search me-1" viewBox="0 0 16 16">
            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
        </svg>
        종목 검색
    </a>
</div>

<!-- 40일 최대 거래량 대시보드 -->
<div class="card mb-4">
    <div class="card-header py-2">
        <strong>40일 최대 거래량</strong>
        <small class="text-muted ms-2">관심종목 중 마지막 거래일 기준</small>
    </div>
    {% if volume_alert_stocks %}
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-3">종목명</th>
                        <th class="text-end">종가변화</th>
                        <th class="text-end pe-3">거래량 증가</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in volume_alert_stocks %}
                    <tr onclick="location.href='{% url 'stocks:stock_detail' item.stock.code %}'" style="cursor:pointer;">
                        <td class="ps-3">
                            <strong>{{ item.stock.name }}</strong>
                            <small class="text-muted ms-1">{{ item.stock.code }}</small>
                        </td>
                        <td class="text-end {% if item.price_change > 0 %}text-up{% elif item.price_change < 0 %}text-down{% endif %}">
                            {% if item.price_change > 0 %}+{% endif %}{{ item.price_change_rate }}%
                        </td>
                        <td class="text-end pe-3">
                            <span class="text-success fw-bold">+{{ item.volume_change }}%</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="card-body text-center text-muted py-3">
        해당 종목이 없습니다.
    </div>
    {% endif %}
</div>

<!-- 관심단계 탭 -->
<ul class="nav nav-pills mb-3" id="interestTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="super-tab" data-bs-toggle="pill" data-bs-target="#super-content" type="button" role="tab">
            초관심 <span class="badge bg-secondary">{{ super_stocks|length }}</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="normal-tab" data-bs-toggle="pill" data-bs-target="#normal-content" type="button" role="tab">
            관심 <span class="badge bg-secondary">{{ normal_stocks|length }}</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="incubator-tab" data-bs-toggle="pill" data-bs-target="#incubator-content" type="button" role="tab">
            인큐베이터 <span class="badge bg-secondary">{{ incubator_stocks|length }}</span>
        </button>
    </li>
</ul>

<div class="tab-content" id="interestTabsContent">
    <!-- 초관심 -->
    <div class="tab-pane fade show active" id="super-content" role="tabpanel">
        {% if super_stocks %}
        <div class="table-responsive">
            <table class="table table-hover stock-table mb-0">
                <thead class="table-light">
                    <tr>
                        <th>종목명</th>
                        <th class="hide-mobile">대분류</th>
                        <th class="hide-mobile">소분류</th>
                        <th class="text-end">현재가</th>
                        <th class="text-end">등락율</th>
                        <th class="text-end hide-mobile">시가총액</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock in super_stocks %}
                    <tr onclick="location.href='{% url 'stocks:stock_detail' stock.code %}'" style="cursor:pointer;">
                        <td>
                            <strong>{{ stock.name }}</strong>
                            <small class="text-muted ms-1">{{ stock.code }}</small>
                        </td>
                        <td class="hide-mobile small text-muted">{% for theme in stock.themes.all %}{% if forloop.first %}{{ theme.category.name }}{% endif %}{% empty %}-{% endfor %}</td>
                        <td class="hide-mobile small">{% for theme in stock.themes.all %}{{ theme.name }}{% if not forloop.last %}, {% endif %}{% empty %}-{% endfor %}</td>
                        <td class="text-end">{% if stock.current_price %}{{ stock.current_price|intcomma }}{% else %}-{% endif %}</td>
                        <td class="text-end {% if stock.change_rate > 0 %}text-up{% elif stock.change_rate < 0 %}text-down{% endif %}">
                            {% if stock.change_rate %}{% if stock.change_rate > 0 %}+{% endif %}{{ stock.change_rate }}%{% else %}-{% endif %}
                        </td>
                        <td class="text-end hide-mobile">{% if stock.market_cap %}{{ stock.market_cap|intcomma }}억{% else %}-{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center text-muted py-4">등록된 종목이 없습니다.</div>
        </div>
        {% endif %}
    </div>

    <!-- 관심 -->
    <div class="tab-pane fade" id="normal-content" role="tabpanel">
        {% if normal_stocks %}
        <div class="table-responsive">
            <table class="table table-hover stock-table mb-0">
                <thead class="table-light">
                    <tr>
                        <th>종목명</th>
                        <th class="hide-mobile">대분류</th>
                        <th class="hide-mobile">소분류</th>
                        <th class="text-end">현재가</th>
                        <th class="text-end">등락율</th>
                        <th class="text-end hide-mobile">시가총액</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock in normal_stocks %}
                    <tr onclick="location.href='{% url 'stocks:stock_detail' stock.code %}'" style="cursor:pointer;">
                        <td>
                            <strong>{{ stock.name }}</strong>
                            <small class="text-muted ms-1">{{ stock.code }}</small>
                        </td>
                        <td class="hide-mobile small text-muted">{% for theme in stock.themes.all %}{% if forloop.first %}{{ theme.category.name }}{% endif %}{% empty %}-{% endfor %}</td>
                        <td class="hide-mobile small">{% for theme in stock.themes.all %}{{ theme.name }}{% if not forloop.last %}, {% endif %}{% empty %}-{% endfor %}</td>
                        <td class="text-end">{% if stock.current_price %}{{ stock.current_price|intcomma }}{% else %}-{% endif %}</td>
                        <td class="text-end {% if stock.change_rate > 0 %}text-up{% elif stock.change_rate < 0 %}text-down{% endif %}">
                            {% if stock.change_rate %}{% if stock.change_rate > 0 %}+{% endif %}{{ stock.change_rate }}%{% else %}-{% endif %}
                        </td>
                        <td class="text-end hide-mobile">{% if stock.market_cap %}{{ stock.market_cap|intcomma }}억{% else %}-{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center text-muted py-4">등록된 종목이 없습니다.</div>
        </div>
        {% endif %}
    </div>

    <!-- 인큐베이터 -->
    <div class="tab-pane fade" id="incubator-content" role="tabpanel">
        {% if incubator_stocks %}
        <div class="table-responsive">
            <table class="table table-hover stock-table mb-0">
                <thead class="table-light">
                    <tr>
                        <th>종목명</th>
                        <th class="hide-mobile">대분류</th>
                        <th class="hide-mobile">소분류</th>
                        <th class="text-end">현재가</th>
                        <th class="text-end">등락율</th>
                        <th class="text-end hide-mobile">시가총액</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock in incubator_stocks %}
                    <tr onclick="location.href='{% url 'stocks:stock_detail' stock.code %}'" style="cursor:pointer;">
                        <td>
                            <strong>{{ stock.name }}</strong>
                            <small class="text-muted ms-1">{{ stock.code }}</small>
                        </td>
                        <td class="hide-mobile small text-muted">{% for theme in stock.themes.all %}{% if forloop.first %}{{ theme.category.name }}{% endif %}{% empty %}-{% endfor %}</td>
                        <td class="hide-mobile small">{% for theme in stock.themes.all %}{{ theme.name }}{% if not forloop.last %}, {% endif %}{% empty %}-{% endfor %}</td>
                        <td class="text-end">{% if stock.current_price %}{{ stock.current_price|intcomma }}{% else %}-{% endif %}</td>
                        <td class="text-end {% if stock.change_rate > 0 %}text-up{% elif stock.change_rate < 0 %}text-down{% endif %}">
                            {% if stock.change_rate %}{% if stock.change_rate > 0 %}+{% endif %}{{ stock.change_rate }}%{% else %}-{% endif %}
                        </td>
                        <td class="text-end hide-mobile">{% if stock.market_cap %}{{ stock.market_cap|intcomma }}억{% else %}-{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center text-muted py-4">등록된 종목이 없습니다.</div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
