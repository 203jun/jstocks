{% extends 'stocks/base.html' %}
{% load humanize %}

{% block title %}ì¢…ëª© - JStocks{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">ì¢…ëª©</h4>
    <a href="{% url 'stocks:stock_list' %}" class="btn btn-outline-primary btn-sm">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search me-1" viewBox="0 0 16 16">
            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
        </svg>
        ì¢…ëª© ê²€ìƒ‰
    </a>
</div>

<!-- ëŒ€ì‹œë³´ë“œ íƒ­ -->
<ul class="nav nav-pills mb-3" id="dashboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" data-filter="super" type="button">ì´ˆê´€ì‹¬ <span class="badge bg-secondary">{{ super_stocks|length }}</span> <span class="badge bg-light text-dark" id="count-super">0</span></button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" data-filter="normal" type="button">ê´€ì‹¬ <span class="badge bg-secondary">{{ normal_stocks|length }}</span> <span class="badge bg-light text-dark" id="count-normal">0</span></button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" data-filter="incubator" type="button">ì¸íë² ì´í„° <span class="badge bg-secondary">{{ incubator_stocks|length }}</span> <span class="badge bg-light text-dark" id="count-incubator">0</span></button>
    </li>
</ul>

<!-- ëŒ€ì‹œë³´ë“œ ì¹´ë“œ -->
<div class="row mb-4" id="dashboardCards">
    <!-- ì¹´ë“œ A: ì¥ê¸° ê¸‰ë“± (60ì¼ ì‹ ê³ ê±°ë˜ëŸ‰) -->
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>ğŸ¥‡ ì¥ê¸° ê¸‰ë“±</strong>
                <small class="text-muted d-block">60ì¼ ì‹ ê³ ê±°ë˜ëŸ‰</small>
            </div>
            {% if card_a_stocks %}
            <!-- PC: í…Œì´ë¸” -->
            <div class="card-body p-0 d-none d-md-block">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0 dashboard-table">
                        <thead class="table-light">
                            <tr>
                                <th class="px-3">ì¢…ëª©ëª…</th>
                                <th class="text-end px-3">ë“±ë½ìœ¨</th>
                                <th class="text-end px-3">ê³ ì ëŒ€ë¹„</th>
                                <th class="text-end px-3">ê±°ë˜ëŒ€ê¸ˆ</th>
                                <th class="text-end px-3">10ì¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in card_a_stocks %}
                            <tr class="dashboard-row" data-level="{{ item.stock.interest_level }}" data-code="{{ item.stock.code }}" onclick="location.href='{% url 'stocks:stock_detail' item.stock.code %}'" style="cursor:pointer;">
                                <td class="px-3 py-2">
                                    <strong class="small {% if item.above_ma120 %}text-danger{% endif %}">{{ item.stock.name }}</strong>
                                </td>
                                <td class="text-end px-3 py-2 {% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %}">
                                    {% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%
                                </td>
                                <td class="text-end px-3 py-2 small {% if item.high_position >= -15 %}text-danger fw-bold{% elif item.high_position <= -40 %}text-secondary{% endif %}">{{ item.high_position }}%{% if item.high_position >= -15 %} ğŸš€{% elif item.high_position <= -40 %} â™»ï¸{% endif %}</td>
                                <td class="text-end px-3 py-2 small">{{ item.trading_value|intcomma }}ì–µ</td>
                                <td class="text-end px-3 py-2"><canvas class="sparkline" data-values="{{ item.sparkline|join:',' }}" width="60" height="20"></canvas></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- ëª¨ë°”ì¼: ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
            <div class="card-body p-2 d-md-none">
                {% for item in card_a_stocks %}
                <div class="mobile-stock-item dashboard-row border-bottom py-2" data-level="{{ item.stock.interest_level }}" data-code="{{ item.stock.code }}" onclick="location.href='{% url 'stocks:stock_detail' item.stock.code %}'" style="cursor:pointer;">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong class="{% if item.above_ma120 %}text-danger{% endif %}">{{ item.stock.name }}</strong>
                        <span class="{% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %} fw-bold">{% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center text-muted small mt-1">
                        <span>ê³ ì  <span class="{% if item.high_position >= -15 %}text-danger fw-bold{% elif item.high_position <= -40 %}text-secondary{% endif %}">{{ item.high_position }}%{% if item.high_position >= -15 %} ğŸš€{% elif item.high_position <= -40 %} â™»ï¸{% endif %}</span></span>
                        <span>{{ item.trading_value|intcomma }}ì–µ</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card-body text-center text-muted py-4">
                <small>í•´ë‹¹ ì¢…ëª© ì—†ìŒ</small>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ì¹´ë“œ B: ë‹¨ê¸° ê¸‰ë“± (20ì¼ ì‹ ê³ ê±°ë˜ëŸ‰) -->
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>ğŸ¥ˆ ë‹¨ê¸° ê¸‰ë“±</strong>
                <small class="text-muted d-block">20ì¼ ì‹ ê³ ê±°ë˜ëŸ‰</small>
            </div>
            {% if card_b_stocks %}
            <!-- PC: í…Œì´ë¸” -->
            <div class="card-body p-0 d-none d-md-block">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0 dashboard-table">
                        <thead class="table-light">
                            <tr>
                                <th class="px-3">ì¢…ëª©ëª…</th>
                                <th class="text-end px-3">ë“±ë½ìœ¨</th>
                                <th class="text-end px-3">ê³ ì ëŒ€ë¹„</th>
                                <th class="text-end px-3">ê±°ë˜ëŒ€ê¸ˆ</th>
                                <th class="text-end px-3">10ì¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in card_b_stocks %}
                            <tr class="dashboard-row" data-level="{{ item.stock.interest_level }}" data-code="{{ item.stock.code }}" onclick="location.href='{% url 'stocks:stock_detail' item.stock.code %}'" style="cursor:pointer;">
                                <td class="px-3 py-2">
                                    <strong class="small {% if item.above_ma120 %}text-danger{% endif %}">{{ item.stock.name }}</strong>
                                </td>
                                <td class="text-end px-3 py-2 {% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %}">
                                    {% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%
                                </td>
                                <td class="text-end px-3 py-2 small {% if item.high_position >= -15 %}text-danger fw-bold{% elif item.high_position <= -40 %}text-secondary{% endif %}">{{ item.high_position }}%{% if item.high_position >= -15 %} ğŸš€{% elif item.high_position <= -40 %} â™»ï¸{% endif %}</td>
                                <td class="text-end px-3 py-2 small">{{ item.trading_value|intcomma }}ì–µ</td>
                                <td class="text-end px-3 py-2"><canvas class="sparkline" data-values="{{ item.sparkline|join:',' }}" width="60" height="20"></canvas></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- ëª¨ë°”ì¼: ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
            <div class="card-body p-2 d-md-none">
                {% for item in card_b_stocks %}
                <div class="mobile-stock-item dashboard-row border-bottom py-2" data-level="{{ item.stock.interest_level }}" data-code="{{ item.stock.code }}" onclick="location.href='{% url 'stocks:stock_detail' item.stock.code %}'" style="cursor:pointer;">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong class="{% if item.above_ma120 %}text-danger{% endif %}">{{ item.stock.name }}</strong>
                        <span class="{% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %} fw-bold">{% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center text-muted small mt-1">
                        <span>ê³ ì  <span class="{% if item.high_position >= -15 %}text-danger fw-bold{% elif item.high_position <= -40 %}text-secondary{% endif %}">{{ item.high_position }}%{% if item.high_position >= -15 %} ğŸš€{% elif item.high_position <= -40 %} â™»ï¸{% endif %}</span></span>
                        <span>{{ item.trading_value|intcomma }}ì–µ</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card-body text-center text-muted py-4">
                <small>í•´ë‹¹ ì¢…ëª© ì—†ìŒ</small>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ì¹´ë“œ D: ì´í‰ì„  ì¤ì¤ -->
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>ğŸ§² ì´í‰ì„  ì¤ì¤</strong>
                <small class="text-muted d-block">ì •ë°°ì—´ + 60ì„ â†— + ì¢…ê°€&lt;MA20</small>
            </div>
            {% if card_d_stocks %}
            <!-- PC: í…Œì´ë¸” -->
            <div class="card-body p-0 d-none d-md-block">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0 dashboard-table">
                        <thead class="table-light">
                            <tr>
                                <th class="px-3">ì¢…ëª©ëª…</th>
                                <th class="text-end px-3">ë“±ë½ìœ¨</th>
                                <th class="text-end px-3">60ì„ ëŒ€ë¹„</th>
                                <th class="text-end px-3">ê³ ì ëŒ€ë¹„</th>
                                <th class="text-end px-3">10ì¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in card_d_stocks %}
                            <tr class="dashboard-row" data-level="{{ item.stock.interest_level }}" data-code="{{ item.stock.code }}" onclick="location.href='{% url 'stocks:stock_detail' item.stock.code %}'" style="cursor:pointer;">
                                <td class="px-3 py-2">
                                    <strong class="small">{{ item.stock.name }}</strong>
                                </td>
                                <td class="text-end px-3 py-2 {% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %}">
                                    {% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%
                                </td>
                                <td class="text-end px-3 py-2 small {% if item.gap_from_ma60 >= 0 %}text-danger{% elif item.gap_from_ma60 < -5 %}text-primary{% endif %}">{{ item.gap_from_ma60 }}%</td>
                                <td class="text-end px-3 py-2 small {% if item.high_position >= -15 %}text-danger fw-bold{% elif item.high_position <= -40 %}text-secondary{% endif %}">{{ item.high_position }}%</td>
                                <td class="text-end px-3 py-2"><canvas class="sparkline" data-values="{{ item.sparkline|join:',' }}" width="60" height="20"></canvas></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- ëª¨ë°”ì¼: ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
            <div class="card-body p-2 d-md-none">
                {% for item in card_d_stocks %}
                <div class="mobile-stock-item dashboard-row border-bottom py-2" data-level="{{ item.stock.interest_level }}" data-code="{{ item.stock.code }}" onclick="location.href='{% url 'stocks:stock_detail' item.stock.code %}'" style="cursor:pointer;">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>{{ item.stock.name }}</strong>
                        <span class="{% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %} fw-bold">{% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center text-muted small mt-1">
                        <span>60ì„  <span class="{% if item.gap_from_ma60 >= 0 %}text-danger{% elif item.gap_from_ma60 < -5 %}text-primary{% endif %}">{{ item.gap_from_ma60 }}%</span></span>
                        <span>ê³ ì  {{ item.high_position }}%</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card-body text-center text-muted py-4">
                <small>í•´ë‹¹ ì¢…ëª© ì—†ìŒ</small>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ì¹´ë“œ C: ì‹ í˜¸ ì¶”ì  -->
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>ğŸ“¡ ì‹ í˜¸ ì¶”ì </strong>
                <small class="text-muted d-block">ìµœê·¼ 5ì¼ ë‚´ ì¡°ê±´ ì¶©ì¡±</small>
            </div>
            {% if card_c_stocks %}
            <!-- PC: í…Œì´ë¸” -->
            <div class="card-body p-0 d-none d-md-block">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0 dashboard-table">
                        <thead class="table-light">
                            <tr>
                                <th class="px-3">ì¢…ëª©ëª…</th>
                                <th class="text-center px-3">ì‹ í˜¸</th>
                                <th class="text-center px-3">ë‚ ì§œ</th>
                                <th class="text-end px-3">ì–‘ë´‰ëŒ€ë¹„</th>
                                <th class="text-end px-3">ê³ ì ëŒ€ë¹„</th>
                                <th class="text-end px-3">10ì¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in card_c_stocks %}
                            <tr class="dashboard-row" data-level="{{ item.stock.interest_level }}" data-code="{{ item.stock.code }}" style="cursor:pointer;">
                                <td class="px-3 py-2" onclick="location.href='{% url 'stocks:stock_detail' item.stock.code %}'">
                                    <strong class="small {% if item.above_ma120 %}text-danger{% endif %}">{{ item.stock.name }}</strong>
                                </td>
                                <td class="text-center px-3 py-2" onclick="location.href='{% url 'stocks:stock_detail' item.stock.code %}'"><span class="badge" style="background-color: {% if item.signal_type == '60ì¼' %}#4caf50{% else %}#2196f3{% endif %};">{{ item.signal_type }}</span></td>
                                <td class="text-center px-3 py-2 small" onclick="location.href='{% url 'stocks:stock_detail' item.stock.code %}'">{{ item.signal_days_ago }}ì¼ì „</td>
                                <td class="text-end px-3 py-2 signal-chart-btn {% if item.signal_price_change > 0 %}text-danger{% elif item.signal_price_change < 0 %}text-primary{% endif %}"
                                    data-code="{{ item.stock.code }}"
                                    data-name="{{ item.stock.name }}"
                                    data-signal-date="{{ item.signal_date }}"
                                    data-signal-open="{{ item.signal_open }}"
                                    data-signal-close="{{ item.signal_close }}"
                                    data-current-price="{{ item.current_price }}"
                                    style="text-decoration: underline; cursor: pointer;">
                                    {% if item.signal_price_change > 0 %}+{% endif %}{{ item.signal_price_change }}%
                                </td>
                                <td class="text-end px-3 py-2 small {% if item.high_position >= -15 %}text-danger fw-bold{% elif item.high_position <= -40 %}text-secondary{% endif %}" onclick="location.href='{% url 'stocks:stock_detail' item.stock.code %}'">{{ item.high_position }}%{% if item.high_position >= -15 %} ğŸš€{% elif item.high_position <= -40 %} â™»ï¸{% endif %}</td>
                                <td class="text-end px-3 py-2" onclick="location.href='{% url 'stocks:stock_detail' item.stock.code %}'"><canvas class="sparkline" data-values="{{ item.sparkline|join:',' }}" width="60" height="20"></canvas></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- ëª¨ë°”ì¼: ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
            <div class="card-body p-2 d-md-none">
                {% for item in card_c_stocks %}
                <div class="mobile-stock-item dashboard-row border-bottom py-2" data-level="{{ item.stock.interest_level }}" data-code="{{ item.stock.code }}" style="cursor:pointer;">
                    <div class="d-flex justify-content-between align-items-center">
                        <span onclick="location.href='{% url 'stocks:stock_detail' item.stock.code %}'">
                            <strong class="{% if item.above_ma120 %}text-danger{% endif %}">{{ item.stock.name }}</strong>
                            <span class="badge ms-1" style="background-color: {% if item.signal_type == '60ì¼' %}#4caf50{% else %}#2196f3{% endif %}; font-size: 0.7em;">{{ item.signal_type }}</span>
                        </span>
                        <span class="signal-chart-btn {% if item.signal_price_change > 0 %}text-danger{% elif item.signal_price_change < 0 %}text-primary{% endif %} fw-bold"
                            data-code="{{ item.stock.code }}"
                            data-name="{{ item.stock.name }}"
                            data-signal-date="{{ item.signal_date }}"
                            data-signal-open="{{ item.signal_open }}"
                            data-signal-close="{{ item.signal_close }}"
                            data-current-price="{{ item.current_price }}"
                            style="text-decoration: underline;">{% if item.signal_price_change > 0 %}+{% endif %}{{ item.signal_price_change }}%</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center text-muted small mt-1" onclick="location.href='{% url 'stocks:stock_detail' item.stock.code %}'">
                        <span>{{ item.signal_days_ago }}ì¼ì „ Â· ê³ ì  <span class="{% if item.high_position >= -15 %}text-danger fw-bold{% elif item.high_position <= -40 %}text-secondary{% endif %}">{{ item.high_position }}%{% if item.high_position >= -15 %} ğŸš€{% elif item.high_position <= -40 %} â™»ï¸{% endif %}</span></span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card-body text-center text-muted py-4">
                <small>í•´ë‹¹ ì¢…ëª© ì—†ìŒ</small>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ì¹´ë“œ E: ë¦¬í¬íŠ¸ -->
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>ğŸ“Š ë¦¬í¬íŠ¸</strong>
                <small class="text-muted d-block">ìµœê·¼ 3ê±°ë˜ì¼ ì‹ ê·œ</small>
            </div>
            {% if card_report_stocks %}
            <!-- PC: í…Œì´ë¸” -->
            <div class="card-body p-0 d-none d-md-block">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0 dashboard-table">
                        <thead class="table-light">
                            <tr>
                                <th class="px-3">ì¢…ëª©ëª…</th>
                                <th class="text-end px-3">ë“±ë½ìœ¨</th>
                                <th class="px-3">ì œëª©</th>
                                <th class="text-end px-3">ëª©í‘œê°€</th>
                                <th class="text-end px-3">ê´´ë¦¬ìœ¨</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in card_report_stocks %}
                            <tr class="dashboard-row" data-level="{{ item.stock.interest_level }}" data-code="{{ item.stock.code }}" onclick="location.href='{% url 'stocks:stock_edit' item.stock.code %}#report-content'" style="cursor:pointer;">
                                <td class="px-3 py-2">
                                    <strong class="small">{{ item.stock.name }}</strong>
                                    {% if item.total_count > 1 %}<span class="badge bg-secondary ms-1" style="font-size: 0.65em;">+{{ item.total_count|add:"-1" }}</span>{% endif %}
                                </td>
                                <td class="text-end px-3 py-2 {% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %}">
                                    {% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%
                                </td>
                                <td class="px-3 py-2 small text-truncate" style="max-width: 200px;" title="{{ item.title }}">{{ item.title }}</td>
                                <td class="text-end px-3 py-2 small">{% if item.target_price %}{{ item.target_price|intcomma }}{% else %}-{% endif %}</td>
                                <td class="text-end px-3 py-2 {% if item.gap_rate > 30 %}text-danger fw-bold{% elif item.gap_rate > 0 %}text-danger{% else %}text-secondary{% endif %}">
                                    {% if item.gap_rate > 0 %}+{% endif %}{{ item.gap_rate }}%
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- ëª¨ë°”ì¼: ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
            <div class="card-body p-2 d-md-none">
                {% for item in card_report_stocks %}
                <div class="mobile-stock-item dashboard-row border-bottom py-2" data-level="{{ item.stock.interest_level }}" data-code="{{ item.stock.code }}" onclick="location.href='{% url 'stocks:stock_edit' item.stock.code %}#report-content'" style="cursor:pointer;">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>
                            <strong>{{ item.stock.name }}</strong>
                            {% if item.total_count > 1 %}<span class="badge bg-secondary ms-1" style="font-size: 0.7em;">+{{ item.total_count|add:"-1" }}</span>{% endif %}
                        </span>
                        <span class="{% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %} fw-bold">{% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%</span>
                    </div>
                    <div class="text-muted small mt-1 text-truncate">{{ item.title }}</div>
                    <div class="d-flex justify-content-between align-items-center small mt-1">
                        <span class="text-muted">ëª©í‘œ {% if item.target_price %}{{ item.target_price|intcomma }}{% else %}-{% endif %}</span>
                        <span class="{% if item.gap_rate > 30 %}text-danger fw-bold{% elif item.gap_rate > 0 %}text-danger{% else %}text-secondary{% endif %}">ê´´ë¦¬ {% if item.gap_rate > 0 %}+{% endif %}{{ item.gap_rate }}%</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card-body text-center text-muted py-4">
                <small>í•´ë‹¹ ì¢…ëª© ì—†ìŒ</small>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ì¹´ë“œ F: ë…¸ë‹¤ì§€ -->
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <strong>â›ï¸ ë…¸ë‹¤ì§€</strong>
                <small class="text-muted d-block">ìµœê·¼ 3ê±°ë˜ì¼ ì‹ ê·œ</small>
            </div>
            {% if card_nodaji_stocks %}
            <!-- PC: í…Œì´ë¸” -->
            <div class="card-body p-0 d-none d-md-block">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0 dashboard-table">
                        <thead class="table-light">
                            <tr>
                                <th class="px-3">ì¢…ëª©ëª…</th>
                                <th class="text-end px-3">ë“±ë½ìœ¨</th>
                                <th class="px-3">ì œëª©</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in card_nodaji_stocks %}
                            <tr class="dashboard-row" data-level="{{ item.stock.interest_level }}" data-code="{{ item.stock.code }}" onclick="location.href='{% url 'stocks:stock_edit' item.stock.code %}#nodaji-content'" style="cursor:pointer;">
                                <td class="px-3 py-2">
                                    <strong class="small">{{ item.stock.name }}</strong>
                                </td>
                                <td class="text-end px-3 py-2 {% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %}">
                                    {% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%
                                </td>
                                <td class="px-3 py-2 small text-truncate" style="max-width: 300px;" title="{{ item.title }}">{{ item.title }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- ëª¨ë°”ì¼: ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
            <div class="card-body p-2 d-md-none">
                {% for item in card_nodaji_stocks %}
                <div class="mobile-stock-item dashboard-row border-bottom py-2" data-level="{{ item.stock.interest_level }}" data-code="{{ item.stock.code }}" onclick="location.href='{% url 'stocks:stock_edit' item.stock.code %}#nodaji-content'" style="cursor:pointer;">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>{{ item.stock.name }}</strong>
                        <span class="{% if item.change_rate > 0 %}text-danger{% elif item.change_rate < 0 %}text-primary{% endif %} fw-bold">{% if item.change_rate > 0 %}+{% endif %}{{ item.change_rate }}%</span>
                    </div>
                    <div class="text-muted small mt-1 text-truncate">{{ item.title }}</div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card-body text-center text-muted py-4">
                <small>í•´ë‹¹ ì¢…ëª© ì—†ìŒ</small>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ì¢…ëª© ë¦¬ìŠ¤íŠ¸ -->
<div class="table-responsive" id="stockListContainer">
    <table class="table table-hover stock-table mb-0">
        <thead class="table-light">
            <tr>
                <th>ì¢…ëª©ëª…</th>
                <th class="hide-mobile">ëŒ€ë¶„ë¥˜</th>
                <th class="hide-mobile">ì†Œë¶„ë¥˜</th>
                <th class="text-end">í˜„ì¬ê°€</th>
                <th class="text-end">ë“±ë½ìœ¨</th>
                <th class="text-end hide-mobile">ì‹œê°€ì´ì•¡</th>
            </tr>
        </thead>
        <tbody id="stockListBody">
            {% for stock in super_stocks %}
            <tr class="stock-row" data-level="super" onclick="location.href='{% url 'stocks:stock_detail' stock.code %}'" style="cursor:pointer;">
                <td>
                    <strong>{{ stock.name }}</strong>
                    <small class="text-muted ms-1">{{ stock.code }}</small>
                </td>
                <td class="hide-mobile small text-muted">{% for theme in stock.themes.all %}{% if forloop.first %}{{ theme.category.name }}{% endif %}{% empty %}-{% endfor %}</td>
                <td class="hide-mobile small">{% for theme in stock.themes.all %}{{ theme.name }}{% if not forloop.last %}, {% endif %}{% empty %}-{% endfor %}</td>
                <td class="text-end">{% if stock.current_price %}{{ stock.current_price|intcomma }}{% else %}-{% endif %}</td>
                <td class="text-end {% if stock.change_rate > 0 %}text-up{% elif stock.change_rate < 0 %}text-down{% endif %}">
                    {% if stock.change_rate %}{% if stock.change_rate > 0 %}+{% endif %}{{ stock.change_rate }}%{% else %}-{% endif %}
                </td>
                <td class="text-end hide-mobile">{% if stock.market_cap %}{{ stock.market_cap|intcomma }}ì–µ{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
            {% for stock in normal_stocks %}
            <tr class="stock-row" data-level="normal" onclick="location.href='{% url 'stocks:stock_detail' stock.code %}'" style="cursor:pointer;">
                <td>
                    <strong>{{ stock.name }}</strong>
                    <small class="text-muted ms-1">{{ stock.code }}</small>
                </td>
                <td class="hide-mobile small text-muted">{% for theme in stock.themes.all %}{% if forloop.first %}{{ theme.category.name }}{% endif %}{% empty %}-{% endfor %}</td>
                <td class="hide-mobile small">{% for theme in stock.themes.all %}{{ theme.name }}{% if not forloop.last %}, {% endif %}{% empty %}-{% endfor %}</td>
                <td class="text-end">{% if stock.current_price %}{{ stock.current_price|intcomma }}{% else %}-{% endif %}</td>
                <td class="text-end {% if stock.change_rate > 0 %}text-up{% elif stock.change_rate < 0 %}text-down{% endif %}">
                    {% if stock.change_rate %}{% if stock.change_rate > 0 %}+{% endif %}{{ stock.change_rate }}%{% else %}-{% endif %}
                </td>
                <td class="text-end hide-mobile">{% if stock.market_cap %}{{ stock.market_cap|intcomma }}ì–µ{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
            {% for stock in incubator_stocks %}
            <tr class="stock-row" data-level="incubator" onclick="location.href='{% url 'stocks:stock_detail' stock.code %}'" style="cursor:pointer;">
                <td>
                    <strong>{{ stock.name }}</strong>
                    <small class="text-muted ms-1">{{ stock.code }}</small>
                </td>
                <td class="hide-mobile small text-muted">{% for theme in stock.themes.all %}{% if forloop.first %}{{ theme.category.name }}{% endif %}{% empty %}-{% endfor %}</td>
                <td class="hide-mobile small">{% for theme in stock.themes.all %}{{ theme.name }}{% if not forloop.last %}, {% endif %}{% empty %}-{% endfor %}</td>
                <td class="text-end">{% if stock.current_price %}{{ stock.current_price|intcomma }}{% else %}-{% endif %}</td>
                <td class="text-end {% if stock.change_rate > 0 %}text-up{% elif stock.change_rate < 0 %}text-down{% endif %}">
                    {% if stock.change_rate %}{% if stock.change_rate > 0 %}+{% endif %}{{ stock.change_rate }}%{% else %}-{% endif %}
                </td>
                <td class="text-end hide-mobile">{% if stock.market_cap %}{{ stock.market_cap|intcomma }}ì–µ{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<div class="card d-none" id="emptyStockList">
    <div class="card-body text-center text-muted py-4">ë“±ë¡ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>
</div>

<style>
/* ëª¨ë°”ì¼ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ hover íš¨ê³¼ */
.mobile-stock-item:hover {
    background-color: rgba(0,0,0,.03);
}
.mobile-stock-item:last-child {
    border-bottom: none !important;
}
</style>

<!-- ì‹ í˜¸ ì°¨íŠ¸ ëª¨ë‹¬ -->
<div class="modal fade" id="signalChartModal" tabindex="-1" aria-labelledby="signalChartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title" id="signalChartModalLabel">ì‹ í˜¸ ì°¨íŠ¸</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-2">
                <div id="signalChartContainer" style="height: 400px;"></div>
                <div class="mt-2 small text-muted">
                    <span class="me-3"><span style="color: #ff9800;">- - -</span> ë´‰ ë²”ìœ„</span>
                    <span><span style="color: #2196f3;">- - -</span> í˜„ì¬ê°€</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ìŠ¤íŒŒí¬ë¼ì¸ ê·¸ë¦¬ê¸°
function drawSparklines() {
    document.querySelectorAll('.sparkline').forEach(canvas => {
        const values = canvas.dataset.values.split(',').map(Number);
        if (values.length < 2) return;

        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;

        // ìº”ë²„ìŠ¤ í´ë¦¬ì–´
        ctx.clearRect(0, 0, width, height);

        const min = Math.min(...values);
        const max = Math.max(...values);
        const range = max - min || 1;

        // ì‹œì‘ì ê³¼ ëì  ë¹„êµí•´ì„œ ìƒ‰ìƒ ê²°ì •
        const color = values[values.length - 1] >= values[0] ? '#ef5350' : '#2196f3';

        ctx.strokeStyle = color;
        ctx.lineWidth = 1.5;
        ctx.beginPath();

        values.forEach((val, i) => {
            const x = (i / (values.length - 1)) * width;
            const y = height - ((val - min) / range) * (height - 4) - 2;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });

        ctx.stroke();
    });
}

// ì´ˆê¸° ìŠ¤íŒŒí¬ë¼ì¸ ê·¸ë¦¬ê¸°
drawSparklines();

// íƒ­ë³„ ì¹´ë“œ ì¢…ëª© ê°œìˆ˜ ê³„ì‚° (ì¤‘ë³µ ì œê±°)
function updateTabCounts() {
    const seen = { super: new Set(), normal: new Set(), incubator: new Set() };
    document.querySelectorAll('.dashboard-row').forEach(row => {
        const level = row.dataset.level;
        const code = row.dataset.code;
        if (seen.hasOwnProperty(level) && code) {
            seen[level].add(code);
        }
    });
    document.getElementById('count-super').textContent = seen.super.size;
    document.getElementById('count-normal').textContent = seen.normal.size;
    document.getElementById('count-incubator').textContent = seen.incubator.size;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ê°œìˆ˜ ê³„ì‚°
updateTabCounts();

// ì´ˆê¸° í•„í„° ì ìš© (ì´ˆê´€ì‹¬)
function applyFilter(filter) {
    // ëŒ€ì‹œë³´ë“œ ì¹´ë“œ í•„í„°ë§
    document.querySelectorAll('.dashboard-row').forEach(row => {
        if (row.dataset.level === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });

    // ê° ì¹´ë“œë³„ë¡œ ë³´ì´ëŠ” í–‰ì´ ì—†ìœ¼ë©´ "í•´ë‹¹ ì¢…ëª© ì—†ìŒ" í‘œì‹œ
    document.querySelectorAll('#dashboardCards .card').forEach(card => {
        const tbody = card.querySelector('tbody');
        const emptyMsg = card.querySelector('.empty-filter-msg');

        if (tbody) {
            const visibleRows = tbody.querySelectorAll('tr.dashboard-row:not([style*="display: none"])');

            if (visibleRows.length === 0) {
                if (!emptyMsg) {
                    const msg = document.createElement('tr');
                    msg.className = 'empty-filter-msg';
                    msg.innerHTML = '<td colspan="10" class="text-center text-muted py-3"><small>í•´ë‹¹ ì¢…ëª© ì—†ìŒ</small></td>';
                    tbody.appendChild(msg);
                }
            } else {
                if (emptyMsg) emptyMsg.remove();
            }
        }
    });

    // ì¢…ëª© ë¦¬ìŠ¤íŠ¸ í•„í„°ë§
    let visibleCount = 0;
    document.querySelectorAll('.stock-row').forEach(row => {
        if (row.dataset.level === filter) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // ë¹ˆ ëª©ë¡ ì²˜ë¦¬
    const container = document.getElementById('stockListContainer');
    const emptyList = document.getElementById('emptyStockList');
    if (visibleCount === 0) {
        container.classList.add('d-none');
        emptyList.classList.remove('d-none');
    } else {
        container.classList.remove('d-none');
        emptyList.classList.add('d-none');
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê´€ì‹¬ í•„í„° ì ìš©
applyFilter('super');

// ëŒ€ì‹œë³´ë“œ íƒ­ í•„í„°ë§
document.querySelectorAll('#dashboardTabs button').forEach(btn => {
    btn.addEventListener('click', function() {
        // í™œì„± íƒ­ ë³€ê²½
        document.querySelectorAll('#dashboardTabs button').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        applyFilter(this.dataset.filter);
        drawSparklines();
    });
});

// ì‹ í˜¸ ì°¨íŠ¸ íŒì—…
let signalChart = null;
let signalCandleSeries = null;
let signalVolumeSeries = null;
let pendingChartData = null;

function renderSignalChart() {
    if (!pendingChartData) return;

    const { signalDate, signalOpen, signalClose, currentPrice, candleData, volumeData } = pendingChartData;

    // ë´‰ ëª¸í†µ ë²”ìœ„ ê³„ì‚° (ì–‘ë´‰/ìŒë´‰ ìƒê´€ì—†ì´ ëª¸í†µì˜ ìƒë‹¨/í•˜ë‹¨)
    const bodyLow = Math.min(signalOpen, signalClose);
    const bodyHigh = Math.max(signalOpen, signalClose);

    // ì‹ í˜¸ ë°œìƒì¼ ë´‰ì„ ê²€ì •ìƒ‰ìœ¼ë¡œ ë³€ê²½
    const styledCandleData = candleData.map(candle => {
        if (candle.time === signalDate) {
            return {
                ...candle,
                color: '#000000',
                borderColor: '#000000',
                wickColor: '#000000',
            };
        }
        return candle;
    });
    const container = document.getElementById('signalChartContainer');
    container.innerHTML = '';

    // ì»¨í…Œì´ë„ˆ ë„ˆë¹„ í™•ì¸
    const containerWidth = container.clientWidth || 750;

    // Lightweight Charts ìƒì„±
    signalChart = LightweightCharts.createChart(container, {
        width: containerWidth,
        height: 400,
        layout: {
            background: { type: 'solid', color: '#ffffff' },
            textColor: '#333',
        },
        grid: {
            vertLines: { color: '#f0f0f0' },
            horzLines: { color: '#f0f0f0' },
        },
        crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
        },
        rightPriceScale: {
            borderColor: '#ddd',
        },
        timeScale: {
            borderColor: '#ddd',
            timeVisible: false,
            rightOffset: 0,
            fixLeftEdge: true,
            fixRightEdge: true,
            lockVisibleTimeRangeOnResize: true,
        },
        handleScroll: {
            mouseWheel: true,
            pressedMouseMove: true,
            horzTouchDrag: true,
            vertTouchDrag: false,
        },
        handleScale: {
            axisPressedMouseMove: true,
            mouseWheel: true,
            pinch: true,
        },
    });

    // ìº”ë“¤ìŠ¤í‹± ì‹œë¦¬ì¦ˆ ì¶”ê°€
    signalCandleSeries = signalChart.addCandlestickSeries({
        upColor: '#ef5350',
        downColor: '#2196f3',
        borderUpColor: '#ef5350',
        borderDownColor: '#2196f3',
        wickUpColor: '#ef5350',
        wickDownColor: '#2196f3',
    });

    signalCandleSeries.setData(styledCandleData);

    // ê±°ë˜ëŸ‰ ì‹œë¦¬ì¦ˆ ì¶”ê°€
    signalVolumeSeries = signalChart.addHistogramSeries({
        priceFormat: {
            type: 'volume',
        },
        priceScaleId: '',
        scaleMargins: {
            top: 0.8,
            bottom: 0,
        },
    });

    signalVolumeSeries.setData(volumeData);

    // ë´‰ í¬ê¸° ë° í˜„ì¬ê°€ ëŒ€ë¹„ ê³„ì‚°
    const bodySize = bodyHigh && bodyLow ? ((bodyHigh - bodyLow) / bodyLow * 100).toFixed(1) : 0;
    const priceVsClose = currentPrice && bodyHigh ? ((currentPrice - bodyHigh) / bodyHigh * 100).toFixed(1) : 0;

    // ì°¨íŠ¸ ì™¼ìª½ ìƒë‹¨ì— ì •ë³´ í‘œì‹œ
    const legendDiv = document.createElement('div');
    legendDiv.style.cssText = 'position: absolute; top: 10px; left: 10px; z-index: 10; font-size: 12px; background: rgba(255,255,255,0.9); padding: 5px 10px; border-radius: 4px;';
    legendDiv.innerHTML = `<span style="color: #ff9800;">ë´‰ í¬ê¸°: ${bodySize}%</span> &nbsp; <span style="color: ${priceVsClose >= 0 ? '#ef5350' : '#2196f3'};">ìƒë‹¨ëŒ€ë¹„: ${priceVsClose >= 0 ? '+' : ''}${priceVsClose}%</span>`;
    container.style.position = 'relative';
    container.appendChild(legendDiv);

    // ë´‰ ëª¸í†µ í•˜ë‹¨ (ì ì„ , ê°™ì€ ìƒ‰ìƒ)
    if (bodyLow) {
        signalCandleSeries.createPriceLine({
            price: bodyLow,
            color: '#ff9800',
            lineWidth: 1,
            lineStyle: LightweightCharts.LineStyle.Dashed,
            axisLabelVisible: false,
            title: '',
        });
    }

    // ë´‰ ëª¸í†µ ìƒë‹¨ (ì ì„ , ê°™ì€ ìƒ‰ìƒ)
    if (bodyHigh) {
        signalCandleSeries.createPriceLine({
            price: bodyHigh,
            color: '#ff9800',
            lineWidth: 1,
            lineStyle: LightweightCharts.LineStyle.Dashed,
            axisLabelVisible: false,
            title: '',
        });
    }

    // í˜„ì¬ê°€ (ì ì„ )
    if (currentPrice) {
        signalCandleSeries.createPriceLine({
            price: currentPrice,
            color: '#2196f3',
            lineWidth: 2,
            lineStyle: LightweightCharts.LineStyle.Dashed,
            axisLabelVisible: false,
            title: '',
        });
    }

    // ì „ì²´ ë°ì´í„° í‘œì‹œ
    signalChart.timeScale().fitContent();

    pendingChartData = null;
}

// ëª¨ë‹¬ì´ ì™„ì „íˆ í‘œì‹œëœ í›„ ì°¨íŠ¸ ë Œë”ë§
document.getElementById('signalChartModal').addEventListener('shown.bs.modal', function() {
    renderSignalChart();
});

document.addEventListener('click', function(e) {
    const btn = e.target.closest('.signal-chart-btn');
    if (!btn) return;

    e.stopPropagation();

    const code = btn.dataset.code;
    const name = btn.dataset.name;
    const signalDate = btn.dataset.signalDate;
    const signalOpen = parseFloat(btn.dataset.signalOpen) || 0;
    const signalClose = parseFloat(btn.dataset.signalClose) || 0;
    const currentPrice = parseFloat(btn.dataset.currentPrice) || 0;

    // ëª¨ë‹¬ íƒ€ì´í‹€ ì„¤ì •
    document.getElementById('signalChartModalLabel').textContent = `${name} ì‹ í˜¸ ì°¨íŠ¸`;

    // ë¡œë”© í‘œì‹œ
    document.getElementById('signalChartContainer').innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">ì°¨íŠ¸ ë¡œë”© ì¤‘...</p></div>';

    // ëª¨ë‹¬ ì—´ê¸°
    const modal = new bootstrap.Modal(document.getElementById('signalChartModal'));
    modal.show();

    // ì°¨íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    fetch(`/api/stock/${code}/signal-chart/`)
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                document.getElementById('signalChartContainer').innerHTML = '<div class="text-center py-5 text-muted">ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            // ë°ì´í„° ì €ì¥ (ëª¨ë‹¬ì´ ì—´ë¦° í›„ ë Œë”ë§)
            pendingChartData = {
                signalDate,
                signalOpen,
                signalClose,
                currentPrice,
                candleData: data.candle_data,
                volumeData: data.volume_data,
            };

            // ëª¨ë‹¬ì´ ì´ë¯¸ ì—´ë ¤ ìˆìœ¼ë©´ ë°”ë¡œ ë Œë”ë§
            const modalEl = document.getElementById('signalChartModal');
            if (modalEl.classList.contains('show')) {
                renderSignalChart();
            }
        })
        .catch(err => {
            console.error('ì°¨íŠ¸ ë¡œë“œ ì—ëŸ¬:', err);
            document.getElementById('signalChartContainer').innerHTML = '<div class="text-center py-5 text-danger">ì°¨íŠ¸ ë¡œë“œ ì—ëŸ¬</div>';
        });
});

// ëª¨ë‹¬ ë‹«í ë•Œ ì°¨íŠ¸ ì •ë¦¬
document.getElementById('signalChartModal').addEventListener('hidden.bs.modal', function() {
    if (signalChart) {
        signalChart.remove();
        signalChart = null;
        signalCandleSeries = null;
        signalVolumeSeries = null;
    }
});

// ì°½ í¬ê¸° ë³€ê²½ ì‹œ ì°¨íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ
window.addEventListener('resize', function() {
    if (signalChart) {
        const container = document.getElementById('signalChartContainer');
        signalChart.applyOptions({ width: container.clientWidth });
    }
});
</script>
{% endblock %}
