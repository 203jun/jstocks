{% extends 'stocks/base.html' %}
{% load humanize %}

{% block title %}종목 검색 - JStocks{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">종목 검색</h4>
    <span class="text-muted">{{ stocks|length }}개</span>
</div>

<!-- 검색/필터 -->
<div class="card mb-3">
    <div class="card-body py-2">
        <form method="get" class="row g-2 align-items-center">
            <div class="col-12 col-md-4">
                <input type="text" name="q" class="form-control form-control-sm" placeholder="종목명/코드 검색" value="{{ query }}">
            </div>
            <div class="col-6 col-md-2">
                <select name="market" class="form-select form-select-sm">
                    <option value="">전체시장</option>
                    <option value="KOSPI" {% if market == 'KOSPI' %}selected{% endif %}>KOSPI</option>
                    <option value="KOSDAQ" {% if market == 'KOSDAQ' %}selected{% endif %}>KOSDAQ</option>
                </select>
            </div>
            <div class="col-6 col-md-2">
                <select name="sort" class="form-select form-select-sm">
                    <option value="-market_cap" {% if sort == '-market_cap' %}selected{% endif %}>시총 높은순</option>
                    <option value="market_cap" {% if sort == 'market_cap' %}selected{% endif %}>시총 낮은순</option>
                    <option value="-change_rate" {% if sort == '-change_rate' %}selected{% endif %}>등락율 높은순</option>
                    <option value="change_rate" {% if sort == 'change_rate' %}selected{% endif %}>등락율 낮은순</option>
                    <option value="name" {% if sort == 'name' %}selected{% endif %}>이름순</option>
                </select>
            </div>
            <div class="col-12 col-md-2">
                <button type="submit" class="btn btn-primary btn-sm w-100">검색</button>
            </div>
        </form>
    </div>
</div>

<!-- 종목 테이블 -->
<div class="table-responsive">
    <table class="table table-hover stock-table mb-0">
        <thead class="table-light">
            <tr>
                <th>종목명</th>
                <th class="text-end">현재가</th>
                <th class="text-end">등락율</th>
                <th class="text-end hide-mobile">시가총액</th>
                <th class="text-end hide-mobile">PER</th>
                <th class="text-end hide-mobile">PBR</th>
            </tr>
        </thead>
        <tbody>
            {% for stock in stocks %}
            <tr onclick="location.href='{% url 'stocks:stock_detail' stock.code %}'" style="cursor:pointer;">
                <td>
                    <div>
                        <strong>{{ stock.name }}</strong>
                        <small class="text-muted ms-1">{{ stock.code }}</small>
                    </div>
                    <small class="text-muted">{{ stock.market }}</small>
                </td>
                <td class="text-end">
                    {% if stock.current_price %}
                        {{ stock.current_price|intcomma }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="text-end {% if stock.change_rate > 0 %}text-up{% elif stock.change_rate < 0 %}text-down{% endif %}">
                    {% if stock.change_rate %}
                        {% if stock.change_rate > 0 %}+{% endif %}{{ stock.change_rate }}%
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="text-end hide-mobile">
                    {% if stock.market_cap %}
                        {{ stock.market_cap|intcomma }}억
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="text-end hide-mobile">
                    {% if stock.per %}
                        {{ stock.per }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="text-end hide-mobile">
                    {% if stock.pbr %}
                        {{ stock.pbr }}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="text-center text-muted py-4">검색 결과가 없습니다.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
