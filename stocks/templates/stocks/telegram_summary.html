{% extends 'stocks/base.html' %}

{% block title %}요약 - {{ telegram_message.stock.name }} - JStocks{% endblock %}

{% block extra_css %}
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
#editor {
    height: 400px;
    background: white;
}
.ql-toolbar {
    background: #f8f9fa;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">텔레그램 메시지 요약</h4>
    <a href="{% url 'stocks:stock_edit' telegram_message.stock.code %}#telegram-content" class="btn btn-outline-secondary btn-sm">목록으로</a>
</div>

<div class="card mb-3">
    <div class="card-header py-2">
        <strong>{{ telegram_message.stock.name }}</strong>
        <small class="text-muted ms-2">{{ telegram_message.channel_name|default:telegram_message.channel }}</small>
    </div>
    <div class="card-body py-2">
        <div class="mb-2" style="white-space: pre-wrap;">{{ telegram_message.text }}</div>
        <div class="small text-muted">
            {{ telegram_message.date }} {{ telegram_message.time }}
        </div>
    </div>
</div>

{% if messages %}
<div class="mb-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-2" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<form method="post">
    {% csrf_token %}
    <div class="card">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <strong>요약 내용</strong>
            <button type="submit" class="btn btn-primary btn-sm">저장</button>
        </div>
        <div class="card-body p-0">
            <div id="editor"></div>
            <input type="hidden" name="summary" id="summary">
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
const quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
        toolbar: [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['link'],
            ['clean']
        ]
    },
    placeholder: '요약 내용을 입력하세요...'
});

// 기존 내용 로드
const existingContent = `{{ telegram_message.summary|escapejs }}`;
if (existingContent) {
    quill.root.innerHTML = existingContent;
}

// 폼 제출 시 에디터 내용을 hidden input에 복사
document.querySelector('form').addEventListener('submit', function() {
    document.getElementById('summary').value = quill.root.innerHTML;
});
</script>
{% endblock %}
