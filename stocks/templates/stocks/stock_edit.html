{% extends 'stocks/base.html' %}
{% load humanize %}

{% block title %}{{ stock.name }} 편집 - JStocks{% endblock %}

{% block content %}
<!-- 종목 헤더 -->
<div class="d-flex justify-content-between align-items-start mb-3">
    <div>
        <h4 class="mb-1">{{ stock.name }}</h4>
        <span class="text-muted">{{ stock.code }}</span>
        <span class="badge bg-secondary ms-1">{{ stock.market }}</span>
    </div>
    <a href="{% url 'stocks:stock_detail' stock.code %}" class="btn btn-outline-secondary btn-sm">상세</a>
</div>

<!-- 메인 탭 -->
<ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-content" type="button" role="tab">기본정보</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="supply-tab" data-bs-toggle="tab" data-bs-target="#supply-content" type="button" role="tab">수급</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="shortsell-tab" data-bs-toggle="tab" data-bs-target="#shortsell-content" type="button" role="tab">공매도</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="disclosure-tab" data-bs-toggle="tab" data-bs-target="#disclosure-content" type="button" role="tab">공시</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report-content" type="button" role="tab">리포트</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="telegram-tab" data-bs-toggle="tab" data-bs-target="#telegram-content" type="button" role="tab">텔레그램</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="news-tab" data-bs-toggle="tab" data-bs-target="#news-content" type="button" role="tab">뉴스</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="nodaji-tab" data-bs-toggle="tab" data-bs-target="#nodaji-content" type="button" role="tab">노다지</button>
    </li>
</ul>

<div class="tab-content" id="mainTabContent">
    <!-- 기본정보 탭 -->
    <div class="tab-pane fade show active" id="info-content" role="tabpanel">
        <form method="post">
            {% csrf_token %}

            <div class="card mb-3">
                <div class="card-header py-2">
                    <strong>관심 단계</strong>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <select name="interest_level" class="form-select">
                                <option value="">선택 안함</option>
                                {% for value, label in interest_choices %}
                                <option value="{{ value }}" {% if stock.interest_level == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                            <div class="mt-2">
                                {% if stock.fav_sync_status == 'syncing' %}
                                <span class="badge bg-warning text-dark">
                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                    데이터 수집 중...
                                </span>
                                <small class="text-muted ms-2">페이지를 새로고침하여 완료 여부를 확인하세요.</small>
                                {% elif stock.fav_sync_status == 'deleting' %}
                                <span class="badge bg-danger">
                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                    데이터 삭제 중...
                                </span>
                                <small class="text-muted ms-2">페이지를 새로고침하여 완료 여부를 확인하세요.</small>
                                {% elif stock.fav_sync_status == 'completed' %}
                                <span class="badge bg-success">데이터 수집 완료</span>
                                {% else %}
                                <small class="text-muted">초관심 > 관심 > 인큐베이터 순으로 중요도가 높습니다.</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mt-2">
                                <input type="checkbox" class="form-check-input" id="is_holding" name="is_holding" {% if stock.is_holding %}checked{% endif %}>
                                <label class="form-check-label" for="is_holding">
                                    <strong>보유중</strong>
                                    <small class="text-muted ms-1">현재 이 종목을 보유하고 있음</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header py-2">
                    <strong>업종</strong>
                    <a href="{% url 'stocks:settings' %}" class="text-muted small ms-2" target="_blank">관리</a>
                </div>
                <div class="card-body py-2">
                    {% if theme_categories %}
                    <!-- 선택된 테마 표시 -->
                    <div id="selectedThemes" class="d-flex flex-wrap gap-1 mb-2">
                        {% for theme in stock.themes.all %}
                        <span class="badge bg-primary d-flex align-items-center selected-theme" data-id="{{ theme.id }}">
                            {{ theme.category.name }} &gt; {{ theme.name }}
                            <button type="button" class="btn-close btn-close-white ms-1 btn-remove-theme" style="font-size: 0.5rem;"></button>
                        </span>
                        {% empty %}
                        <span class="text-muted small" id="noThemeMsg">선택된 업종이 없습니다.</span>
                        {% endfor %}
                    </div>
                    <!-- 테마 추가 드롭다운 -->
                    <div class="d-flex gap-2 align-items-center">
                        <select id="themeSelect" class="form-select form-select-sm" style="max-width: 300px;">
                            <option value="">업종 선택...</option>
                            {% for category in theme_categories %}
                            <optgroup label="{{ category.name }}">
                                {% for theme in category.themes.all %}
                                <option value="{{ theme.id }}" data-category="{{ category.name }}" data-name="{{ theme.name }}">{{ theme.name }}</option>
                                {% endfor %}
                            </optgroup>
                            {% endfor %}
                        </select>
                        <button type="button" id="btnAddThemeToStock" class="btn btn-sm btn-outline-primary">추가</button>
                    </div>
                    <!-- hidden inputs -->
                    <div id="themeInputs">
                        {% for theme in stock.themes.all %}
                        <input type="hidden" name="themes" value="{{ theme.id }}">
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-muted small">
                        등록된 업종이 없습니다. <a href="{% url 'stocks:settings' %}" target="_blank">설정</a>에서 업종을 추가하세요.
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header py-2">
                    <strong>투자포인트</strong>
                </div>
                <div class="card-body p-0">
                    <div id="investmentPointEditor" style="min-height: 150px;">{{ stock.investment_point|safe }}</div>
                    <input type="hidden" name="investment_point" id="investmentPointInput">
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header py-2">
                    <strong>리스크</strong>
                </div>
                <div class="card-body p-0">
                    <div id="riskEditor" style="min-height: 150px;">{{ stock.risk|safe }}</div>
                    <input type="hidden" name="risk" id="riskInput">
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <strong>일정</strong>
                    <button type="button" id="btnAddSchedule" class="btn btn-sm btn-outline-primary">추가</button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0" id="scheduleTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3" style="width:100px;">날짜</th>
                                    <th style="width:110px;">알림일자</th>
                                    <th>내용</th>
                                    <th style="width:50px;"></th>
                                </tr>
                            </thead>
                            <tbody id="scheduleBody">
                                {% for schedule in schedules %}
                                <tr data-id="{{ schedule.id }}">
                                    <td class="ps-3">{{ schedule.date_text }}</td>
                                    <td class="text-muted small">{{ schedule.date_sort|date:"Y-m-d"|default:"-" }}</td>
                                    <td>{{ schedule.content }}</td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-outline-danger btn-delete-schedule" data-id="{{ schedule.id }}">×</button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr id="scheduleEmpty">
                                    <td colspan="4" class="text-center text-muted py-3">등록된 일정이 없습니다.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- 추가 폼 (숨김) -->
                    <div id="scheduleAddForm" class="border-top p-3 d-none">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-2">
                                <label class="form-label small">날짜(표시)</label>
                                <input type="text" class="form-control form-control-sm" id="scheduleAddDateText" placeholder="내년 상반기">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">알림일자</label>
                                <input type="date" class="form-control form-control-sm" id="scheduleAddDateSort">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">내용</label>
                                <input type="text" class="form-control form-control-sm" id="scheduleAddContent" placeholder="일정 내용">
                            </div>
                            <div class="col-md-2">
                                <button type="button" id="btnSaveSchedule" class="btn btn-sm btn-primary w-100">저장</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header py-2">
                    <strong>기업분석</strong>
                </div>
                <div class="card-body p-0">
                    <div id="analysisEditor" style="min-height: 300px;">{{ stock.analysis|safe }}</div>
                    <input type="hidden" name="analysis" id="analysisInput">
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">저장</button>
                <a href="{% url 'stocks:stock_detail' stock.code %}" class="btn btn-outline-secondary">취소</a>
            </div>
        </form>
    </div>

    <!-- 수급 탭 -->
    <div class="tab-pane fade" id="supply-content" role="tabpanel">
        <!-- 누적 순매수 차트 -->
        {% if investor_trends %}
        <div class="card mb-3">
            <div class="card-header py-2 d-flex align-items-center justify-content-between">
                <strong>누적 순매수</strong>
                <div class="d-flex gap-1">
                    <span class="badge text-bg-warning text-dark" style="font-size: 0.65rem;">개인</span>
                    <span class="badge text-bg-success" style="font-size: 0.65rem;">외국인</span>
                    <span class="badge text-bg-danger" style="font-size: 0.65rem;">기관</span>
                </div>
            </div>
            <div class="card-body p-2">
                <div style="height: 280px;">
                    <canvas id="investorTrendChart"></canvas>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header py-2">
                <strong>투자자별 매매동향</strong>
                <small class="text-muted ms-2">최근 60일</small>
            </div>
            <div class="card-body p-0">
                {% if investor_trends %}
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr class="small">
                                <th class="ps-3">일자</th>
                                <th class="text-end">개인</th>
                                <th class="text-end">외국인</th>
                                <th class="text-end">기관</th>
                                <th class="text-end">금융투자</th>
                                <th class="text-end">보험</th>
                                <th class="text-end">투신</th>
                                <th class="text-end">은행</th>
                                <th class="text-end">연기금</th>
                                <th class="text-end">사모</th>
                                <th class="text-end pe-3">기타법인</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in investor_trends %}
                            <tr class="small">
                                <td class="ps-3 text-muted">{{ t.date|date:"m.d" }}</td>
                                <td class="text-end {% if t.individual > 0 %}text-up{% elif t.individual < 0 %}text-down{% endif %}">{{ t.individual|intcomma }}</td>
                                <td class="text-end {% if t.foreign > 0 %}text-up{% elif t.foreign < 0 %}text-down{% endif %}">{{ t.foreign|intcomma }}</td>
                                <td class="text-end {% if t.institution > 0 %}text-up{% elif t.institution < 0 %}text-down{% endif %}">{{ t.institution|intcomma }}</td>
                                <td class="text-end {% if t.financial > 0 %}text-up{% elif t.financial < 0 %}text-down{% endif %}">{{ t.financial|intcomma }}</td>
                                <td class="text-end {% if t.insurance > 0 %}text-up{% elif t.insurance < 0 %}text-down{% endif %}">{{ t.insurance|intcomma }}</td>
                                <td class="text-end {% if t.investment_trust > 0 %}text-up{% elif t.investment_trust < 0 %}text-down{% endif %}">{{ t.investment_trust|intcomma }}</td>
                                <td class="text-end {% if t.bank > 0 %}text-up{% elif t.bank < 0 %}text-down{% endif %}">{{ t.bank|intcomma }}</td>
                                <td class="text-end {% if t.pension_fund > 0 %}text-up{% elif t.pension_fund < 0 %}text-down{% endif %}">{{ t.pension_fund|intcomma }}</td>
                                <td class="text-end {% if t.private_fund > 0 %}text-up{% elif t.private_fund < 0 %}text-down{% endif %}">{{ t.private_fund|intcomma }}</td>
                                <td class="text-end pe-3 {% if t.other_corporation > 0 %}text-up{% elif t.other_corporation < 0 %}text-down{% endif %}">{{ t.other_corporation|intcomma }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    수급 데이터가 없습니다.<br>
                    <code class="small">python manage.py save_investor_trend --code {{ stock.code }} --mode all</code>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 공매도 탭 -->
    <div class="tab-pane fade" id="shortsell-content" role="tabpanel">
        <div class="card">
            <div class="card-header py-2">
                <strong>공매도 현황</strong>
                <small class="text-muted ms-2">최근 60일</small>
            </div>
            <div class="card-body p-0">
                {% if short_sellings %}
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr class="small">
                                <th class="ps-3">일자</th>
                                <th class="text-end">거래량</th>
                                <th class="text-end">공매도량</th>
                                <th class="text-end">비중(%)</th>
                                <th class="text-end">공매도대금</th>
                                <th class="text-end pe-3">평균가</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in short_sellings %}
                            <tr class="small">
                                <td class="ps-3 text-muted">{{ s.date|date:"m.d" }}</td>
                                <td class="text-end">{{ s.trading_volume|intcomma }}</td>
                                <td class="text-end">{{ s.short_volume|intcomma }}</td>
                                <td class="text-end {% if s.trading_weight >= 10 %}text-danger fw-bold{% elif s.trading_weight >= 5 %}text-warning{% endif %}">{{ s.trading_weight }}%</td>
                                <td class="text-end">{{ s.short_trading_value|intcomma }}</td>
                                <td class="text-end pe-3">{{ s.short_average_price|intcomma }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    공매도 데이터가 없습니다.<br>
                    <code class="small">python manage.py save_short_selling --code {{ stock.code }} --mode all</code>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 공시 탭 -->
    <div class="tab-pane fade" id="disclosure-content" role="tabpanel">
        <div class="card">
            <div class="card-header py-2">
                <strong>DART 공시</strong>
                <small class="text-muted ms-2">전자공시시스템</small>
            </div>
            <div class="card-body">
                {% if gongsi_list %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3" style="width:100px;">접수일</th>
                                <th>보고서명</th>
                                <th style="width:100px;" class="d-none d-md-table-cell">제출인</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for gongsi in gongsi_list %}
                            <tr>
                                <td class="text-muted small ps-3">{{ gongsi.date|date:"Y-m-d"|default:"-" }}</td>
                                <td><a href="{{ gongsi.link }}" target="_blank" class="text-decoration-none">{{ gongsi.title }}</a></td>
                                <td class="small d-none d-md-table-cell">{{ gongsi.submitter }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-muted">공시가 없습니다. <code>python manage.py save_gongsi_stock --code {{ stock.code }}</code> 실행</div>
                {% endif %}

                <!-- 실시간 DART 조회 -->
                <div class="border-top mt-3 pt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">실시간 DART 조회 (저장 안됨)</small>
                        <button type="button" id="btnFetchDart" class="btn btn-sm btn-outline-primary">
                            불러오기
                        </button>
                    </div>
                    <div id="dartLoading" class="text-center py-3 d-none">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <span class="ms-2">불러오는 중... (5~10초 소요)</span>
                    </div>
                    <div id="dartResult" class="d-none"></div>
                </div>

                <!-- 텔레그램 공시 검색 -->
                <div class="border-top mt-3 pt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">텔레그램 공시 검색 (주식공시 채널, 최근 2주)</small>
                        <button type="button" id="btnSearchDisclosure" class="btn btn-sm btn-outline-warning">
                            검색
                        </button>
                    </div>
                    <div id="disclosureLoading" class="text-center py-3 d-none">
                        <div class="spinner-border spinner-border-sm text-warning" role="status"></div>
                        <span class="ms-2">검색 중...</span>
                    </div>
                    <div id="disclosureResult" class="d-none"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 리포트 탭 -->
    <div class="tab-pane fade" id="report-content" role="tabpanel">
        <!-- 주가 vs 목표가 차트 -->
        {% if reports %}
        <div class="card mb-3">
            <div class="card-header py-2">
                <strong>주가 vs 목표가</strong>
            </div>
            <div class="card-body">
                <canvas id="priceTargetChart" style="height: 250px;"></canvas>
            </div>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header py-2">
                <strong>애널리스트 리포트</strong>
                <small class="text-muted ms-2">최근 20개</small>
            </div>
            <div class="card-body">
                {% if reports %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 80px;">일자</th>
                                <th>제목</th>
                                <th style="width: 100px;" class="d-none d-md-table-cell">애널리스트</th>
                                <th style="width: 90px;" class="d-none d-md-table-cell">증권사</th>
                                <th style="width: 90px;" class="text-end">목표가</th>
                                <th style="width: 70px;" class="text-end">괴리율</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for report in reports %}
                            <tr>
                                <td class="text-muted small">{{ report.date|date:"y/m/d" }}</td>
                                <td class="text-truncate" style="max-width: 250px;" title="{{ report.title }}">
                                    <a href="#" class="text-decoration-none report-search-link" data-title="{{ report.title }}">{{ report.title }}</a>
                                </td>
                                <td class="small d-none d-md-table-cell">{{ report.author }}</td>
                                <td class="small d-none d-md-table-cell">{{ report.provider }}</td>
                                <td class="text-end">
                                    {% if report.target_price %}
                                    <strong class="text-danger">{{ report.target_price|intcomma }}원</strong>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {% if report.gap_rate != None %}
                                    <span class="{% if report.gap_rate > 0 %}text-danger{% elif report.gap_rate < 0 %}text-primary{% endif %}">
                                        {% if report.gap_rate > 0 %}+{% endif %}{{ report.gap_rate }}%
                                    </span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-muted p-3">리포트가 없습니다. <code>python manage.py save_fnguide_report --code {{ stock.code }}</code> 실행</div>
                {% endif %}
            </div>
        </div>

        <!-- 리포트 제목으로 텔레그램 검색 결과 -->
        <div id="reportSearchResult" class="card mt-3 d-none">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <div>
                    <strong>텔레그램 검색</strong>
                    <small class="text-muted ms-2" id="reportSearchKeyword"></small>
                </div>
                <button type="button" class="btn-close btn-sm" id="btnCloseReportSearch"></button>
            </div>
            <div class="card-body">
                <div id="reportSearchLoading" class="text-center py-3 d-none">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <span class="ms-2">검색 중...</span>
                </div>
                <div id="reportSearchTabs" class="d-none">
                    <ul class="nav nav-tabs" id="reportChannelTabs" role="tablist"></ul>
                    <div class="tab-content pt-3" id="reportChannelTabContent"></div>
                </div>
                <div id="reportSearchEmpty" class="text-muted d-none">검색 결과가 없습니다.</div>
            </div>
        </div>
    </div>

    <!-- 텔레그램 탭 -->
    <div class="tab-pane fade" id="telegram-content" role="tabpanel">
        <div class="card">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <div>
                    <strong>텔레그램 검색</strong>
                    <small class="text-muted ms-2">1주일 데이터, 최소 3개</small>
                </div>
                <button type="button" id="btnSearchTelegram" class="btn btn-sm btn-outline-primary">
                    검색
                </button>
            </div>
            <div class="card-body">
                <div id="telegramLoading" class="text-center py-3 d-none">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <span class="ms-2">검색 중...</span>
                </div>
                <div id="telegramTabs" class="d-none">
                    <ul class="nav nav-tabs" id="channelTabs" role="tablist"></ul>
                    <div class="tab-content pt-3" id="channelTabContent"></div>
                </div>
                <div id="telegramEmpty" class="text-muted">버튼을 클릭하면 "{{ stock.name }}" 검색 결과를 표시합니다.</div>
            </div>
        </div>
    </div>

    <!-- 뉴스 탭 -->
    <div class="tab-pane fade" id="news-content" role="tabpanel">
        <div class="card">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <div>
                    <strong>Google 뉴스</strong>
                    <small class="text-muted ms-2">"{{ stock.name }}" 검색</small>
                </div>
                <button type="button" id="btnSearchNews" class="btn btn-sm btn-outline-info">
                    검색
                </button>
            </div>
            <div class="card-body">
                <div id="newsLoading" class="text-center py-3 d-none">
                    <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                    <span class="ms-2">검색 중... (5~10초 소요)</span>
                </div>
                <div id="newsResult">
                    <div class="text-muted">버튼을 클릭하면 "{{ stock.name }}" 관련 최신 뉴스를 검색합니다.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 노다지 탭 -->
    <div class="tab-pane fade" id="nodaji-content" role="tabpanel">
        <div class="card">
            <div class="card-header py-2">
                <strong>노다지 IR노트</strong>
                <small class="text-muted ms-2">네이버 프리미엄 콘텐츠</small>
            </div>
            <div class="card-body">
                {% if nodaji_articles %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3" style="width:100px;">날짜</th>
                                <th>제목</th>
                                <th style="width:60px;" class="text-center">요약</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for article in nodaji_articles %}
                            <tr>
                                <td class="text-muted small ps-3">{{ article.date|date:"Y-m-d"|default:"-" }}</td>
                                <td><a href="{{ article.link }}" target="_blank" class="text-decoration-none">{{ article.title }}</a></td>
                                <td class="text-center">
                                    <a href="{% url 'stocks:nodaji_summary' article.id %}" target="_blank" class="text-decoration-none">
                                        {% if article.summary %}
                                        <span class="badge bg-success">O</span>
                                        {% else %}
                                        <span class="badge bg-secondary">-</span>
                                        {% endif %}
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-muted">노다지 기사가 없습니다.</div>
                {% endif %}

                <!-- 실시간 검색 -->
                <div class="border-top mt-3 pt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">실시간 검색 (저장 안됨)</small>
                        <button type="button" id="btnSearchNodaji" class="btn btn-sm btn-outline-success">
                            검색
                        </button>
                    </div>
                    <div id="nodajiLoading" class="text-center py-3 d-none">
                        <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                        <span class="ms-2">검색 중... (5~10초 소요)</span>
                    </div>
                    <div id="nodajiResult" class="d-none"></div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_css %}
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
/* Quill 에디터 스타일 */
.ql-container {
    font-size: 14px;
}
.ql-editor {
    min-height: 120px;
}
.highlight {
    background-color: #fff3cd;
    padding: 0 2px;
    border-radius: 2px;
    font-weight: bold;
}
/* 텔레그램 채널 탭 스타일 - 반응형 그리드 */
#channelTabs,
#reportChannelTabs {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px;
    border-bottom: none;
    padding-bottom: 8px;
    margin-bottom: 8px;
    border-bottom: 1px solid #dee2e6;
}
@media (min-width: 768px) {
    #channelTabs,
    #reportChannelTabs {
        grid-template-columns: repeat(6, 1fr);
    }
}
#channelTabs .nav-item,
#reportChannelTabs .nav-item {
    margin: 0;
}
#channelTabs .nav-link,
#reportChannelTabs .nav-link {
    display: block;
    width: 100%;
    padding: 4px 6px;
    font-size: 0.7rem;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    background: #f8f9fa;
    color: #495057;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
#channelTabs .nav-link:hover,
#reportChannelTabs .nav-link:hover {
    background: #e9ecef;
}
#channelTabs .nav-link.active,
#reportChannelTabs .nav-link.active {
    background: #0d6efd;
    color: white;
    border-color: #0d6efd;
}
#channelTabs .nav-link .badge,
#reportChannelTabs .nav-link .badge {
    font-size: 0.6rem;
    padding: 1px 3px;
    margin-left: 2px;
}
#channelTabs .nav-link.has-recent,
#reportChannelTabs .nav-link.has-recent {
    border-color: #dc3545;
    background: #fff5f5;
}
#channelTabs .nav-link.has-recent.active,
#reportChannelTabs .nav-link.has-recent.active {
    background: #dc3545;
    border-color: #dc3545;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
const stockName = "{{ stock.name }}";
const stockCode = "{{ stock.code }}";

// ============ 수급 누적 차트 ============
const investorChartData = {{ investor_chart_data|safe }};

if (investorChartData && investorChartData.length > 0) {
    const ctx = document.getElementById('investorTrendChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: investorChartData.map(d => d.date),
                datasets: [
                    { label: '개인', data: investorChartData.map(d => d.individual), borderColor: '#ffc107', borderWidth: 2, tension: 0.3, pointRadius: 2, fill: false },
                    { label: '외국인', data: investorChartData.map(d => d.foreign), borderColor: '#198754', borderWidth: 2, tension: 0.3, pointRadius: 2, fill: false },
                    { label: '기관', data: investorChartData.map(d => d.institution), borderColor: '#dc3545', borderWidth: 2, tension: 0.3, pointRadius: 2, fill: false }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.raw.toLocaleString('ko-KR') }}
                },
                scales: {
                    x: { grid: { display: false }, ticks: { maxTicksLimit: 10 }},
                    y: { ticks: { callback: v => Math.abs(v) >= 100000000 ? (v/100000000).toFixed(1)+'억' : Math.abs(v) >= 10000 ? (v/10000).toFixed(1)+'만' : v.toFixed(0) }, grid: { color: '#f0f0f0' }}
                }
            }
        });
    }
}

// ============ Quill 에디터 초기화 ============
const quillOptions = {
    theme: 'snow',
    modules: {
        toolbar: [
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['link'],
            ['clean']
        ]
    }
};

const investmentPointEditor = new Quill('#investmentPointEditor', quillOptions);
const riskEditor = new Quill('#riskEditor', quillOptions);
const analysisEditor = new Quill('#analysisEditor', quillOptions);

// 폼 제출 시 에디터 내용을 hidden input에 복사
document.querySelector('form').addEventListener('submit', function(e) {
    document.getElementById('investmentPointInput').value = investmentPointEditor.root.innerHTML;
    document.getElementById('riskInput').value = riskEditor.root.innerHTML;
    document.getElementById('analysisInput').value = analysisEditor.root.innerHTML;
});

// ============ 일정 관리 ============
const btnAddSchedule = document.getElementById('btnAddSchedule');
const scheduleAddForm = document.getElementById('scheduleAddForm');
const btnSaveSchedule = document.getElementById('btnSaveSchedule');
const scheduleBody = document.getElementById('scheduleBody');

// 추가 버튼 클릭 - 폼 토글
btnAddSchedule.addEventListener('click', () => {
    scheduleAddForm.classList.toggle('d-none');
    if (!scheduleAddForm.classList.contains('d-none')) {
        document.getElementById('scheduleAddDateText').focus();
    }
});

// 저장 버튼 클릭
btnSaveSchedule.addEventListener('click', async () => {
    const dateText = document.getElementById('scheduleAddDateText').value.trim();
    const dateSort = document.getElementById('scheduleAddDateSort').value;
    const content = document.getElementById('scheduleAddContent').value.trim();

    if (!dateText || !content) {
        alert('날짜와 내용을 입력해주세요.');
        return;
    }

    btnSaveSchedule.disabled = true;

    try {
        const formData = new FormData();
        formData.append('date_text', dateText);
        formData.append('date_sort', dateSort);
        formData.append('content', content);

        const response = await fetch(`/api/schedule/${stockCode}/add/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });

        const data = await response.json();

        if (data.success) {
            // 빈 메시지 제거
            const emptyRow = document.getElementById('scheduleEmpty');
            if (emptyRow) emptyRow.remove();

            // 새 행 추가
            const newRow = document.createElement('tr');
            newRow.dataset.id = data.id;
            newRow.innerHTML = `
                <td class="ps-3">${data.date_text}</td>
                <td class="text-muted small">${data.date_sort || '-'}</td>
                <td>${data.content}</td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-outline-danger btn-delete-schedule" data-id="${data.id}">×</button>
                </td>
            `;
            scheduleBody.appendChild(newRow);

            // 폼 초기화 및 숨김
            document.getElementById('scheduleAddDateText').value = '';
            document.getElementById('scheduleAddDateSort').value = '';
            document.getElementById('scheduleAddContent').value = '';
            scheduleAddForm.classList.add('d-none');
        } else {
            alert(data.error || '저장에 실패했습니다.');
        }
    } catch (err) {
        alert('오류: ' + err.message);
    } finally {
        btnSaveSchedule.disabled = false;
    }
});

// 삭제 버튼 클릭 (이벤트 위임)
scheduleBody.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('btn-delete-schedule')) return;

    const scheduleId = e.target.dataset.id;
    if (!confirm('이 일정을 삭제하시겠습니까?')) return;

    e.target.disabled = true;

    try {
        const formData = new FormData();
        const response = await fetch(`/api/schedule/${scheduleId}/delete/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });

        const data = await response.json();

        if (data.success) {
            // 행 제거
            const row = e.target.closest('tr');
            row.remove();

            // 남은 행이 없으면 빈 메시지 표시
            if (scheduleBody.querySelectorAll('tr').length === 0) {
                scheduleBody.innerHTML = `
                    <tr id="scheduleEmpty">
                        <td colspan="4" class="text-center text-muted py-3">등록된 일정이 없습니다.</td>
                    </tr>
                `;
            }
        } else {
            alert(data.error || '삭제에 실패했습니다.');
            e.target.disabled = false;
        }
    } catch (err) {
        alert('오류: ' + err.message);
        e.target.disabled = false;
    }
});

// ============ 주가 vs 목표가 차트 ============
const priceChartData = {{ price_chart_data|safe }};
const targetChartData = {{ target_chart_data|safe }};
const gapChartData = {{ gap_chart_data|safe }};
let priceTargetChart = null;

function initPriceTargetChart() {
    if (priceTargetChart) return;
    if (priceChartData.length === 0) return;

    const ctx = document.getElementById('priceTargetChart');
    if (!ctx) return;

    // 날짜 라벨 추출
    const labels = priceChartData.map(d => d.x);
    const priceValues = priceChartData.map(d => d.y);

    // 목표가를 같은 x축에 매핑
    const targetMap = {};
    targetChartData.forEach(d => { targetMap[d.x] = d.y; });
    const targetValues = labels.map(date => targetMap[date] || null);

    // 괴리율을 같은 x축에 매핑
    const gapMap = {};
    gapChartData.forEach(d => { gapMap[d.x] = d.y; });
    const gapValues = labels.map(date => gapMap[date] !== undefined ? gapMap[date] : null);

    priceTargetChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '종가',
                    data: priceValues,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1,
                    fill: true,
                    yAxisID: 'y'
                },
                {
                    label: '목표가',
                    data: targetValues,
                    borderColor: '#dc3545',
                    backgroundColor: '#dc3545',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.1,
                    spanGaps: true,
                    yAxisID: 'y'
                },
                {
                    label: '괴리율',
                    data: gapValues,
                    borderColor: '#198754',
                    backgroundColor: '#198754',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.1,
                    spanGaps: true,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        boxWidth: 8
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (context.parsed.y === null) return null;
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.dataset.yAxisID === 'y1') {
                                label += context.parsed.y + '%';
                            } else {
                                label += new Intl.NumberFormat('ko-KR').format(context.parsed.y) + '원';
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    ticks: {
                        maxTicksLimit: 6,
                        callback: function(value, index) {
                            const label = this.getLabelForValue(value);
                            return label ? label.substring(2, 10) : '';
                        }
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    type: 'linear',
                    position: 'left',
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return new Intl.NumberFormat('ko-KR').format(value);
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: false,
                    grid: {
                        drawOnChartArea: false
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

// 리포트 탭 활성화 시 차트 생성
document.getElementById('report-tab').addEventListener('shown.bs.tab', function() {
    initPriceTargetChart();
});

// ============ 리포트 제목으로 텔레그램 검색 ============
const reportSearchResult = document.getElementById('reportSearchResult');
const reportSearchKeyword = document.getElementById('reportSearchKeyword');
const reportSearchLoading = document.getElementById('reportSearchLoading');
const reportSearchTabs = document.getElementById('reportSearchTabs');
const reportChannelTabs = document.getElementById('reportChannelTabs');
const reportChannelTabContent = document.getElementById('reportChannelTabContent');
const reportSearchEmpty = document.getElementById('reportSearchEmpty');
const btnCloseReportSearch = document.getElementById('btnCloseReportSearch');

// 닫기 버튼
btnCloseReportSearch.addEventListener('click', () => {
    reportSearchResult.classList.add('d-none');
});

// 리포트 제목 클릭 이벤트
document.querySelectorAll('.report-search-link').forEach(link => {
    link.addEventListener('click', async (e) => {
        e.preventDefault();
        const keyword = link.dataset.title;

        // UI 초기화
        reportSearchKeyword.textContent = `"${keyword}"`;
        reportSearchResult.classList.remove('d-none');
        reportSearchLoading.classList.remove('d-none');
        reportSearchTabs.classList.add('d-none');
        reportSearchEmpty.classList.add('d-none');
        reportChannelTabs.innerHTML = '';
        reportChannelTabContent.innerHTML = '';

        // 결과 영역으로 스크롤
        reportSearchResult.scrollIntoView({ behavior: 'smooth', block: 'start' });

        try {
            const response = await fetch(`/api/telegram/search/?keyword=${encodeURIComponent(keyword)}&limit=30&days=180`);
            const data = await response.json();

            if (data.error) {
                reportChannelTabContent.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                reportSearchTabs.classList.remove('d-none');
                return;
            }

            const channels = Object.keys(data.results);
            const channelNames = data.channel_names || {};
            let tabsHtml = '';
            let contentHtml = '';

            // 전체 문구가 포함된 메시지만 필터링한 결과로 탭 생성
            channels.forEach((channel) => {
                const channelData = data.results[channel];
                const filteredData = filterByKeyword(channelData, keyword);
                const totalCount = Object.values(filteredData).reduce((sum, arr) => sum + arr.length, 0);

                if (totalCount === 0) return;

                const channelId = 'rpt_' + channel.replace('@', '');
                const displayName = channelNames[channel] || channel;
                const isFirst = tabsHtml === '';

                tabsHtml += `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ${isFirst ? 'active' : ''}"
                                id="${channelId}-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#${channelId}-content"
                                type="button" role="tab">
                            ${displayName} <span class="badge bg-secondary">${totalCount}</span>
                        </button>
                    </li>`;

                contentHtml += `
                    <div class="tab-pane fade ${isFirst ? 'show active' : ''}"
                         id="${channelId}-content" role="tabpanel">
                        ${renderReportChannelContent(filteredData, keyword)}
                    </div>`;
            });

            if (tabsHtml) {
                reportChannelTabs.innerHTML = tabsHtml;
                reportChannelTabContent.innerHTML = contentHtml;
                reportSearchTabs.classList.remove('d-none');
            } else {
                reportSearchEmpty.classList.remove('d-none');
            }

        } catch (err) {
            reportChannelTabContent.innerHTML = `<div class="alert alert-danger">오류: ${err.message}</div>`;
            reportSearchTabs.classList.remove('d-none');
        } finally {
            reportSearchLoading.classList.add('d-none');
        }
    });
});

// 전체 문구로 필터링
function filterByKeyword(channelData, keyword) {
    const result = {};
    for (const date in channelData) {
        const filtered = channelData[date].filter(item => item.text.includes(keyword));
        if (filtered.length > 0) {
            result[date] = filtered;
        }
    }
    return result;
}

function renderReportChannelContent(channelData, keyword) {
    const dates = Object.keys(channelData).sort().reverse();
    if (dates.length === 0) {
        return '<div class="text-muted">검색 결과가 없습니다.</div>';
    }

    let html = '';
    for (const date of dates) {
        const items = channelData[date];
        html += `<div class="mb-3">`;
        html += `<h6 class="text-primary mb-2">${date} (${items.length}건)</h6>`;
        items.forEach((item, idx) => {
            let text = item.text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            text = linkify(text);
            text = highlightKeyword(text, keyword);
            html += `<div class="border-start border-2 border-success ps-2 py-2 small bg-light mb-0">`;
            html += `<span class="text-muted">[${item.time}]</span> `;
            html += `<span style="white-space: pre-wrap;">${text}</span>`;
            html += `</div>`;
            if (idx < items.length - 1) {
                html += `<hr class="my-2">`;
            }
        });
        html += `</div>`;
    }
    return html;
}

// ============ 노다지 실시간 검색 ============
const btnNodaji = document.getElementById('btnSearchNodaji');
const nodajiLoading = document.getElementById('nodajiLoading');
const nodajiResult = document.getElementById('nodajiResult');

btnNodaji.addEventListener('click', async () => {
    btnNodaji.disabled = true;
    nodajiLoading.classList.remove('d-none');
    nodajiResult.classList.add('d-none');

    try {
        const response = await fetch(`/api/nodaji/search/?keyword=${encodeURIComponent(stockName)}`);
        const data = await response.json();

        if (data.error) {
            nodajiResult.innerHTML = `<div class="alert alert-danger mb-0">${data.error}</div>`;
        } else if (data.results.length === 0) {
            nodajiResult.innerHTML = '<div class="text-muted">검색 결과가 없습니다.</div>';
        } else {
            // 날짜순 정렬 (최신순)
            const sortedResults = [...data.results].sort((a, b) => {
                const dateA = parseDateString(a.date);
                const dateB = parseDateString(b.date);
                return dateB - dateA;
            });

            let html = '<div class="table-responsive"><table class="table table-sm table-hover mb-0">';
            html += '<thead class="table-light"><tr><th class="ps-3" style="width:100px;">날짜</th><th>제목</th></tr></thead><tbody>';
            sortedResults.forEach(item => {
                html += `<tr>`;
                html += `<td class="text-muted small ps-3">${item.date}</td>`;
                html += `<td><a href="${item.link}" target="_blank" class="text-decoration-none">${item.title}</a></td>`;
                html += `</tr>`;
            });
            html += '</tbody></table></div>';
            nodajiResult.innerHTML = html;
        }
        nodajiResult.classList.remove('d-none');

    } catch (err) {
        nodajiResult.innerHTML = `<div class="alert alert-danger mb-0">오류: ${err.message}</div>`;
        nodajiResult.classList.remove('d-none');
    } finally {
        btnNodaji.disabled = false;
        nodajiLoading.classList.add('d-none');
    }
});

// ============ DART 공시 실시간 조회 ============
const btnDart = document.getElementById('btnFetchDart');
const dartLoading = document.getElementById('dartLoading');
const dartResult = document.getElementById('dartResult');

btnDart.addEventListener('click', async () => {
    btnDart.disabled = true;
    dartLoading.classList.remove('d-none');
    dartResult.classList.add('d-none');

    try {
        const response = await fetch(`/api/dart/${stockCode}/`);
        const data = await response.json();

        if (data.error) {
            dartResult.innerHTML = `<div class="alert alert-danger mb-0">${data.error}</div>`;
        } else if (data.results.length === 0) {
            dartResult.innerHTML = '<div class="text-muted">공시 정보가 없습니다.</div>';
        } else {
            let html = '<div class="table-responsive"><table class="table table-sm table-hover mb-0">';
            html += '<thead class="table-light"><tr><th class="ps-3" style="width:100px;">접수일</th><th>보고서명</th><th class="d-none d-md-table-cell" style="width:100px;">제출인</th></tr></thead><tbody>';
            data.results.forEach(item => {
                html += `<tr>`;
                html += `<td class="text-muted small ps-3">${item.date}</td>`;
                html += `<td><a href="${item.link}" target="_blank" class="text-decoration-none">${item.title}</a></td>`;
                html += `<td class="small d-none d-md-table-cell">${item.submitter || ''}</td>`;
                html += `</tr>`;
            });
            html += '</tbody></table></div>';
            dartResult.innerHTML = html;
        }
        dartResult.classList.remove('d-none');

    } catch (err) {
        dartResult.innerHTML = `<div class="alert alert-danger mb-0">오류: ${err.message}</div>`;
        dartResult.classList.remove('d-none');
    } finally {
        btnDart.disabled = false;
        dartLoading.classList.add('d-none');
    }
});

// ============ 업종 선택 ============
const themeSelect = document.getElementById('themeSelect');
const btnAddThemeToStock = document.getElementById('btnAddThemeToStock');
const selectedThemes = document.getElementById('selectedThemes');
const themeInputs = document.getElementById('themeInputs');

if (btnAddThemeToStock) {
    btnAddThemeToStock.addEventListener('click', () => {
        const select = themeSelect;
        const themeId = select.value;
        if (!themeId) return;

        // 이미 선택된 테마인지 확인
        if (themeInputs.querySelector(`input[value="${themeId}"]`)) {
            alert('이미 선택된 업종입니다.');
            return;
        }

        const option = select.options[select.selectedIndex];
        const categoryName = option.dataset.category;
        const themeName = option.dataset.name;

        // "선택된 업종이 없습니다" 메시지 제거
        const noMsg = document.getElementById('noThemeMsg');
        if (noMsg) noMsg.remove();

        // 뱃지 추가
        const badge = document.createElement('span');
        badge.className = 'badge bg-primary d-flex align-items-center selected-theme';
        badge.dataset.id = themeId;
        badge.innerHTML = `${categoryName} &gt; ${themeName}<button type="button" class="btn-close btn-close-white ms-1 btn-remove-theme" style="font-size: 0.5rem;"></button>`;
        selectedThemes.appendChild(badge);

        // hidden input 추가
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'themes';
        input.value = themeId;
        themeInputs.appendChild(input);

        // 선택 초기화
        select.value = '';
    });

    // 테마 삭제 (이벤트 위임)
    selectedThemes.addEventListener('click', (e) => {
        if (!e.target.classList.contains('btn-remove-theme')) return;

        const badge = e.target.closest('.selected-theme');
        const themeId = badge.dataset.id;

        // 뱃지 제거
        badge.remove();

        // hidden input 제거
        const input = themeInputs.querySelector(`input[value="${themeId}"]`);
        if (input) input.remove();

        // 남은 테마가 없으면 메시지 표시
        if (selectedThemes.querySelectorAll('.selected-theme').length === 0) {
            selectedThemes.innerHTML = '<span class="text-muted small" id="noThemeMsg">선택된 업종이 없습니다.</span>';
        }
    });
}

// 공통 함수
function linkify(text) {
    const urlRegex = /(https?:\/\/[^\s<]+)/g;
    return text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener">$1</a>');
}

function highlightKeyword(text, keyword) {
    if (!keyword) return text;
    const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
}

// 날짜 문자열 파싱 (정렬용)
function parseDateString(dateStr) {
    if (!dateStr) return new Date(0);

    // "2024.12.06" 형식
    if (dateStr.includes('.') && dateStr.length >= 10) {
        const match = dateStr.match(/(\d{4})\.(\d{1,2})\.(\d{1,2})/);
        if (match) {
            return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
        }
    }

    // "12월 6일" 형식
    const monthDayMatch = dateStr.match(/(\d+)월\s*(\d+)일/);
    if (monthDayMatch) {
        const year = new Date().getFullYear();
        return new Date(year, parseInt(monthDayMatch[1]) - 1, parseInt(monthDayMatch[2]));
    }

    return new Date(0);
}

// ============ 텔레그램 공시 검색 ============
const btnDisclosure = document.getElementById('btnSearchDisclosure');
const disclosureLoading = document.getElementById('disclosureLoading');
const disclosureResult = document.getElementById('disclosureResult');

function renderDisclosureContent(data) {
    const dates = Object.keys(data).sort().reverse();
    if (dates.length === 0) {
        return '<div class="text-muted">검색 결과가 없습니다.</div>';
    }

    let html = '';
    for (const date of dates) {
        const items = data[date];
        html += `<div class="mb-3">`;
        html += `<h6 class="text-warning mb-2">${date} (${items.length}건)</h6>`;
        items.forEach((item, idx) => {
            let text = item.text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            text = linkify(text);
            text = highlightKeyword(text, stockName);
            html += `<div class="border-start border-2 border-warning ps-2 py-2 small bg-light mb-0">`;
            html += `<span class="text-muted">[${item.time}]</span> `;
            html += `<span style="white-space: pre-wrap;">${text}</span>`;
            html += `</div>`;
            if (idx < items.length - 1) {
                html += `<hr class="my-2">`;
            }
        });
        html += `</div>`;
    }
    return html;
}

btnDisclosure.addEventListener('click', async () => {
    btnDisclosure.disabled = true;
    disclosureLoading.classList.remove('d-none');
    disclosureResult.classList.add('d-none');

    try {
        const response = await fetch(`/api/disclosure/search/?keyword=${encodeURIComponent(stockName)}&limit=50`);
        const data = await response.json();

        if (data.error) {
            disclosureResult.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else if (Object.keys(data.results).length === 0) {
            disclosureResult.innerHTML = '<div class="text-muted">검색 결과가 없습니다.</div>';
        } else {
            disclosureResult.innerHTML = renderDisclosureContent(data.results);
        }
        disclosureResult.classList.remove('d-none');

    } catch (err) {
        disclosureResult.innerHTML = `<div class="alert alert-danger">오류: ${err.message}</div>`;
        disclosureResult.classList.remove('d-none');
    } finally {
        btnDisclosure.disabled = false;
        disclosureLoading.classList.add('d-none');
    }
});

// ============ 텔레그램 검색 ============
const btnTelegram = document.getElementById('btnSearchTelegram');
const telegramLoading = document.getElementById('telegramLoading');
const telegramTabs = document.getElementById('telegramTabs');
const channelTabs = document.getElementById('channelTabs');
const channelTabContent = document.getElementById('channelTabContent');
const telegramEmpty = document.getElementById('telegramEmpty');

function renderChannelContent(channelData) {
    const dates = Object.keys(channelData).sort().reverse();
    if (dates.length === 0) {
        return '<div class="text-muted">검색 결과가 없습니다.</div>';
    }

    let html = '';
    for (const date of dates) {
        const items = channelData[date];
        html += `<div class="mb-3">`;
        html += `<h6 class="text-primary mb-2">${date} (${items.length}건)</h6>`;
        items.forEach((item, idx) => {
            let text = item.text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            text = linkify(text);
            text = highlightKeyword(text, stockName);
            html += `<div class="border-start border-2 border-primary ps-2 py-2 small bg-light mb-0">`;
            html += `<span class="text-muted">[${item.time}]</span> `;
            html += `<span style="white-space: pre-wrap;">${text}</span>`;
            html += `</div>`;
            if (idx < items.length - 1) {
                html += `<hr class="my-2">`;
            }
        });
        html += `</div>`;
    }
    return html;
}

function countMessages(channelData) {
    let total = 0;
    let recent = 0;
    const today = new Date();
    const threeDaysAgo = new Date(today.getTime() - 3 * 24 * 60 * 60 * 1000);
    const threeDaysAgoStr = threeDaysAgo.toISOString().split('T')[0];

    for (const date in channelData) {
        const count = channelData[date].length;
        total += count;
        if (date >= threeDaysAgoStr) {
            recent += count;
        }
    }
    return { total, recent };
}

btnTelegram.addEventListener('click', async () => {
    btnTelegram.disabled = true;
    telegramLoading.classList.remove('d-none');
    telegramTabs.classList.add('d-none');
    channelTabs.innerHTML = '';
    channelTabContent.innerHTML = '';
    telegramEmpty.classList.add('d-none');

    try {
        const response = await fetch(`/api/telegram/search/?keyword=${encodeURIComponent(stockName)}&limit=30`);
        const data = await response.json();

        if (data.error) {
            channelTabContent.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            telegramTabs.classList.remove('d-none');
            return;
        }

        const channels = Object.keys(data.results);
        const channelNames = data.channel_names || {};
        let tabsHtml = '';
        let contentHtml = '';

        channels.forEach((channel, idx) => {
            const channelId = channel.replace('@', '');
            const displayName = channelNames[channel] || channel;
            const isActive = idx === 0;
            const { total, recent } = countMessages(data.results[channel]);

            const recentBadge = recent > 0 ? `<span class="badge bg-danger">${recent}</span>` : '';
            const totalBadge = total > 0 ? `<span class="badge bg-secondary">${total}</span>` : '';

            tabsHtml += `
                <li class="nav-item" role="presentation">
                    <button class="nav-link ${isActive ? 'active' : ''} ${recent > 0 ? 'has-recent' : ''}"
                            id="${channelId}-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#${channelId}-content"
                            type="button" role="tab">
                        ${displayName} ${recentBadge}${totalBadge}
                    </button>
                </li>`;

            contentHtml += `
                <div class="tab-pane fade ${isActive ? 'show active' : ''}"
                     id="${channelId}-content" role="tabpanel">
                    ${renderChannelContent(data.results[channel])}
                </div>`;
        });

        channelTabs.innerHTML = tabsHtml;
        channelTabContent.innerHTML = contentHtml;
        telegramTabs.classList.remove('d-none');

    } catch (err) {
        channelTabContent.innerHTML = `<div class="alert alert-danger">오류: ${err.message}</div>`;
        telegramTabs.classList.remove('d-none');
    } finally {
        btnTelegram.disabled = false;
        telegramLoading.classList.add('d-none');
    }
});

// ============ Google 뉴스 검색 ============
const btnNews = document.getElementById('btnSearchNews');
const newsLoading = document.getElementById('newsLoading');
const newsResult = document.getElementById('newsResult');

btnNews.addEventListener('click', async () => {
    btnNews.disabled = true;
    newsLoading.classList.remove('d-none');
    newsResult.innerHTML = '';

    try {
        const response = await fetch(`/api/news/search/?keyword=${encodeURIComponent(stockName)}`);
        const data = await response.json();

        if (data.error) {
            newsResult.innerHTML = `<div class="alert alert-danger mb-0">${data.error}</div>`;
        } else if (data.results.length === 0) {
            newsResult.innerHTML = '<div class="text-muted">검색 결과가 없습니다.</div>';
        } else {
            let html = '<div class="table-responsive"><table class="table table-sm table-hover mb-0">';
            html += '<thead class="table-light"><tr><th class="ps-3" style="width:130px;">날짜</th><th>제목</th><th style="width:150px;" class="d-none d-md-table-cell">출처</th></tr></thead><tbody>';
            data.results.forEach(item => {
                html += `<tr>`;
                html += `<td class="text-muted ps-3" style="font-size:0.75rem;">${item.date || '-'}</td>`;
                html += `<td><a href="${item.link}" target="_blank" class="text-decoration-none">${item.title}</a></td>`;
                html += `<td class="text-muted d-none d-md-table-cell" style="font-size:0.75rem;">${item.source || ''}</td>`;
                html += `</tr>`;
            });
            html += '</tbody></table></div>';
            newsResult.innerHTML = html;
        }

    } catch (err) {
        newsResult.innerHTML = `<div class="alert alert-danger mb-0">오류: ${err.message}</div>`;
    } finally {
        btnNews.disabled = false;
        newsLoading.classList.add('d-none');
    }
});
</script>
{% endblock %}
