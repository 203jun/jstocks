{% extends 'stocks/base.html' %}
{% load humanize %}

{% block title %}{{ stock.name }} 편집 - JStocks{% endblock %}

{% block content %}
<!-- 종목 헤더 -->
<div class="d-flex justify-content-between align-items-start mb-3">
    <div>
        <h4 class="mb-1">{{ stock.name }}</h4>
        <span class="text-muted">{{ stock.code }}</span>
        <span class="badge bg-secondary ms-1">{{ stock.market }}</span>
    </div>
    <a href="{% url 'stocks:stock_detail' stock.code %}" class="btn btn-outline-secondary btn-sm">상세</a>
</div>

<!-- 메인 탭 -->
<ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-content" type="button" role="tab">기본정보</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="supply-tab" data-bs-toggle="tab" data-bs-target="#supply-content" type="button" role="tab">수급</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="shortsell-tab" data-bs-toggle="tab" data-bs-target="#shortsell-content" type="button" role="tab">공매도</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="disclosure-tab" data-bs-toggle="tab" data-bs-target="#disclosure-content" type="button" role="tab">공시</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report-content" type="button" role="tab">리포트</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="telegram-tab" data-bs-toggle="tab" data-bs-target="#telegram-content" type="button" role="tab">텔레그램</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="news-tab" data-bs-toggle="tab" data-bs-target="#news-content" type="button" role="tab">뉴스</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="nodaji-tab" data-bs-toggle="tab" data-bs-target="#nodaji-content" type="button" role="tab">노다지</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="youtube-tab" data-bs-toggle="tab" data-bs-target="#youtube-content" type="button" role="tab">유튜브</button>
    </li>
</ul>

<div class="tab-content" id="mainTabContent">
    <!-- 기본정보 탭 -->
    <div class="tab-pane fade show active" id="info-content" role="tabpanel">
        <form method="post">
            {% csrf_token %}

            <div class="card mb-3">
                <div class="card-header py-2">
                    <strong>관심 단계</strong>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <select name="interest_level" class="form-select">
                                <option value="">선택 안함</option>
                                {% for value, label in interest_choices %}
                                <option value="{{ value }}" {% if stock.interest_level == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                            <div class="mt-2">
                                {% if stock.fav_sync_status == 'syncing' %}
                                <span class="badge bg-warning text-dark">
                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                    데이터 수집 중...
                                </span>
                                <small class="text-muted ms-2">페이지를 새로고침하여 완료 여부를 확인하세요.</small>
                                {% elif stock.fav_sync_status == 'deleting' %}
                                <span class="badge bg-danger">
                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                    데이터 삭제 중...
                                </span>
                                <small class="text-muted ms-2">페이지를 새로고침하여 완료 여부를 확인하세요.</small>
                                {% elif stock.fav_sync_status == 'completed' %}
                                <span class="badge bg-success">데이터 수집 완료</span>
                                {% else %}
                                <small class="text-muted">초관심 > 관심 > 인큐베이터 순으로 중요도가 높습니다.</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mt-2">
                                <input type="checkbox" class="form-check-input" id="is_holding" name="is_holding" {% if stock.is_holding %}checked{% endif %}>
                                <label class="form-check-label" for="is_holding">
                                    <strong>보유중</strong>
                                    <small class="text-muted ms-1">현재 이 종목을 보유하고 있음</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header py-2">
                    <strong>업종</strong>
                    <a href="{% url 'stocks:settings' %}" class="text-muted small ms-2" target="_blank">관리</a>
                </div>
                <div class="card-body py-2">
                    {% if theme_categories %}
                    <!-- 선택된 테마 표시 -->
                    <div id="selectedThemes" class="d-flex flex-wrap gap-1 mb-2">
                        {% for theme in stock.themes.all %}
                        <span class="badge bg-primary d-flex align-items-center selected-theme" data-id="{{ theme.id }}">
                            {{ theme.category.name }} &gt; {{ theme.name }}
                            <button type="button" class="btn-close btn-close-white ms-1 btn-remove-theme" style="font-size: 0.5rem;"></button>
                        </span>
                        {% empty %}
                        <span class="text-muted small" id="noThemeMsg">선택된 업종이 없습니다.</span>
                        {% endfor %}
                    </div>
                    <!-- 테마 추가 드롭다운 -->
                    <div class="d-flex gap-2 align-items-center">
                        <select id="themeSelect" class="form-select form-select-sm" style="max-width: 300px;">
                            <option value="">업종 선택...</option>
                            {% for category in theme_categories %}
                            <optgroup label="{{ category.name }}">
                                {% for theme in category.themes.all %}
                                <option value="{{ theme.id }}" data-category="{{ category.name }}" data-name="{{ theme.name }}">{{ theme.name }}</option>
                                {% endfor %}
                            </optgroup>
                            {% endfor %}
                        </select>
                        <button type="button" id="btnAddThemeToStock" class="btn btn-sm btn-outline-primary">추가</button>
                    </div>
                    <!-- hidden inputs -->
                    <div id="themeInputs">
                        {% for theme in stock.themes.all %}
                        <input type="hidden" name="themes" value="{{ theme.id }}">
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-muted small">
                        등록된 업종이 없습니다. <a href="{% url 'stocks:settings' %}" target="_blank">설정</a>에서 업종을 추가하세요.
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header py-2">
                    <strong>인사이트</strong>
                </div>
                <div class="card-body">
                    <!-- 인사이트 탭 -->
                    <ul class="nav nav-tabs nav-tabs-sm mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="insight-summary-tab" data-bs-toggle="tab" data-bs-target="#insight-summary-panel" type="button" role="tab">요약</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="insight-report-tab" data-bs-toggle="tab" data-bs-target="#insight-report-panel" type="button" role="tab">리포트</button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <!-- 요약 탭 -->
                        <div class="tab-pane fade show active" id="insight-summary-panel" role="tabpanel">
                            <textarea class="form-control font-monospace" name="insight_summary_html" id="insightSummaryInput" rows="10" style="font-size: 0.85em;" placeholder="요약 HTML 코드를 붙여넣으세요...">{{ stock.insight_summary_html }}</textarea>
                            <small class="text-muted">HTML 코드를 붙여넣으면 요약으로 저장됩니다.</small>
                        </div>
                        <!-- 리포트 탭 -->
                        <div class="tab-pane fade" id="insight-report-panel" role="tabpanel">
                            <textarea class="form-control font-monospace" name="insight_report_html" id="insightReportInput" rows="10" style="font-size: 0.85em;" placeholder="리포트 HTML 코드를 붙여넣으세요...">{{ stock.insight_report_html }}</textarea>
                            <small class="text-muted">HTML 코드를 붙여넣으면 리포트로 저장됩니다. 딥리서치로 생성 실패할 경우 리서치 결과와 프롬프트만 가져와서 도구 없이 요청해도 됩니다.</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header py-2">
                    <strong>메모</strong>
                    <small class="text-muted ms-2">(마크다운 지원)</small>
                </div>
                <div class="card-body">
                    <textarea class="form-control" name="memo" id="memoInput" rows="6" placeholder="마크다운 형식으로 입력하세요...">{{ stock.memo }}</textarea>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header py-2">
                    <strong>기업분석</strong>
                </div>
                <div class="card-body">
                    <!-- 기업분석 탭 -->
                    <ul class="nav nav-tabs nav-tabs-sm mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="analysis-summary-tab" data-bs-toggle="tab" data-bs-target="#analysis-summary-panel" type="button" role="tab">요약</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="analysis-report-tab" data-bs-toggle="tab" data-bs-target="#analysis-report-panel" type="button" role="tab">리포트</button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <!-- 요약 탭 -->
                        <div class="tab-pane fade show active" id="analysis-summary-panel" role="tabpanel">
                            <textarea class="form-control font-monospace" name="analysis_text" id="analysisSummaryInput" rows="10" style="font-size: 0.85em;" placeholder="요약 HTML 코드를 붙여넣으세요...">{{ stock.analysis_text }}</textarea>
                            <small class="text-muted">HTML 코드를 붙여넣으면 요약으로 저장됩니다.</small>
                        </div>
                        <!-- 리포트 탭 -->
                        <div class="tab-pane fade" id="analysis-report-panel" role="tabpanel">
                            <textarea class="form-control font-monospace" name="analysis_html" id="analysisReportInput" rows="10" style="font-size: 0.85em;" placeholder="리포트 HTML 코드를 붙여넣으세요...">{{ analysis_html_content }}</textarea>
                            <small class="text-muted">HTML 코드를 붙여넣으면 리포트로 저장됩니다.</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">저장</button>
                <a href="{% url 'stocks:stock_detail' stock.code %}" class="btn btn-outline-secondary">취소</a>
            </div>
        </form>
    </div>

    <!-- 수급 탭 -->
    <div class="tab-pane fade" id="supply-content" role="tabpanel">
        <!-- 누적 순매수 차트 -->
        {% if investor_trends %}
        <div class="card mb-3">
            <div class="card-header py-2 d-flex align-items-center justify-content-between">
                <strong>누적 순매수</strong>
                <div class="d-flex gap-1">
                    <span class="badge text-bg-warning text-dark" style="font-size: 0.65rem;">개인</span>
                    <span class="badge text-bg-success" style="font-size: 0.65rem;">외국인</span>
                    <span class="badge text-bg-danger" style="font-size: 0.65rem;">기관</span>
                </div>
            </div>
            <div class="card-body p-2">
                <div style="height: 280px;">
                    <canvas id="investorTrendChart"></canvas>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header py-2">
                <strong>투자자별 매매동향</strong>
                <small class="text-muted ms-2">최근 60일</small>
            </div>
            <div class="card-body p-0">
                {% if investor_trends %}
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr class="small">
                                <th class="ps-3">일자</th>
                                <th class="text-end">개인</th>
                                <th class="text-end">외국인</th>
                                <th class="text-end">기관</th>
                                <th class="text-end">금융투자</th>
                                <th class="text-end">보험</th>
                                <th class="text-end">투신</th>
                                <th class="text-end">은행</th>
                                <th class="text-end">연기금</th>
                                <th class="text-end">사모</th>
                                <th class="text-end pe-3">기타법인</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in investor_trends %}
                            <tr class="small">
                                <td class="ps-3 text-muted">{{ t.date|date:"m.d" }}</td>
                                <td class="text-end {% if t.individual > 0 %}text-up{% elif t.individual < 0 %}text-down{% endif %}">{{ t.individual|intcomma }}</td>
                                <td class="text-end {% if t.foreign > 0 %}text-up{% elif t.foreign < 0 %}text-down{% endif %}">{{ t.foreign|intcomma }}</td>
                                <td class="text-end {% if t.institution > 0 %}text-up{% elif t.institution < 0 %}text-down{% endif %}">{{ t.institution|intcomma }}</td>
                                <td class="text-end {% if t.financial > 0 %}text-up{% elif t.financial < 0 %}text-down{% endif %}">{{ t.financial|intcomma }}</td>
                                <td class="text-end {% if t.insurance > 0 %}text-up{% elif t.insurance < 0 %}text-down{% endif %}">{{ t.insurance|intcomma }}</td>
                                <td class="text-end {% if t.investment_trust > 0 %}text-up{% elif t.investment_trust < 0 %}text-down{% endif %}">{{ t.investment_trust|intcomma }}</td>
                                <td class="text-end {% if t.bank > 0 %}text-up{% elif t.bank < 0 %}text-down{% endif %}">{{ t.bank|intcomma }}</td>
                                <td class="text-end {% if t.pension_fund > 0 %}text-up{% elif t.pension_fund < 0 %}text-down{% endif %}">{{ t.pension_fund|intcomma }}</td>
                                <td class="text-end {% if t.private_fund > 0 %}text-up{% elif t.private_fund < 0 %}text-down{% endif %}">{{ t.private_fund|intcomma }}</td>
                                <td class="text-end pe-3 {% if t.other_corporation > 0 %}text-up{% elif t.other_corporation < 0 %}text-down{% endif %}">{{ t.other_corporation|intcomma }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    수급 데이터가 없습니다.<br>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="btnFetchInvestorTrend" data-code="{{ stock.code }}">
                        데이터 가져오기 (6개월)
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 공매도 탭 -->
    <div class="tab-pane fade" id="shortsell-content" role="tabpanel">
        <div class="card">
            <div class="card-header py-2">
                <strong>공매도 현황</strong>
                <small class="text-muted ms-2">최근 60일</small>
            </div>
            <div class="card-body p-0">
                {% if short_sellings %}
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr class="small">
                                <th class="ps-3">일자</th>
                                <th class="text-end">거래량</th>
                                <th class="text-end">공매도량</th>
                                <th class="text-end">비중(%)</th>
                                <th class="text-end">공매도대금</th>
                                <th class="text-end pe-3">평균가</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in short_sellings %}
                            <tr class="small">
                                <td class="ps-3 text-muted">{{ s.date|date:"m.d" }}</td>
                                <td class="text-end">{{ s.trading_volume|intcomma }}</td>
                                <td class="text-end">{{ s.short_volume|intcomma }}</td>
                                <td class="text-end {% if s.trading_weight >= 10 %}text-danger fw-bold{% elif s.trading_weight >= 5 %}text-warning{% endif %}">{{ s.trading_weight }}%</td>
                                <td class="text-end">{{ s.short_trading_value|intcomma }}</td>
                                <td class="text-end pe-3">{{ s.short_average_price|intcomma }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    공매도 데이터가 없습니다.<br>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="btnFetchShortSelling" data-code="{{ stock.code }}">
                        데이터 가져오기 (60일)
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 공시 탭 -->
    <div class="tab-pane fade" id="disclosure-content" role="tabpanel">
        <div class="card">
            <div class="card-header py-2">
                <strong>DART 공시</strong>
                <small class="text-muted ms-2">전자공시시스템</small>
            </div>
            <div class="card-body">
                {% if gongsi_list %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3" style="width:100px;">접수일</th>
                                <th>보고서명</th>
                                <th style="width:100px;" class="d-none d-md-table-cell">제출인</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for gongsi in gongsi_list %}
                            <tr>
                                <td class="text-muted small ps-3">{{ gongsi.date|date:"Y-m-d"|default:"-" }}</td>
                                <td><a href="{{ gongsi.link }}" target="_blank" class="text-decoration-none">{{ gongsi.title }}</a></td>
                                <td class="small d-none d-md-table-cell">{{ gongsi.submitter }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-muted">공시가 없습니다. <code>python manage.py save_gongsi_stock --code {{ stock.code }}</code> 실행</div>
                {% endif %}

                <!-- 실시간 DART 조회 -->
                <div class="border-top mt-3 pt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">실시간 DART 조회 (저장 안됨)</small>
                        <button type="button" id="btnFetchDart" class="btn btn-sm btn-outline-primary">
                            불러오기
                        </button>
                    </div>
                    <div id="dartLoading" class="text-center py-3 d-none">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <span class="ms-2">불러오는 중... (5~10초 소요)</span>
                    </div>
                    <div id="dartResult" class="d-none"></div>
                </div>

                <!-- 텔레그램 공시 검색 -->
                <div class="border-top mt-3 pt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">텔레그램 공시 검색 (주식공시 채널, 최근 2주)</small>
                        <button type="button" id="btnSearchDisclosure" class="btn btn-sm btn-outline-warning">
                            검색
                        </button>
                    </div>
                    <div id="disclosureLoading" class="text-center py-3 d-none">
                        <div class="spinner-border spinner-border-sm text-warning" role="status"></div>
                        <span class="ms-2">검색 중...</span>
                    </div>
                    <div id="disclosureResult" class="d-none"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 리포트 탭 -->
    <div class="tab-pane fade" id="report-content" role="tabpanel">
        <!-- 주가 vs 목표가 차트 -->
        {% if reports %}
        <div class="card mb-3">
            <div class="card-header py-2">
                <strong>주가 vs 목표가</strong>
            </div>
            <div class="card-body">
                <canvas id="priceTargetChart" style="height: 250px;"></canvas>
            </div>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header py-2">
                <strong>애널리스트 리포트</strong>
                <small class="text-muted ms-2">{{ reports|length }}개{% if total_reports > 20 %} / {{ total_reports }}개{% endif %}</small>
            </div>
            <div class="card-body {% if reports %}p-0{% endif %}">
                {% if reports %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0" id="reportTable">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3" style="width: 80px;">일자</th>
                                <th>제목</th>
                                <th style="width: 100px;" class="d-none d-md-table-cell">애널리스트</th>
                                <th style="width: 90px;" class="d-none d-md-table-cell">증권사</th>
                                <th style="width: 90px;" class="text-end">목표가</th>
                                <th style="width: 70px;" class="text-end pe-3">괴리율</th>
                                <th style="width: 50px;" class="text-center"></th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                            {% for report in reports %}
                            <tr>
                                <td class="text-muted small ps-3">{{ report.date|date:"y/m/d" }}</td>
                                <td class="text-truncate" style="max-width: 250px;" title="{{ report.title }}">
                                    <a href="#" class="text-decoration-none report-search-link" data-title="{{ report.title }}">{{ report.title }}</a>
                                </td>
                                <td class="small d-none d-md-table-cell">{{ report.author }}</td>
                                <td class="small d-none d-md-table-cell">{{ report.provider }}</td>
                                <td class="text-end">
                                    {% if report.target_price %}
                                    <strong class="text-danger">{{ report.target_price|intcomma }}원</strong>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {% if report.gap_rate != None %}
                                    <span class="{% if report.gap_rate > 0 %}text-danger{% elif report.gap_rate < 0 %}text-primary{% endif %}">
                                        {% if report.gap_rate > 0 %}+{% endif %}{{ report.gap_rate }}%
                                    </span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm p-0 border-0 btn-toggle-report-summary" data-id="{{ report.id }}">
                                        {% if report.summary %}
                                        <span class="badge bg-success">O</span>
                                        {% else %}
                                        <span class="badge bg-secondary">-</span>
                                        {% endif %}
                                    </button>
                                </td>
                            </tr>
                            <tr class="report-summary-row d-none" data-id="{{ report.id }}">
                                <td colspan="7" class="bg-light p-3">
                                    <div class="report-summary-content mb-2" style="max-height: 300px; overflow-y: auto;">
                                        <div class="markdown-content" data-raw="{{ report.summary|escapejs }}">{% if not report.summary %}<span class="text-muted">요약 없음</span>{% endif %}</div>
                                    </div>
                                    <div class="border-top pt-2">
                                        <textarea class="form-control form-control-sm report-summary-textarea" rows="3" placeholder="마크다운 형식으로 입력...">{{ report.summary }}</textarea>
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <small class="text-muted">복사/붙여넣기 후 저장</small>
                                            <button type="button" class="btn btn-primary btn-sm btn-save-report-summary" data-id="{{ report.id }}">저장</button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if total_reports > 20 %}
                <div class="text-center py-3 border-top" id="reportLoadMore">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="btnLoadMoreReports" data-offset="20">
                        더보기 ({{ total_reports|add:"-20" }}개 더)
                    </button>
                </div>
                {% endif %}
                {% else %}
                <div class="text-muted p-3">리포트가 없습니다. <code>python manage.py save_fnguide_report --code {{ stock.code }}</code> 실행</div>
                {% endif %}
            </div>
        </div>

        <!-- 리포트 제목으로 텔레그램 검색 결과 -->
        <div id="reportSearchResult" class="card mt-3 d-none">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <div>
                    <strong>텔레그램 검색</strong>
                    <small class="text-muted ms-2" id="reportSearchKeyword"></small>
                </div>
                <button type="button" class="btn-close btn-sm" id="btnCloseReportSearch"></button>
            </div>
            <div class="card-body">
                <div id="reportSearchLoading" class="text-center py-3 d-none">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <span class="ms-2">검색 중...</span>
                </div>
                <div id="reportSearchTabs" class="d-none">
                    <ul class="nav nav-tabs" id="reportChannelTabs" role="tablist"></ul>
                    <div class="tab-content pt-3" id="reportChannelTabContent"></div>
                </div>
                <div id="reportSearchEmpty" class="text-muted d-none">검색 결과가 없습니다.</div>
            </div>
        </div>
    </div>

    <!-- 텔레그램 탭 -->
    <div class="tab-pane fade" id="telegram-content" role="tabpanel">
        <div class="card">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <div>
                    <strong>텔레그램 검색</strong>
                    <small class="text-muted ms-2">1주일 데이터, 최소 3개</small>
                </div>
                <button type="button" id="btnSearchTelegram" class="btn btn-sm btn-outline-primary">
                    검색
                </button>
            </div>
            <div class="card-body">
                <div id="telegramLoading" class="text-center py-3 d-none">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <span class="ms-2">검색 중...</span>
                </div>
                <div id="telegramTabs" class="d-none">
                    <ul class="nav nav-tabs" id="channelTabs" role="tablist"></ul>
                    <div class="tab-content pt-3" id="channelTabContent"></div>
                </div>
                <div id="telegramEmpty" class="text-muted">버튼을 클릭하면 "{{ stock.name }}" 검색 결과를 표시합니다.</div>
            </div>
        </div>
    </div>

    <!-- 뉴스 탭 -->
    <div class="tab-pane fade" id="news-content" role="tabpanel">
        <div class="card">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <div>
                    <strong>Google 뉴스</strong>
                    <small class="text-muted ms-2">"{{ stock.name }}" 검색</small>
                </div>
                <button type="button" id="btnSearchNews" class="btn btn-sm btn-outline-info">
                    검색
                </button>
            </div>
            <div class="card-body">
                <div id="newsLoading" class="text-center py-3 d-none">
                    <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                    <span class="ms-2">검색 중... (5~10초 소요)</span>
                </div>
                <div id="newsResult">
                    <div class="text-muted">버튼을 클릭하면 "{{ stock.name }}" 관련 최신 뉴스를 검색합니다.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 노다지 탭 -->
    <div class="tab-pane fade" id="nodaji-content" role="tabpanel">
        <div class="card">
            <div class="card-header py-2">
                <strong>노다지 IR노트</strong>
                <small class="text-muted ms-2">{{ nodaji_list|length }}개{% if total_nodaji > 20 %} / {{ total_nodaji }}개{% endif %}</small>
            </div>
            <div class="card-body {% if nodaji_list %}p-0{% endif %}">
                {% if nodaji_list %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0" id="nodajiTable">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3" style="width:100px;">날짜</th>
                                <th>제목</th>
                                <th style="width:50px;" class="text-center"></th>
                            </tr>
                        </thead>
                        <tbody id="nodajiTableBody">
                            {% for article in nodaji_list %}
                            <tr>
                                <td class="text-muted small ps-3">{{ article.date|date:"y/m/d"|default:"-" }}</td>
                                <td><a href="{{ article.link }}" target="_blank" class="text-decoration-none">{{ article.title }}</a></td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm p-0 border-0 btn-toggle-summary" data-id="{{ article.id }}">
                                        {% if article.summary %}
                                        <span class="badge bg-success">O</span>
                                        {% else %}
                                        <span class="badge bg-secondary">-</span>
                                        {% endif %}
                                    </button>
                                </td>
                            </tr>
                            <tr class="summary-row d-none" data-id="{{ article.id }}">
                                <td colspan="3" class="bg-light p-3">
                                    <div class="summary-content mb-2" style="max-height: 300px; overflow-y: auto;">
                                        <div class="html-content" data-raw="{{ article.summary|escapejs }}">{% if not article.summary %}<span class="text-muted">요약 없음</span>{% endif %}</div>
                                    </div>
                                    <div class="border-top pt-2">
                                        <textarea class="form-control form-control-sm summary-textarea" rows="3" placeholder="HTML 형식으로 입력...">{{ article.summary }}</textarea>
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <small class="text-muted">복사/붙여넣기 후 저장</small>
                                            <button type="button" class="btn btn-primary btn-sm btn-save-summary" data-id="{{ article.id }}">저장</button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if total_nodaji > 20 %}
                <div class="text-center py-3 border-top" id="nodajiLoadMore">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="btnLoadMoreNodaji" data-offset="20">
                        더보기 ({{ total_nodaji|add:"-20" }}개 더)
                    </button>
                </div>
                {% endif %}
                {% else %}
                <div class="text-muted">노다지 기사가 없습니다.</div>
                {% endif %}

                <!-- 실시간 검색 -->
                <div class="border-top mt-3 pt-3 px-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">실시간 검색 (저장 안됨)</small>
                        <button type="button" id="btnSearchNodaji" class="btn btn-sm btn-outline-success">
                            검색
                        </button>
                    </div>
                    <div id="nodajiLoading" class="text-center py-3 d-none">
                        <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                        <span class="ms-2">검색 중... (5~10초 소요)</span>
                    </div>
                    <div id="nodajiResult" class="d-none"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 유튜브 탭 -->
    <div class="tab-pane fade" id="youtube-content" role="tabpanel">
        <!-- 저장된 영상 -->
        <div class="card mb-3">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <strong>저장된 영상</strong>
                <span class="badge bg-primary" id="savedVideoCount">{{ youtube_videos|length }}</span>
            </div>
            <div class="card-body p-0">
                <div id="savedVideoList" class="list-group list-group-flush">
                    {% for video in youtube_videos %}
                    <div class="list-group-item d-flex gap-3 py-2" data-id="{{ video.id }}">
                        {% if video.thumbnail %}
                        <a href="{{ video.link }}" target="_blank">
                            <img src="{{ video.thumbnail }}" alt="" style="width:120px; height:68px; object-fit:cover; border-radius:4px;">
                        </a>
                        {% endif %}
                        <div class="flex-grow-1 overflow-hidden">
                            <a href="{{ video.link }}" target="_blank" class="fw-semibold text-truncate d-block text-decoration-none">{{ video.title }}</a>
                            <small class="text-muted">{{ video.channel }}</small>
                            <small class="text-muted ms-2">{{ video.views }}</small>
                            <small class="text-muted ms-2">{{ video.published }}</small>
                        </div>
                        <div class="d-flex gap-2 align-self-center">
                            <a href="{% url 'stocks:youtube_summary' video.id %}" class="text-decoration-none" title="요약">
                                {% if video.summary %}
                                <span class="badge bg-success">요약</span>
                                {% else %}
                                <span class="badge bg-secondary">요약</span>
                                {% endif %}
                            </a>
                            <button type="button" class="btn btn-sm btn-outline-danger btn-delete-video" data-id="{{ video.id }}">삭제</button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-3" id="noSavedVideo">저장된 영상이 없습니다.</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- 검색 -->
        <div class="card">
            <div class="card-header py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <strong>검색</strong>
                    <div class="d-flex gap-2">
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" id="btnYoutubeGeneral" class="btn btn-outline-secondary active">일반</button>
                            <button type="button" id="btnYoutubePreferred" class="btn btn-outline-secondary">선호</button>
                        </div>
                        <button type="button" id="btnSearchYoutube" class="btn btn-sm btn-danger">검색</button>
                    </div>
                </div>
                <div class="mt-1">
                    <small class="text-muted" id="youtubeSearchInfo">"{{ stock.name }} 주식" 검색 · 조회수 1,000회 이상 · 최신순</small>
                </div>
            </div>
            <div class="card-body">
                <div id="youtubeLoading" class="text-center py-3 d-none">
                    <div class="spinner-border spinner-border-sm text-danger" role="status"></div>
                    <span class="ms-2" id="youtubeLoadingText">검색 중...</span>
                </div>
                <div id="youtubeResult"></div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_css %}
<style>
.highlight {
    background-color: #fff3cd;
    padding: 0 2px;
    border-radius: 2px;
    font-weight: bold;
}
/* 텔레그램 채널 탭 스타일 - 반응형 그리드 */
#channelTabs,
#reportChannelTabs {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px;
    border-bottom: none;
    padding-bottom: 8px;
    margin-bottom: 8px;
    border-bottom: 1px solid #dee2e6;
}
@media (min-width: 768px) {
    #channelTabs,
    #reportChannelTabs {
        grid-template-columns: repeat(6, 1fr);
    }
}
#channelTabs .nav-item,
#reportChannelTabs .nav-item {
    margin: 0;
}
#channelTabs .nav-link,
#reportChannelTabs .nav-link {
    display: block;
    width: 100%;
    padding: 4px 6px;
    font-size: 0.7rem;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    background: #f8f9fa;
    color: #495057;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
#channelTabs .nav-link:hover,
#reportChannelTabs .nav-link:hover {
    background: #e9ecef;
}
#channelTabs .nav-link.active,
#reportChannelTabs .nav-link.active {
    background: #0d6efd;
    color: white;
    border-color: #0d6efd;
}
#channelTabs .nav-link .badge,
#reportChannelTabs .nav-link .badge {
    font-size: 0.6rem;
    padding: 1px 3px;
    margin-left: 2px;
}
#channelTabs .nav-link.has-recent,
#reportChannelTabs .nav-link.has-recent {
    border-color: #dc3545;
    background: #fff5f5;
}
#channelTabs .nav-link.has-recent.active,
#reportChannelTabs .nav-link.has-recent.active {
    background: #dc3545;
    border-color: #dc3545;
}
/* 노다지 요약 HTML 스타일 */
.summary-row .html-content {
    font-size: 0.75rem;
    line-height: 1.5;
}
.summary-row .html-content h1,
.summary-row .html-content h2,
.summary-row .html-content h3 {
    font-size: 0.85rem;
    margin-top: 0.5rem;
    margin-bottom: 0.25rem;
}
.summary-row .html-content p {
    margin-bottom: 0.5rem;
}
.summary-row .html-content ul,
.summary-row .html-content ol {
    padding-left: 1.2rem;
    margin-bottom: 0.5rem;
}
/* 리포트 요약 마크다운 스타일 */
.report-summary-row .markdown-content {
    font-size: 0.75rem;
    line-height: 1.5;
}
.report-summary-row .markdown-content h1,
.report-summary-row .markdown-content h2,
.report-summary-row .markdown-content h3 {
    font-size: 0.85rem;
    margin-top: 0.5rem;
    margin-bottom: 0.25rem;
}
.report-summary-row .markdown-content p {
    margin-bottom: 0.5rem;
}
.report-summary-row .markdown-content ul,
.report-summary-row .markdown-content ol {
    padding-left: 1.2rem;
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
const stockName = "{{ stock.name }}";
const stockCode = "{{ stock.code }}";

// ============ 수급 누적 차트 ============
const investorChartData = {{ investor_chart_data|safe }};

if (investorChartData && investorChartData.length > 0) {
    const ctx = document.getElementById('investorTrendChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: investorChartData.map(d => d.date),
                datasets: [
                    { label: '개인', data: investorChartData.map(d => d.individual), borderColor: '#ffc107', borderWidth: 2, tension: 0.3, pointRadius: 2, fill: false },
                    { label: '외국인', data: investorChartData.map(d => d.foreign), borderColor: '#198754', borderWidth: 2, tension: 0.3, pointRadius: 2, fill: false },
                    { label: '기관', data: investorChartData.map(d => d.institution), borderColor: '#dc3545', borderWidth: 2, tension: 0.3, pointRadius: 2, fill: false }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.raw.toLocaleString('ko-KR') }}
                },
                scales: {
                    x: { grid: { display: false }, ticks: { maxTicksLimit: 10 }},
                    y: { ticks: { callback: v => Math.abs(v) >= 100000000 ? (v/100000000).toFixed(1)+'억' : Math.abs(v) >= 10000 ? (v/10000).toFixed(1)+'만' : v.toFixed(0) }, grid: { color: '#f0f0f0' }}
                }
            }
        });
    }
}

// ============ 주가 vs 목표가 차트 ============
const priceChartData = {{ price_chart_data|safe }};
const targetChartData = {{ target_chart_data|safe }};
const gapChartData = {{ gap_chart_data|safe }};
let priceTargetChart = null;

function initPriceTargetChart() {
    if (priceTargetChart) return;
    if (priceChartData.length === 0) return;

    const ctx = document.getElementById('priceTargetChart');
    if (!ctx) return;

    // 날짜 라벨 추출
    const labels = priceChartData.map(d => d.x);
    const priceValues = priceChartData.map(d => d.y);

    // 목표가를 같은 x축에 매핑
    const targetMap = {};
    targetChartData.forEach(d => { targetMap[d.x] = d.y; });
    const targetValues = labels.map(date => targetMap[date] || null);

    // 괴리율을 같은 x축에 매핑
    const gapMap = {};
    gapChartData.forEach(d => { gapMap[d.x] = d.y; });
    const gapValues = labels.map(date => gapMap[date] !== undefined ? gapMap[date] : null);

    priceTargetChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '종가',
                    data: priceValues,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1,
                    fill: true,
                    yAxisID: 'y'
                },
                {
                    label: '목표가',
                    data: targetValues,
                    borderColor: '#dc3545',
                    backgroundColor: '#dc3545',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.1,
                    spanGaps: true,
                    yAxisID: 'y'
                },
                {
                    label: '괴리율',
                    data: gapValues,
                    borderColor: '#198754',
                    backgroundColor: '#198754',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.1,
                    spanGaps: true,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        boxWidth: 8
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (context.parsed.y === null) return null;
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.dataset.yAxisID === 'y1') {
                                label += context.parsed.y + '%';
                            } else {
                                label += new Intl.NumberFormat('ko-KR').format(context.parsed.y) + '원';
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    ticks: {
                        maxTicksLimit: 6,
                        callback: function(value, index) {
                            const label = this.getLabelForValue(value);
                            return label ? label.substring(2, 10) : '';
                        }
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    type: 'linear',
                    position: 'left',
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return new Intl.NumberFormat('ko-KR').format(value);
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: false,
                    grid: {
                        drawOnChartArea: false
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

// 리포트 탭 활성화 시 차트 생성
document.getElementById('report-tab').addEventListener('shown.bs.tab', function() {
    initPriceTargetChart();
});

// ============ 리포트 제목으로 텔레그램 검색 ============
const reportSearchResult = document.getElementById('reportSearchResult');
const reportSearchKeyword = document.getElementById('reportSearchKeyword');
const reportSearchLoading = document.getElementById('reportSearchLoading');
const reportSearchTabs = document.getElementById('reportSearchTabs');
const reportChannelTabs = document.getElementById('reportChannelTabs');
const reportChannelTabContent = document.getElementById('reportChannelTabContent');
const reportSearchEmpty = document.getElementById('reportSearchEmpty');
const btnCloseReportSearch = document.getElementById('btnCloseReportSearch');

// 닫기 버튼
btnCloseReportSearch.addEventListener('click', () => {
    reportSearchResult.classList.add('d-none');
});

// 리포트 제목 클릭 이벤트
document.querySelectorAll('.report-search-link').forEach(link => {
    link.addEventListener('click', async (e) => {
        e.preventDefault();
        const keyword = link.dataset.title;

        // UI 초기화
        reportSearchKeyword.textContent = `"${keyword}"`;
        reportSearchResult.classList.remove('d-none');
        reportSearchLoading.classList.remove('d-none');
        reportSearchTabs.classList.add('d-none');
        reportSearchEmpty.classList.add('d-none');
        reportChannelTabs.innerHTML = '';
        reportChannelTabContent.innerHTML = '';

        // 결과 영역으로 스크롤
        reportSearchResult.scrollIntoView({ behavior: 'smooth', block: 'start' });

        try {
            const response = await fetch(`/api/telegram/search/?keyword=${encodeURIComponent(keyword)}&limit=30&days=180`);
            const data = await response.json();

            if (data.error) {
                reportChannelTabContent.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                reportSearchTabs.classList.remove('d-none');
                return;
            }

            const channels = Object.keys(data.results);
            const channelNames = data.channel_names || {};
            let tabsHtml = '';
            let contentHtml = '';

            // 전체 문구가 포함된 메시지만 필터링한 결과로 탭 생성
            channels.forEach((channel) => {
                const channelData = data.results[channel];
                const filteredData = filterByKeyword(channelData, keyword);
                const totalCount = Object.values(filteredData).reduce((sum, arr) => sum + arr.length, 0);

                if (totalCount === 0) return;

                const channelId = 'rpt_' + channel.replace('@', '');
                const displayName = channelNames[channel] || channel;
                const isFirst = tabsHtml === '';

                tabsHtml += `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ${isFirst ? 'active' : ''}"
                                id="${channelId}-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#${channelId}-content"
                                type="button" role="tab">
                            ${displayName} <span class="badge bg-secondary">${totalCount}</span>
                        </button>
                    </li>`;

                contentHtml += `
                    <div class="tab-pane fade ${isFirst ? 'show active' : ''}"
                         id="${channelId}-content" role="tabpanel">
                        ${renderReportChannelContent(filteredData, keyword)}
                    </div>`;
            });

            if (tabsHtml) {
                reportChannelTabs.innerHTML = tabsHtml;
                reportChannelTabContent.innerHTML = contentHtml;
                reportSearchTabs.classList.remove('d-none');
            } else {
                reportSearchEmpty.classList.remove('d-none');
            }

        } catch (err) {
            reportChannelTabContent.innerHTML = `<div class="alert alert-danger">오류: ${err.message}</div>`;
            reportSearchTabs.classList.remove('d-none');
        } finally {
            reportSearchLoading.classList.add('d-none');
        }
    });
});

// 전체 문구로 필터링
function filterByKeyword(channelData, keyword) {
    const result = {};
    for (const date in channelData) {
        const filtered = channelData[date].filter(item => item.text.includes(keyword));
        if (filtered.length > 0) {
            result[date] = filtered;
        }
    }
    return result;
}

function renderReportChannelContent(channelData, keyword) {
    const dates = Object.keys(channelData).sort().reverse();
    if (dates.length === 0) {
        return '<div class="text-muted">검색 결과가 없습니다.</div>';
    }

    let html = '';
    for (const date of dates) {
        const items = channelData[date];
        html += `<div class="mb-3">`;
        html += `<h6 class="text-primary mb-2">${date} (${items.length}건)</h6>`;
        items.forEach((item, idx) => {
            let text = item.text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            text = linkify(text);
            text = highlightKeyword(text, keyword);
            html += `<div class="border-start border-2 border-success ps-2 py-2 small bg-light mb-0">`;
            html += `<span class="text-muted">[${item.time}]</span> `;
            html += `<span style="white-space: pre-wrap;">${text}</span>`;
            html += `</div>`;
            if (idx < items.length - 1) {
                html += `<hr class="my-2">`;
            }
        });
        html += `</div>`;
    }
    return html;
}

// ============ 노다지 실시간 검색 ============
const btnNodaji = document.getElementById('btnSearchNodaji');
const nodajiLoading = document.getElementById('nodajiLoading');
const nodajiResult = document.getElementById('nodajiResult');

btnNodaji.addEventListener('click', async () => {
    btnNodaji.disabled = true;
    nodajiLoading.classList.remove('d-none');
    nodajiResult.classList.add('d-none');

    try {
        const response = await fetch(`/api/nodaji/search/?keyword=${encodeURIComponent(stockName)}`);
        const data = await response.json();

        if (data.error) {
            nodajiResult.innerHTML = `<div class="alert alert-danger mb-0">${data.error}</div>`;
        } else if (data.results.length === 0) {
            nodajiResult.innerHTML = '<div class="text-muted">검색 결과가 없습니다.</div>';
        } else {
            // 날짜순 정렬 (최신순)
            const sortedResults = [...data.results].sort((a, b) => {
                const dateA = parseDateString(a.date);
                const dateB = parseDateString(b.date);
                return dateB - dateA;
            });

            let html = '<div class="table-responsive"><table class="table table-sm table-hover mb-0">';
            html += '<thead class="table-light"><tr><th class="ps-3" style="width:100px;">날짜</th><th>제목</th></tr></thead><tbody>';
            sortedResults.forEach(item => {
                html += `<tr>`;
                html += `<td class="text-muted small ps-3">${item.date}</td>`;
                html += `<td><a href="${item.link}" target="_blank" class="text-decoration-none">${item.title}</a></td>`;
                html += `</tr>`;
            });
            html += '</tbody></table></div>';
            nodajiResult.innerHTML = html;
        }
        nodajiResult.classList.remove('d-none');

    } catch (err) {
        nodajiResult.innerHTML = `<div class="alert alert-danger mb-0">오류: ${err.message}</div>`;
        nodajiResult.classList.remove('d-none');
    } finally {
        btnNodaji.disabled = false;
        nodajiLoading.classList.add('d-none');
    }
});

// ============ 노다지 요약 토글/저장 ============
// 유니코드 이스케이프 디코딩
function decodeUnicode(str) {
    return str.replace(/\\u([0-9a-fA-F]{4})/g, (m, p1) => String.fromCharCode(parseInt(p1, 16)));
}

// Gemini citation 제거 함수
function removeCitations(text) {
    return text
        .replace(/\[cite_start\]/g, '')
        .replace(/\[cite:\s*[\d,\s]+\]/g, '')
        .replace(/\[citexx\]/g, '')
        .replace(/\[cite_end\]/g, '');
}

// 노다지 요약 토글
function initNodajiSummaryToggle() {
    document.querySelectorAll('.btn-toggle-summary').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const row = document.querySelector(`.summary-row[data-id="${id}"]`);
            row.classList.toggle('d-none');

            // HTML 렌더링 (처음 열 때만)
            const htmlContent = row.querySelector('.html-content[data-raw]');
            if (htmlContent && !htmlContent.dataset.rendered) {
                let raw = htmlContent.dataset.raw;
                if (raw) {
                    raw = decodeUnicode(raw);
                    raw = removeCitations(raw);
                    htmlContent.innerHTML = raw;
                }
                htmlContent.dataset.rendered = 'true';
            }
        });
    });
}
initNodajiSummaryToggle();

// 노다지 요약 저장
function initNodajiSummarySave() {
    document.querySelectorAll('.btn-save-summary').forEach(btn => {
        btn.addEventListener('click', async function() {
            const id = this.dataset.id;
            const row = document.querySelector(`.summary-row[data-id="${id}"]`);
            const textarea = row.querySelector('.summary-textarea');
            const summary = textarea.value;

            this.disabled = true;
            this.textContent = '저장 중...';

            try {
                const response = await fetch(`/nodaji/${id}/summary/`, {
                    method: 'POST',
                    body: new URLSearchParams({ summary: summary }),
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                if (response.ok) {
                    // HTML 영역 업데이트
                    const htmlContent = row.querySelector('.html-content');
                    if (summary) {
                        const cleanSummary = removeCitations(summary);
                        htmlContent.innerHTML = cleanSummary;
                        htmlContent.dataset.raw = summary;
                    } else {
                        htmlContent.innerHTML = '<span class="text-muted">요약 없음</span>';
                    }

                    // 배지 업데이트
                    const badge = document.querySelector(`.btn-toggle-summary[data-id="${id}"] .badge`);
                    if (summary) {
                        badge.className = 'badge bg-success';
                        badge.textContent = 'O';
                    } else {
                        badge.className = 'badge bg-secondary';
                        badge.textContent = '-';
                    }

                    this.textContent = '저장됨';
                    setTimeout(() => { this.textContent = '저장'; }, 1500);
                } else {
                    alert('저장 실패');
                    this.textContent = '저장';
                }
            } catch (err) {
                alert('오류: ' + err.message);
                this.textContent = '저장';
            } finally {
                this.disabled = false;
            }
        });
    });
}
initNodajiSummarySave();

// 노다지 더보기
const btnLoadMoreNodaji = document.getElementById('btnLoadMoreNodaji');
if (btnLoadMoreNodaji) {
    btnLoadMoreNodaji.addEventListener('click', async function() {
        const offset = parseInt(this.dataset.offset);
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>불러오는 중...';

        try {
            const response = await fetch(`/api/nodaji/${stockCode}/more/?offset=${offset}`);
            const data = await response.json();

            if (data.success) {
                const tbody = document.getElementById('nodajiTableBody');

                data.nodaji.forEach(article => {
                    // 메인 행
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="text-muted small ps-3">${article.date}</td>
                        <td><a href="${article.link}" target="_blank" class="text-decoration-none">${article.title}</a></td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm p-0 border-0 btn-toggle-summary" data-id="${article.id}">
                                <span class="badge ${article.summary ? 'bg-success' : 'bg-secondary'}">${article.summary ? 'O' : '-'}</span>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);

                    // 요약 행
                    const summaryTr = document.createElement('tr');
                    summaryTr.className = 'summary-row d-none';
                    summaryTr.dataset.id = article.id;
                    summaryTr.innerHTML = `
                        <td colspan="3" class="bg-light p-3">
                            <div class="summary-content mb-2" style="max-height: 300px; overflow-y: auto;">
                                <div class="html-content" data-raw="${article.summary.replace(/"/g, '&quot;')}">${!article.summary ? '<span class="text-muted">요약 없음</span>' : ''}</div>
                            </div>
                            <div class="border-top pt-2">
                                <textarea class="form-control form-control-sm summary-textarea" rows="3" placeholder="HTML 형식으로 입력...">${article.summary}</textarea>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">복사/붙여넣기 후 저장</small>
                                    <button type="button" class="btn btn-primary btn-sm btn-save-summary" data-id="${article.id}">저장</button>
                                </div>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(summaryTr);
                });

                // 이벤트 다시 바인딩
                initNodajiSummaryToggle();
                initNodajiSummarySave();

                // 더보기 버튼 업데이트
                if (data.has_more) {
                    this.dataset.offset = offset + 20;
                    this.innerHTML = '더보기';
                } else {
                    document.getElementById('nodajiLoadMore').remove();
                }
            }
        } catch (err) {
            alert('오류: ' + err.message);
        } finally {
            this.disabled = false;
        }
    });
}

// ============ 리포트 요약 토글/저장/더보기 ============
// 리포트 요약 토글
function initReportSummaryToggle() {
    document.querySelectorAll('.btn-toggle-report-summary').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const row = document.querySelector(`.report-summary-row[data-id="${id}"]`);
            row.classList.toggle('d-none');

            // 마크다운 렌더링 (처음 열 때만)
            const mdContent = row.querySelector('.markdown-content[data-raw]');
            if (mdContent && !mdContent.dataset.rendered) {
                let raw = mdContent.dataset.raw;
                if (raw && typeof marked !== 'undefined') {
                    raw = decodeUnicode(raw);
                    raw = removeCitations(raw);
                    mdContent.innerHTML = marked.parse(raw);
                }
                mdContent.dataset.rendered = 'true';
            }
        });
    });
}
initReportSummaryToggle();

// 리포트 요약 저장
function initReportSummarySave() {
    document.querySelectorAll('.btn-save-report-summary').forEach(btn => {
        btn.addEventListener('click', async function() {
            const id = this.dataset.id;
            const row = document.querySelector(`.report-summary-row[data-id="${id}"]`);
            const textarea = row.querySelector('.report-summary-textarea');
            const summary = textarea.value;

            this.disabled = true;
            this.textContent = '저장 중...';

            try {
                const response = await fetch(`/report/${id}/summary/`, {
                    method: 'POST',
                    body: new URLSearchParams({ summary: summary }),
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                if (response.ok) {
                    // 마크다운 영역 업데이트
                    const mdContent = row.querySelector('.markdown-content');
                    if (summary) {
                        const cleanSummary = removeCitations(summary);
                        mdContent.innerHTML = typeof marked !== 'undefined' ? marked.parse(cleanSummary) : cleanSummary;
                        mdContent.dataset.raw = summary;
                    } else {
                        mdContent.innerHTML = '<span class="text-muted">요약 없음</span>';
                    }

                    // 배지 업데이트
                    const badge = document.querySelector(`.btn-toggle-report-summary[data-id="${id}"] .badge`);
                    if (summary) {
                        badge.className = 'badge bg-success';
                        badge.textContent = 'O';
                    } else {
                        badge.className = 'badge bg-secondary';
                        badge.textContent = '-';
                    }

                    this.textContent = '저장됨';
                    setTimeout(() => { this.textContent = '저장'; }, 1500);
                } else {
                    alert('저장 실패');
                    this.textContent = '저장';
                }
            } catch (err) {
                alert('오류: ' + err.message);
                this.textContent = '저장';
            } finally {
                this.disabled = false;
            }
        });
    });
}
initReportSummarySave();

// 리포트 더보기
const btnLoadMoreReports = document.getElementById('btnLoadMoreReports');
if (btnLoadMoreReports) {
    btnLoadMoreReports.addEventListener('click', async function() {
        const offset = parseInt(this.dataset.offset);
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>불러오는 중...';

        try {
            const response = await fetch(`/api/report/${stockCode}/more/?offset=${offset}`);
            const data = await response.json();

            if (data.success) {
                const tbody = document.getElementById('reportTableBody');

                data.reports.forEach(report => {
                    // 메인 행
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="text-muted small ps-3">${report.date}</td>
                        <td class="text-truncate" style="max-width: 250px;" title="${report.title}">
                            <a href="#" class="text-decoration-none report-search-link" data-title="${report.title}">${report.title}</a>
                        </td>
                        <td class="small d-none d-md-table-cell">${report.author}</td>
                        <td class="small d-none d-md-table-cell">${report.provider}</td>
                        <td class="text-end">
                            ${report.target_price ? `<strong class="text-danger">${report.target_price.toLocaleString('ko-KR')}원</strong>` : '<span class="text-muted">-</span>'}
                        </td>
                        <td class="text-end">
                            ${report.gap_rate !== null ? `<span class="${report.gap_rate > 0 ? 'text-danger' : (report.gap_rate < 0 ? 'text-primary' : '')}">${report.gap_rate > 0 ? '+' : ''}${report.gap_rate}%</span>` : '<span class="text-muted">-</span>'}
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm p-0 border-0 btn-toggle-report-summary" data-id="${report.id}">
                                <span class="badge ${report.summary ? 'bg-success' : 'bg-secondary'}">${report.summary ? 'O' : '-'}</span>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);

                    // 요약 행
                    const summaryTr = document.createElement('tr');
                    summaryTr.className = 'report-summary-row d-none';
                    summaryTr.dataset.id = report.id;
                    summaryTr.innerHTML = `
                        <td colspan="7" class="bg-light p-3">
                            <div class="report-summary-content mb-2" style="max-height: 300px; overflow-y: auto;">
                                <div class="markdown-content" data-raw="${report.summary.replace(/"/g, '&quot;')}">${!report.summary ? '<span class="text-muted">요약 없음</span>' : ''}</div>
                            </div>
                            <div class="border-top pt-2">
                                <textarea class="form-control form-control-sm report-summary-textarea" rows="3" placeholder="마크다운 형식으로 입력...">${report.summary}</textarea>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">복사/붙여넣기 후 저장</small>
                                    <button type="button" class="btn btn-primary btn-sm btn-save-report-summary" data-id="${report.id}">저장</button>
                                </div>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(summaryTr);
                });

                // 이벤트 다시 바인딩
                initReportSummaryToggle();
                initReportSummarySave();

                // 더보기 버튼 업데이트
                if (data.has_more) {
                    this.dataset.offset = offset + 20;
                    const remaining = data.has_more ? '더보기' : '';
                    this.innerHTML = remaining;
                } else {
                    document.getElementById('reportLoadMore').remove();
                }
            }
        } catch (err) {
            alert('오류: ' + err.message);
        } finally {
            this.disabled = false;
        }
    });
}

// ============ 유튜브 검색 ============
const btnYoutube = document.getElementById('btnSearchYoutube');
const youtubeLoading = document.getElementById('youtubeLoading');
const youtubeResult = document.getElementById('youtubeResult');
const btnYoutubeGeneral = document.getElementById('btnYoutubeGeneral');
const btnYoutubePreferred = document.getElementById('btnYoutubePreferred');
const youtubeSearchInfo = document.getElementById('youtubeSearchInfo');

let youtubeSearchMode = 'general'; // 'general' or 'preferred'

// 모드 전환 버튼
btnYoutubeGeneral.addEventListener('click', () => {
    youtubeSearchMode = 'general';
    btnYoutubeGeneral.classList.add('active');
    btnYoutubePreferred.classList.remove('active');
    youtubeSearchInfo.textContent = `"${stockName} 주식" 검색 · 조회수 1,000회 이상 · 최신순`;
});

btnYoutubePreferred.addEventListener('click', () => {
    youtubeSearchMode = 'preferred';
    btnYoutubePreferred.classList.add('active');
    btnYoutubeGeneral.classList.remove('active');
    youtubeSearchInfo.textContent = `선호 채널에서 "${stockName}" 검색 · 조회수 1,000회 이상 · 최신순`;
});

// 저장된 video_id 목록 (중복 체크용)
let savedVideoIds = new Set([
    {% for video in youtube_videos %}'{{ video.video_id }}',{% endfor %}
]);

// video_id 추출 함수
function extractVideoId(link) {
    const match = link.match(/[?&]v=([^&]+)/);
    return match ? match[1] : '';
}

// 검색 결과 렌더링 함수
function renderYoutubeResults(data) {
    if (data.error) {
        return `<div class="alert alert-danger mb-0">${data.error}</div>`;
    }

    if (data.message && data.results.length === 0) {
        return `<div class="alert alert-warning mb-0">${data.message}</div>`;
    }

    if (data.results.length === 0) {
        return '<div class="text-muted">검색 결과가 없습니다.</div>';
    }

    let html = '';

    // 선호 모드면 검색된 채널 목록 표시
    if (data.channels_searched && data.channels_searched.length > 0) {
        html += `<div class="small text-muted mb-2">검색 채널: ${data.channels_searched.join(', ')}</div>`;
    }

    html += '<div class="list-group list-group-flush">';
    data.results.forEach(video => {
        const videoId = extractVideoId(video.link);
        const isSaved = savedVideoIds.has(videoId);

        html += `<div class="list-group-item d-flex gap-3 py-2">`;
        if (video.thumbnail) {
            html += `<a href="${video.link}" target="_blank"><img src="${video.thumbnail}" alt="" style="width:120px; height:68px; object-fit:cover; border-radius:4px;"></a>`;
        }
        html += `<div class="flex-grow-1 overflow-hidden">`;
        html += `<a href="${video.link}" target="_blank" class="fw-semibold text-truncate d-block text-decoration-none">${video.title}</a>`;
        html += `<small class="text-muted">${video.channel}</small>`;
        html += `<small class="text-muted ms-2">${video.views || ''}</small>`;
        html += `<small class="text-muted ms-2">${video.published || ''}</small>`;
        html += `</div>`;

        if (isSaved) {
            html += `<span class="badge bg-success align-self-center" style="white-space:nowrap;">저장됨</span>`;
        } else {
            html += `<button type="button" class="btn btn-sm btn-outline-primary align-self-center btn-save-video" style="white-space:nowrap;"
                data-video-id="${videoId}"
                data-title="${video.title.replace(/"/g, '&quot;')}"
                data-channel="${video.channel.replace(/"/g, '&quot;')}"
                data-thumbnail="${video.thumbnail || ''}"
                data-duration="${video.duration || ''}"
                data-views="${video.views || ''}"
                data-published="${video.published || ''}">저장</button>`;
        }

        html += `</div>`;
    });
    html += '</div>';
    return html;
}

const youtubeLoadingText = document.getElementById('youtubeLoadingText');

btnYoutube.addEventListener('click', async () => {
    btnYoutube.disabled = true;
    youtubeLoading.classList.remove('d-none');
    youtubeResult.innerHTML = '';

    try {
        let url;
        if (youtubeSearchMode === 'preferred') {
            youtubeLoadingText.textContent = '선호 채널 검색 중... (채널 수에 따라 20~40초 소요)';
            url = `/api/youtube/search/preferred/?keyword=${encodeURIComponent(stockName)}&min_views=1000`;
        } else {
            youtubeLoadingText.textContent = '검색 중...';
            url = `/api/youtube/search/?keyword=${encodeURIComponent(stockName + ' 주식')}&min_views=1000`;
        }

        const response = await fetch(url);
        const data = await response.json();
        youtubeResult.innerHTML = renderYoutubeResults(data);

    } catch (err) {
        youtubeResult.innerHTML = `<div class="alert alert-danger mb-0">오류: ${err.message}</div>`;
    } finally {
        btnYoutube.disabled = false;
        youtubeLoading.classList.add('d-none');
    }
});

// ============ 유튜브 영상 저장/삭제 ============
const savedVideoList = document.getElementById('savedVideoList');
const savedVideoCount = document.getElementById('savedVideoCount');

function updateSavedVideoCount() {
    const count = savedVideoList.querySelectorAll('.list-group-item[data-id]').length;
    savedVideoCount.textContent = count;
}

// 저장 버튼 클릭 (이벤트 위임)
document.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('btn-save-video')) return;

    const btn = e.target;
    btn.disabled = true;
    btn.textContent = '저장 중...';

    const videoId = btn.dataset.videoId;
    const title = btn.dataset.title;
    const channel = btn.dataset.channel;
    const thumbnail = btn.dataset.thumbnail;
    const duration = btn.dataset.duration;
    const views = btn.dataset.views;
    const published = btn.dataset.published;

    try {
        const formData = new FormData();
        formData.append('stock_code', stockCode);
        formData.append('video_id', videoId);
        formData.append('title', title);
        formData.append('channel', channel);
        formData.append('thumbnail', thumbnail);
        formData.append('duration', duration);
        formData.append('views', views);
        formData.append('published', published);

        const response = await fetch('/api/youtube/video/save/', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
        });

        const data = await response.json();

        if (data.success) {
            // 저장된 영상 목록에 추가
            const noSavedVideo = document.getElementById('noSavedVideo');
            if (noSavedVideo) noSavedVideo.remove();

            const newItem = document.createElement('div');
            newItem.className = 'list-group-item d-flex gap-3 py-2';
            newItem.dataset.id = data.id;
            newItem.innerHTML = `
                ${thumbnail ? `<a href="https://www.youtube.com/watch?v=${videoId}" target="_blank"><img src="${thumbnail}" alt="" style="width:120px; height:68px; object-fit:cover; border-radius:4px;"></a>` : ''}
                <div class="flex-grow-1 overflow-hidden">
                    <a href="https://www.youtube.com/watch?v=${videoId}" target="_blank" class="fw-semibold text-truncate d-block text-decoration-none">${title}</a>
                    <small class="text-muted">${channel}</small>
                    <small class="text-muted ms-2">${views}</small>
                    <small class="text-muted ms-2">${published}</small>
                </div>
                <div class="d-flex gap-2 align-self-center">
                    <a href="/youtube/${data.id}/summary/" class="text-decoration-none" title="요약">
                        <span class="badge bg-secondary">요약</span>
                    </a>
                    <button type="button" class="btn btn-sm btn-outline-danger btn-delete-video" data-id="${data.id}">삭제</button>
                </div>
            `;
            savedVideoList.insertBefore(newItem, savedVideoList.firstChild);
            updateSavedVideoCount();

            // savedVideoIds에 추가
            savedVideoIds.add(videoId);

            // 버튼을 "저장됨" 뱃지로 교체
            const badge = document.createElement('span');
            badge.className = 'badge bg-success align-self-center';
            badge.textContent = '저장됨';
            btn.replaceWith(badge);
        } else {
            alert(data.error || '저장에 실패했습니다.');
            btn.disabled = false;
            btn.textContent = '저장';
        }
    } catch (err) {
        alert('오류: ' + err.message);
        btn.disabled = false;
        btn.textContent = '저장';
    }
});

// 삭제 버튼 클릭 (이벤트 위임)
document.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('btn-delete-video')) return;

    const btn = e.target;
    const videoId = btn.dataset.id;
    btn.disabled = true;

    try {
        const response = await fetch(`/api/youtube/video/${videoId}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
        });

        const data = await response.json();

        if (data.success) {
            const item = btn.closest('.list-group-item');
            // video_id 찾기 (삭제 시 savedVideoIds에서 제거)
            const link = item.querySelector('a[href*="youtube.com"]');
            if (link) {
                const vid = extractVideoId(link.href);
                savedVideoIds.delete(vid);
            }
            item.remove();
            updateSavedVideoCount();

            // 목록이 비었으면 메시지 표시
            if (savedVideoList.querySelectorAll('.list-group-item[data-id]').length === 0) {
                savedVideoList.innerHTML = '<div class="text-center text-muted py-3" id="noSavedVideo">저장된 영상이 없습니다.</div>';
            }
        } else {
            alert(data.error || '삭제에 실패했습니다.');
            btn.disabled = false;
        }
    } catch (err) {
        alert('오류: ' + err.message);
        btn.disabled = false;
    }
});

// ============ DART 공시 실시간 조회 ============
const btnDart = document.getElementById('btnFetchDart');
const dartLoading = document.getElementById('dartLoading');
const dartResult = document.getElementById('dartResult');

btnDart.addEventListener('click', async () => {
    btnDart.disabled = true;
    dartLoading.classList.remove('d-none');
    dartResult.classList.add('d-none');

    try {
        const response = await fetch(`/api/dart/${stockCode}/`);
        const data = await response.json();

        if (data.error) {
            dartResult.innerHTML = `<div class="alert alert-danger mb-0">${data.error}</div>`;
        } else if (data.results.length === 0) {
            dartResult.innerHTML = '<div class="text-muted">공시 정보가 없습니다.</div>';
        } else {
            let html = '<div class="table-responsive"><table class="table table-sm table-hover mb-0">';
            html += '<thead class="table-light"><tr><th class="ps-3" style="width:100px;">접수일</th><th>보고서명</th><th class="d-none d-md-table-cell" style="width:100px;">제출인</th></tr></thead><tbody>';
            data.results.forEach(item => {
                html += `<tr>`;
                html += `<td class="text-muted small ps-3">${item.date}</td>`;
                html += `<td><a href="${item.link}" target="_blank" class="text-decoration-none">${item.title}</a></td>`;
                html += `<td class="small d-none d-md-table-cell">${item.submitter || ''}</td>`;
                html += `</tr>`;
            });
            html += '</tbody></table></div>';
            dartResult.innerHTML = html;
        }
        dartResult.classList.remove('d-none');

    } catch (err) {
        dartResult.innerHTML = `<div class="alert alert-danger mb-0">오류: ${err.message}</div>`;
        dartResult.classList.remove('d-none');
    } finally {
        btnDart.disabled = false;
        dartLoading.classList.add('d-none');
    }
});

// ============ 업종 선택 ============
const themeSelect = document.getElementById('themeSelect');
const btnAddThemeToStock = document.getElementById('btnAddThemeToStock');
const selectedThemes = document.getElementById('selectedThemes');
const themeInputs = document.getElementById('themeInputs');

if (btnAddThemeToStock) {
    btnAddThemeToStock.addEventListener('click', () => {
        const select = themeSelect;
        const themeId = select.value;
        if (!themeId) return;

        // 이미 선택된 테마인지 확인
        if (themeInputs.querySelector(`input[value="${themeId}"]`)) {
            alert('이미 선택된 업종입니다.');
            return;
        }

        const option = select.options[select.selectedIndex];
        const categoryName = option.dataset.category;
        const themeName = option.dataset.name;

        // "선택된 업종이 없습니다" 메시지 제거
        const noMsg = document.getElementById('noThemeMsg');
        if (noMsg) noMsg.remove();

        // 뱃지 추가
        const badge = document.createElement('span');
        badge.className = 'badge bg-primary d-flex align-items-center selected-theme';
        badge.dataset.id = themeId;
        badge.innerHTML = `${categoryName} &gt; ${themeName}<button type="button" class="btn-close btn-close-white ms-1 btn-remove-theme" style="font-size: 0.5rem;"></button>`;
        selectedThemes.appendChild(badge);

        // hidden input 추가
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'themes';
        input.value = themeId;
        themeInputs.appendChild(input);

        // 선택 초기화
        select.value = '';
    });

    // 테마 삭제 (이벤트 위임)
    selectedThemes.addEventListener('click', (e) => {
        if (!e.target.classList.contains('btn-remove-theme')) return;

        const badge = e.target.closest('.selected-theme');
        const themeId = badge.dataset.id;

        // 뱃지 제거
        badge.remove();

        // hidden input 제거
        const input = themeInputs.querySelector(`input[value="${themeId}"]`);
        if (input) input.remove();

        // 남은 테마가 없으면 메시지 표시
        if (selectedThemes.querySelectorAll('.selected-theme').length === 0) {
            selectedThemes.innerHTML = '<span class="text-muted small" id="noThemeMsg">선택된 업종이 없습니다.</span>';
        }
    });
}

// 공통 함수
function linkify(text) {
    const urlRegex = /(https?:\/\/[^\s<]+)/g;
    return text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener">$1</a>');
}

function highlightKeyword(text, keyword) {
    if (!keyword) return text;
    const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
}

// 날짜 문자열 파싱 (정렬용)
function parseDateString(dateStr) {
    if (!dateStr) return new Date(0);

    // "2024.12.06" 형식
    if (dateStr.includes('.') && dateStr.length >= 10) {
        const match = dateStr.match(/(\d{4})\.(\d{1,2})\.(\d{1,2})/);
        if (match) {
            return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
        }
    }

    // "12월 6일" 형식
    const monthDayMatch = dateStr.match(/(\d+)월\s*(\d+)일/);
    if (monthDayMatch) {
        const year = new Date().getFullYear();
        return new Date(year, parseInt(monthDayMatch[1]) - 1, parseInt(monthDayMatch[2]));
    }

    return new Date(0);
}

// ============ 텔레그램 공시 검색 ============
const btnDisclosure = document.getElementById('btnSearchDisclosure');
const disclosureLoading = document.getElementById('disclosureLoading');
const disclosureResult = document.getElementById('disclosureResult');

function renderDisclosureContent(data) {
    const dates = Object.keys(data).sort().reverse();
    if (dates.length === 0) {
        return '<div class="text-muted">검색 결과가 없습니다.</div>';
    }

    let html = '';
    for (const date of dates) {
        const items = data[date];
        html += `<div class="mb-3">`;
        html += `<h6 class="text-warning mb-2">${date} (${items.length}건)</h6>`;
        items.forEach((item, idx) => {
            let text = item.text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            text = linkify(text);
            text = highlightKeyword(text, stockName);
            html += `<div class="border-start border-2 border-warning ps-2 py-2 small bg-light mb-0">`;
            html += `<span class="text-muted">[${item.time}]</span> `;
            html += `<span style="white-space: pre-wrap;">${text}</span>`;
            html += `</div>`;
            if (idx < items.length - 1) {
                html += `<hr class="my-2">`;
            }
        });
        html += `</div>`;
    }
    return html;
}

btnDisclosure.addEventListener('click', async () => {
    btnDisclosure.disabled = true;
    disclosureLoading.classList.remove('d-none');
    disclosureResult.classList.add('d-none');

    try {
        const response = await fetch(`/api/disclosure/search/?keyword=${encodeURIComponent(stockName)}&limit=50`);
        const data = await response.json();

        if (data.error) {
            disclosureResult.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else if (Object.keys(data.results).length === 0) {
            disclosureResult.innerHTML = '<div class="text-muted">검색 결과가 없습니다.</div>';
        } else {
            disclosureResult.innerHTML = renderDisclosureContent(data.results);
        }
        disclosureResult.classList.remove('d-none');

    } catch (err) {
        disclosureResult.innerHTML = `<div class="alert alert-danger">오류: ${err.message}</div>`;
        disclosureResult.classList.remove('d-none');
    } finally {
        btnDisclosure.disabled = false;
        disclosureLoading.classList.add('d-none');
    }
});

// ============ 텔레그램 검색 ============
const btnTelegram = document.getElementById('btnSearchTelegram');
const telegramLoading = document.getElementById('telegramLoading');
const telegramTabs = document.getElementById('telegramTabs');
const channelTabs = document.getElementById('channelTabs');
const channelTabContent = document.getElementById('channelTabContent');
const telegramEmpty = document.getElementById('telegramEmpty');

function renderChannelContent(channelData) {
    const dates = Object.keys(channelData).sort().reverse();
    if (dates.length === 0) {
        return '<div class="text-muted">검색 결과가 없습니다.</div>';
    }

    let html = '';
    for (const date of dates) {
        const items = channelData[date];
        html += `<div class="mb-3">`;
        html += `<h6 class="text-primary mb-2">${date} (${items.length}건)</h6>`;
        items.forEach((item, idx) => {
            let text = item.text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            text = linkify(text);
            text = highlightKeyword(text, stockName);
            html += `<div class="border-start border-2 border-primary ps-2 py-2 small bg-light mb-0">`;
            html += `<span class="text-muted">[${item.time}]</span> `;
            html += `<span style="white-space: pre-wrap;">${text}</span>`;
            html += `</div>`;
            if (idx < items.length - 1) {
                html += `<hr class="my-2">`;
            }
        });
        html += `</div>`;
    }
    return html;
}

function countMessages(channelData) {
    let total = 0;
    let recent = 0;
    const today = new Date();
    const threeDaysAgo = new Date(today.getTime() - 3 * 24 * 60 * 60 * 1000);
    const threeDaysAgoStr = threeDaysAgo.toISOString().split('T')[0];

    for (const date in channelData) {
        const count = channelData[date].length;
        total += count;
        if (date >= threeDaysAgoStr) {
            recent += count;
        }
    }
    return { total, recent };
}

btnTelegram.addEventListener('click', async () => {
    btnTelegram.disabled = true;
    telegramLoading.classList.remove('d-none');
    telegramTabs.classList.add('d-none');
    channelTabs.innerHTML = '';
    channelTabContent.innerHTML = '';
    telegramEmpty.classList.add('d-none');

    try {
        const response = await fetch(`/api/telegram/search/?keyword=${encodeURIComponent(stockName)}&limit=30`);
        const data = await response.json();

        if (data.error) {
            channelTabContent.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            telegramTabs.classList.remove('d-none');
            return;
        }

        const channels = Object.keys(data.results);
        const channelNames = data.channel_names || {};
        let tabsHtml = '';
        let contentHtml = '';

        channels.forEach((channel, idx) => {
            const channelId = channel.replace('@', '');
            const displayName = channelNames[channel] || channel;
            const isActive = idx === 0;
            const { total, recent } = countMessages(data.results[channel]);

            const recentBadge = recent > 0 ? `<span class="badge bg-danger">${recent}</span>` : '';
            const totalBadge = total > 0 ? `<span class="badge bg-secondary">${total}</span>` : '';

            tabsHtml += `
                <li class="nav-item" role="presentation">
                    <button class="nav-link ${isActive ? 'active' : ''} ${recent > 0 ? 'has-recent' : ''}"
                            id="${channelId}-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#${channelId}-content"
                            type="button" role="tab">
                        ${displayName} ${recentBadge}${totalBadge}
                    </button>
                </li>`;

            contentHtml += `
                <div class="tab-pane fade ${isActive ? 'show active' : ''}"
                     id="${channelId}-content" role="tabpanel">
                    ${renderChannelContent(data.results[channel])}
                </div>`;
        });

        channelTabs.innerHTML = tabsHtml;
        channelTabContent.innerHTML = contentHtml;
        telegramTabs.classList.remove('d-none');

    } catch (err) {
        channelTabContent.innerHTML = `<div class="alert alert-danger">오류: ${err.message}</div>`;
        telegramTabs.classList.remove('d-none');
    } finally {
        btnTelegram.disabled = false;
        telegramLoading.classList.add('d-none');
    }
});

// ============ Google 뉴스 검색 ============
const btnNews = document.getElementById('btnSearchNews');
const newsLoading = document.getElementById('newsLoading');
const newsResult = document.getElementById('newsResult');

btnNews.addEventListener('click', async () => {
    btnNews.disabled = true;
    newsLoading.classList.remove('d-none');
    newsResult.innerHTML = '';

    try {
        const response = await fetch(`/api/news/search/?keyword=${encodeURIComponent(stockName)}`);
        const data = await response.json();

        if (data.error) {
            newsResult.innerHTML = `<div class="alert alert-danger mb-0">${data.error}</div>`;
        } else if (data.results.length === 0) {
            newsResult.innerHTML = '<div class="text-muted">검색 결과가 없습니다.</div>';
        } else {
            let html = '<div class="table-responsive"><table class="table table-sm table-hover mb-0">';
            html += '<thead class="table-light"><tr><th class="ps-3" style="width:130px;">날짜</th><th>제목</th><th style="width:150px;" class="d-none d-md-table-cell">출처</th></tr></thead><tbody>';
            data.results.forEach(item => {
                html += `<tr>`;
                html += `<td class="text-muted ps-3" style="font-size:0.75rem;">${item.date || '-'}</td>`;
                html += `<td><a href="${item.link}" target="_blank" class="text-decoration-none">${item.title}</a></td>`;
                html += `<td class="text-muted d-none d-md-table-cell" style="font-size:0.75rem;">${item.source || ''}</td>`;
                html += `</tr>`;
            });
            html += '</tbody></table></div>';
            newsResult.innerHTML = html;
        }

    } catch (err) {
        newsResult.innerHTML = `<div class="alert alert-danger mb-0">오류: ${err.message}</div>`;
    } finally {
        btnNews.disabled = false;
        newsLoading.classList.add('d-none');
    }
});

// 수급 데이터 가져오기
const btnFetchInvestorTrend = document.getElementById('btnFetchInvestorTrend');
if (btnFetchInvestorTrend) {
    btnFetchInvestorTrend.addEventListener('click', async function() {
        const code = this.dataset.code;
        this.disabled = true;
        this.textContent = '가져오는 중...';

        try {
            const response = await fetch(`/api/stock/${code}/investor-trend/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            });
            const data = await response.json();

            if (data.success) {
                location.reload();
            } else {
                alert(data.error || '데이터 가져오기 실패');
                this.disabled = false;
                this.textContent = '데이터 가져오기 (6개월)';
            }
        } catch (err) {
            alert('오류: ' + err.message);
            this.disabled = false;
            this.textContent = '데이터 가져오기 (6개월)';
        }
    });
}

// 공매도 데이터 가져오기
const btnFetchShortSelling = document.getElementById('btnFetchShortSelling');
if (btnFetchShortSelling) {
    btnFetchShortSelling.addEventListener('click', async function() {
        const code = this.dataset.code;
        this.disabled = true;
        this.textContent = '가져오는 중...';

        try {
            const response = await fetch(`/api/stock/${code}/short-selling/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            });
            const data = await response.json();

            if (data.success) {
                location.reload();
            } else {
                alert(data.error || '데이터 가져오기 실패');
                this.disabled = false;
                this.textContent = '데이터 가져오기 (60일)';
            }
        } catch (err) {
            alert('오류: ' + err.message);
            this.disabled = false;
            this.textContent = '데이터 가져오기 (60일)';
        }
    });
}

// ============ URL 해시로 탭 활성화 ============
if (window.location.hash) {
    const hash = window.location.hash;
    const tabMap = {
        '#report-content': 'report-tab',
        '#nodaji-content': 'nodaji-tab',
        '#info-content': 'info-tab',
        '#insight-content': 'insight-tab',
        '#analysis-content': 'analysis-tab',
        '#dart-content': 'dart-tab',
        '#telegram-content': 'telegram-tab',
        '#news-content': 'news-tab',
        '#youtube-content': 'youtube-tab'
    };
    const tabId = tabMap[hash];
    if (tabId) {
        const tab = document.getElementById(tabId);
        if (tab) {
            new bootstrap.Tab(tab).show();
        }
    }
}
</script>
{% endblock %}
